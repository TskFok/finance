<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记账系统 - 后台管理</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* 默认深色主题 (Titanium 风格) */
        :root {
            --primary: #e5e7eb;
            --primary-dark: #d1d5db;
            --primary-light: #f9fafb;
            --secondary: #6b7280;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
            --bg-main: #0a0a0a;
            --bg-card: #111;
            --bg-card-gradient: linear-gradient(to bottom, #1a1a1a, #111);
            --bg-input: #111;
            --bg-sidebar: #0f0f0f;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #222;
            --border-hover: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
            --gradient-primary: linear-gradient(135deg, #374151, #1f2937);
            --gradient-success: linear-gradient(135deg, #1a2e1a, #2a4a2a);
            --gradient-warning: linear-gradient(135deg, #2e251a, #4a3a2a);
            --gradient-danger: linear-gradient(135deg, #2e1a1a, #4a2a2a);
            --glow-primary: 0 0 15px rgba(229, 231, 235, 0.2);
        }
        .font-tech { font-family: 'Rajdhani', 'Noto Sans SC', sans-serif; }
        .font-display { font-family: 'Space Grotesk', 'Noto Sans SC', sans-serif; }
        
        /* 浅色主题 */
        [data-theme="light"] {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 40px rgba(0,0,0,0.08);
            --gradient-primary: linear-gradient(135deg, #2563eb, #1d4ed8);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --glow-primary: 0 0 20px rgba(37, 99, 235, 0.2);
        }
        
        /* 紫色主题 */
        [data-theme="purple"] {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #1a0b2e;
            --bg-card: #2d1b3d;
            --bg-input: #3d2a4d;
            --text-primary: #f1f5f9;
            --text-secondary: #a78bfa;
            --border: #4c1d95;
            --shadow: 0 10px 40px rgba(139, 92, 246, 0.3);
            --gradient-primary: linear-gradient(135deg, #8b5cf6, #7c3aed);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        
        /* 绿色主题 */
        [data-theme="green"] {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #34d399;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #0a1f1a;
            --bg-card: #1a2e28;
            --bg-input: #2a3f38;
            --text-primary: #f1f5f9;
            --text-secondary: #6ee7b7;
            --border: #065f46;
            --shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
            --gradient-primary: linear-gradient(135deg, #10b981, #059669);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --glow-primary: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        /* 橙色主题 */
        [data-theme="orange"] {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --primary-light: #fbbf24;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #1f1a0f;
            --bg-card: #2e2518;
            --bg-input: #3d3221;
            --text-primary: #fef3c7;
            --text-secondary: #fbbf24;
            --border: #92400e;
            --shadow: 0 10px 40px rgba(245, 158, 11, 0.3);
            --gradient-primary: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --glow-primary: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        .fa, .fas, .far, .fal, .fab { font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --top-toolbar-safe-top: 64px; --top-toolbar-safe-right: 320px; }
        body { font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-main); color: var(--text-primary); min-height: 100vh; line-height: 1.6; transition: background-color 0.3s ease, color 0.3s ease; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 24px 24px; opacity: 0.03; pointer-events: none; z-index: 0; }
        .app-container, .main-content { position: relative; z-index: 1; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-main); position: relative; overflow: hidden; transition: background 0.3s ease; }
        .login-container::before { content: ''; position: absolute; inset: 0; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 24px 24px; opacity: 0.04; pointer-events: none; }
        .login-box { background: linear-gradient(to bottom, #1a1a1a, #111); padding: 48px; border-radius: 8px; box-shadow: var(--shadow); width: 100%; max-width: 420px; position: relative; z-index: 1; border: 1px solid var(--border); }
        .login-box h1 { text-align: center; margin-bottom: 8px; font-size: 28px; font-weight: 600; font-family: 'Space Grotesk', sans-serif; color: var(--text-primary); letter-spacing: 0.05em; }
        .login-box p { text-align: center; color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
        .login-alert { display: none; margin: 12px 0 0; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.35); background: rgba(239, 68, 68, 0.12); color: #fecaca; font-size: 13px; line-height: 1.4; }
        .login-alert.show { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--bg-input); color: var(--text-primary); transition: all 0.2s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .form-group input:focus { outline: none; border-color: #555; background: #161616; }
        .btn { padding: 12px 20px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-weight: 600; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.1em; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #e5e7eb; color: #0a0a0a; width: auto; border-color: #555; }
        .login-box .btn-primary { width: 100%; }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .btn-success { background: #4ade80; color: #0a0a0a; border-color: #2a4a2a; }
        .btn-success:hover { background: #22c55e; box-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #161616; border-color: var(--border-hover); }
        .btn-warning { background: #fbbf24; color: #0a0a0a; border-color: #4a3a2a; }
        .btn-warning:hover { box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .btn-danger { background: #f87171; color: #0a0a0a; border-color: #4a2a2a; }
        .btn-danger:hover { background: #ef4444; box-shadow: 0 0 15px rgba(248, 113, 113, 0.3); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; position: relative; overflow: hidden; }
        .btn-info::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn-info:hover::before { left: 100%; }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.35); }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .link-btn { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 14px; text-decoration: underline; margin-top: 16px; display: block; text-align: center; transition: color 0.2s; }
        .link-btn:hover { color: #e5e7eb; }
        .app-container { display: none; min-height: 100vh; background: var(--bg-main); }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 0; display: flex; flex-direction: column; overflow: hidden; z-index: 20; }
        .logo { display: flex; align-items: center; gap: 12px; padding: 20px 24px; border-bottom: 1px solid var(--border); height: 80px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(to bottom right, #374151, #000); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.2); border: 1px solid #333; }
        .logo-text { font-size: 20px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; letter-spacing: 0.15em; color: var(--text-primary); text-transform: uppercase; }
        .nav-menu { flex: 1; overflow-y: auto; padding: 24px 12px; }
        .nav-menu.custom-scroll::-webkit-scrollbar { width: 4px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; color: var(--text-muted); margin-bottom: 4px; border: 1px solid transparent; position: relative; overflow: hidden; }
        .nav-item:hover { background: #161616; color: var(--text-secondary); border-color: var(--border); }
        .nav-item.active { background: #1a1a1a; color: var(--text-primary); border: 1px solid #333; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); position: relative; }
        .nav-item .fa, .nav-item svg { width: 24px; text-align: center; flex-shrink: 0; }
        .nav-item span.nav-text { font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.05em; }
        .top-toolbar { position: fixed; top: 18px; right: 18px; z-index: 900; display: flex; align-items: center; gap: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 8px 12px; box-shadow: var(--shadow-card); }
        .user-info-compact { display: flex; align-items: center; gap: 10px; padding-right: 10px; border-right: 1px solid var(--border); }
        .user-avatar-compact { width: 36px; height: 36px; background: linear-gradient(to bottom right, #374151, #1f2937); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: #e5e7eb; flex-shrink: 0; border: 1px solid #333; }
        .user-details-compact { display: flex; flex-direction: column; gap: 2px; }
        .user-name-compact { font-weight: 600; font-size: 13px; color: var(--text-primary); line-height: 1.2; }
        .user-role-compact { font-size: 11px; color: var(--text-secondary); line-height: 1.2; }
        .top-toolbar-btn { width: 36px; height: 36px; border-radius: 10px; background: transparent; border: none; color: var(--text-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .top-toolbar-btn:hover { background: #161616; color: #e5e7eb; transform: translateY(-1px); }
        .top-toolbar-btn svg { width: 18px; height: 18px; }
        
        /* 主题切换（右上角按钮 + 弹框） */
        .theme-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .theme-option { position: relative; padding: 12px; border: 2px solid var(--border); border-radius: 4px; cursor: pointer; transition: all 0.3s ease; background: var(--bg-input); }
        .theme-option:hover { border-color: #555; transform: translateY(-2px); box-shadow: var(--shadow-card); }
        .theme-option.active { border-color: #e5e7eb; background: #1a1a1a; box-shadow: 0 0 15px rgba(229, 231, 235, 0.15); }
        .theme-option.active .theme-name { color: var(--text-primary); font-weight: 700; }
        .theme-preview { display: flex; gap: 6px; margin-bottom: 8px; }
        .theme-color { width: 22px; height: 22px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); }
        .theme-name { font-size: 12px; color: var(--text-secondary); text-align: center; font-weight: 600; letter-spacing: 0.3px; user-select: none; }
        .theme-modal-content { max-width: 520px; }
        .theme-modal-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
        .theme-modal-sub { color: var(--text-secondary); font-size: 13px; margin-top: 6px; }
        
        /* 飞书二维码容器：防止 SDK 生成的 iframe 溢出，确保完整显示可扫码 */
        #feishuQRContainer > *, #feishuBindQRContainer > * { max-width: 100%; max-height: 100%; object-fit: contain; }
        #feishuQRContainer iframe, #feishuBindQRContainer iframe { width: 100% !important; height: 100% !important; max-width: 100%; max-height: 100%; }
        
        /* 加载动画 */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; font-family: monospace; text-transform: uppercase; letter-spacing: 0.05em; border: 1px solid; }
        .badge-primary { background: #1a1a1a; color: var(--text-secondary); border-color: #333; }
        .badge-success { background: #1a2e1a; color: #4ade80; border-color: #2a4a2a; }
        .badge-warning { background: #2e251a; color: #fbbf24; border-color: #4a3a2a; }
        .badge-danger { background: #2e1a1a; color: #f87171; border-color: #4a2a2a; }
        
        .enhanced-card { background: var(--bg-card-gradient); border-radius: 4px; padding: 24px; border: 1px solid var(--border); position: relative; overflow: hidden; box-shadow: var(--shadow-card); }
        
        .form-group input:focus, .filter-item input:focus, .filter-item select:focus { box-shadow: none; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--warning), var(--danger)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-details { flex: 1; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 12px; color: var(--text-secondary); }
        .logout-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s ease; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .main-content { margin-left: 260px; padding: calc(32px + var(--top-toolbar-safe-top)) 32px 32px 32px; min-height: 100vh; overflow: visible; position: relative; }
        .main-content::before { content: ''; position: absolute; inset: 0; background-image: radial-gradient(#444 1px, transparent 1px); background-size: 24px 24px; opacity: 0.03; pointer-events: none; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; position: relative; padding-bottom: 16px; padding-right: var(--top-toolbar-safe-right); border-bottom: 1px solid var(--border); }
        .page-title { font-size: 24px; font-weight: 400; font-family: 'Space Grotesk', sans-serif; color: var(--text-primary); letter-spacing: 0.02em; }
        .page-subtitle { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card-gradient); border-radius: 4px; padding: 24px; border: 1px solid var(--border); transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px; background: linear-gradient(to right, transparent, #555, transparent); opacity: 0.2; transition: opacity 0.3s; }
        .stat-card:hover { border-color: #555; }
        .stat-card:hover::before { opacity: 0.5; }
        .stat-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 18px; color: var(--text-muted); transition: color 0.2s; }
        .stat-card:hover .stat-icon { color: var(--text-secondary); }
        .stat-icon.blue { color: var(--text-muted); }
        .stat-icon.green { color: var(--text-muted); }
        .stat-icon.orange { color: var(--text-muted); }
        .stat-icon.red { color: var(--text-muted); }
        .stat-value { font-size: 28px; font-weight: 500; font-family: 'Space Grotesk', sans-serif; margin-bottom: 4px; color: var(--text-primary); }
        .stat-label { color: var(--text-muted); font-size: 12px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; }
        .filter-bar { background: var(--bg-card); border-radius: 4px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border); position: relative; overflow: hidden; box-shadow: var(--shadow-card); }
        /* 筛选栏：桌面端保持同一行（超出时横向滚动），避免“查询/添加”被挤到下一行 */
        .filter-row { display: flex; gap: 16px; flex-wrap: nowrap; align-items: flex-end; overflow-x: auto; overflow-y: hidden; padding-bottom: 4px; }
        .filter-row::-webkit-scrollbar { height: 6px; }
        .filter-row::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }
        .filter-row::-webkit-scrollbar-track { background: transparent; }
        .filter-item { flex: 1; min-width: 180px; }
        .filter-item label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .filter-item input, .filter-item select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--bg-input); color: var(--text-primary); transition: all 0.2s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .filter-item input:focus, .filter-item select:focus { outline: none; border-color: var(--primary); }
        .filter-actions { display: flex; gap: 12px; flex: 0 0 auto; white-space: nowrap; }
        .filter-actions .btn { white-space: nowrap; }
        /* 筛选栏按钮：去掉全局 btn-primary 的 width:100% 影响，并缩小“查询”按钮 */
        .filter-actions .btn { width: auto; padding: 10px 14px; font-size: 14px; border-radius: 10px; }
        .filter-actions .btn.btn-primary { padding: 10px 12px; }
        .data-table-container { background: var(--bg-card); border-radius: 4px; border: 1px solid var(--border); position: relative; overflow: visible; box-shadow: var(--shadow-card); }
        .data-table-container .data-table { overflow: visible; }
        /* 确保表格单元格可以显示下拉菜单 */
        .data-table td { overflow: visible; position: relative; }
        /* 确保操作列的下拉菜单不被裁剪 */
        .data-table td:last-child { overflow: visible; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #161616; padding: 12px 24px; text-align: left; font-weight: 500; font-size: 10px; font-family: 'Rajdhani', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 16px 24px; border-bottom: 1px solid #1a1a1a; font-size: 14px; font-family: ui-monospace, monospace; color: var(--text-secondary); transition: all 0.2s ease; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr { transition: background-color 0.2s ease; position: relative; transform: none !important; }
        .data-table tr:hover td { background: #1a1a1a; }
        /* 移除 transform 以避免创建新的层叠上下文，这会导致下拉菜单被遮挡 */
        /* 确保操作列的下拉菜单容器有正确的 z-index */
        .data-table td:last-child { position: relative; z-index: 1; }
        .data-table td:last-child .dropdown { z-index: 100; }
        /* 确保下拉菜单在表格行上方显示 */
        .data-table tr .dropdown-menu { z-index: 10000 !important; }
        /* 确保表格单元格不会创建新的层叠上下文 */
        .data-table td { transform: none !important; }
        .category-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .category-tag.餐饮 { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .category-tag.交通 { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .category-tag.购物 { background: rgba(168, 85, 247, 0.15); color: #a78bfa; }
        .category-tag.娱乐 { background: rgba(236, 72, 153, 0.15); color: #f472b6; }
        .category-tag.医疗 { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .category-tag.教育 { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .category-tag.住房 { background: rgba(20, 184, 166, 0.15); color: #2dd4bf; }
        .category-tag.其他 { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }
        .amount { font-weight: 600; color: #f87171; font-family: monospace; }
        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-top: 1px solid var(--border); }
        .pagination-info { color: var(--text-secondary); font-size: 14px; }
        .pagination-buttons { display: flex; gap: 8px; }
        .page-btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; font-size: 13px; font-family: monospace; }
        .page-btn:hover:not(:disabled) { background: #161616; border-color: #555; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: #222; border-color: #333; color: var(--text-primary); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .toast { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); padding: 14px 24px; border-radius: 4px; color: #0a0a0a; font-weight: 600; font-family: 'Rajdhani', sans-serif; z-index: 9999; animation: toastSlideIn 0.3s ease; box-shadow: var(--shadow); overflow: hidden; border: 1px solid; }
        .toast.success { background: #4ade80; border-color: #2a4a2a; }
        .toast.error { background: #f87171; border-color: #4a2a2a; }
        .toast.warning { background: #fbbf24; border-color: #4a3a2a; }
        @keyframes toastSlideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: linear-gradient(to bottom, #1a1a1a, #111); border-radius: 4px; padding: 32px; max-width: 450px; width: 90%; border: 1px solid var(--border); position: relative; overflow: hidden; animation: modalSlideIn 0.3s ease; box-shadow: var(--shadow); }
        @keyframes modalSlideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-title { font-size: 18px; font-weight: 600; font-family: 'Space Grotesk', sans-serif; margin-bottom: 8px; letter-spacing: 0.02em; }
        .modal-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .modal-actions .btn { flex: 1; }
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        /* AI模型表操作列不换行 */
        #page-ai-models .action-btns { flex-wrap: nowrap; white-space: nowrap; }
        /* 调用地址超长省略，悬停显示完整地址 */
        .url-ellipsis { display: block; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: default; }
        .action-btns .btn { width: auto; padding: 8px 12px; font-size: 13px; border-radius: 10px; white-space: nowrap; }
        /* 图标按钮样式 */
        .icon-btn { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.2s ease; position: relative; border: 1px solid var(--border); background: var(--bg-input); }
        .icon-btn:hover { background: var(--bg-card); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .icon-btn.info { color: #3b82f6; border-color: rgba(59, 130, 246, 0.3); }
        .icon-btn.info:hover { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
        .icon-btn.danger { color: #f87171; border-color: rgba(248, 113, 113, 0.3); }
        .icon-btn.danger:hover { background: rgba(248, 113, 113, 0.1); border-color: #f87171; }
        .icon-btn.secondary { color: var(--text-secondary); border-color: var(--border); }
        .icon-btn.secondary:hover { background: var(--bg-input); color: var(--text-primary); border-color: var(--text-secondary); }
        .icon-btn.warning { color: var(--warning); border-color: rgba(251, 191, 36, 0.4); }
        .icon-btn.warning:hover { background: rgba(251, 191, 36, 0.1); border-color: var(--warning); }
        /* Tooltip 样式 */
        .icon-btn[data-tooltip] { position: relative; }
        .icon-btn[data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; padding: 6px 12px; background: var(--bg-card); color: var(--text-primary); font-size: 12px; white-space: nowrap; border-radius: 6px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; pointer-events: none; }
        .icon-btn[data-tooltip]:hover::before { content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(2px); margin-bottom: 2px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--border); z-index: 10001; pointer-events: none; }
        .email-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: var(--success); color: white; margin-left: 8px; }
        .email-badge.disabled { background: var(--secondary); }
        .chat-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        .chat-history { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; box-shadow: var(--shadow-card); }
        .chat-history-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .chat-history-list { max-height: 520px; overflow: auto; padding: 8px; }
        .chat-history-item { padding: 12px 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .chat-history-item:hover { background: #1a1a1a; border-color: #333; }
        .chat-history-item .t { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .chat-history-item .q { font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; min-height: 620px; box-shadow: var(--shadow-card); }
        .chat-panel-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; justify-content: space-between; }
        .chat-messages { padding: 18px 20px; overflow: auto; flex: 1; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); }
        .chat-msg { max-width: 78%; padding: 12px 14px; border-radius: 14px; margin: 10px 0; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
        .chat-msg.user { margin-left: auto; background: #1a1a1a; border: 1px solid #333; }
        .chat-msg.ai { margin-right: auto; background: rgba(74, 222, 128, 0.08); border: 1px solid rgba(74, 222, 128, 0.25); }
        .chat-msg pre { background: rgba(15, 23, 42, 0.55); border: 1px solid rgba(148, 163, 184, 0.18); padding: 12px 12px; border-radius: 12px; overflow: auto; margin: 10px 0; }
        .chat-msg code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace; font-size: 13px; }
        .chat-msg pre code { display: block; white-space: pre; }
        .chat-msg ul { margin: 8px 0 8px 18px; }
        .chat-msg ol { margin: 8px 0 8px 18px; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .drawer { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: linear-gradient(to bottom, #1a1a1a, #111); border-left: 1px solid var(--border); z-index: 2000; transition: right 0.3s ease; box-shadow: -4px 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .drawer.show { right: 0; }
        .drawer-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .drawer-title { font-size: 18px; font-weight: 700; }
        .drawer-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s; }
        .drawer-close:hover { background: var(--bg-input); color: var(--text-primary); }
        .drawer-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
        .drawer-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .drawer-footer .btn { flex: 1; }
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .drawer-overlay.show { opacity: 1; visibility: visible; }
        .category-checkbox-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; cursor: pointer; transition: all 0.2s; background: var(--bg-input); }

        /* 响应式：窄屏下缩小工具栏，减少对页面头部的影响 */
        @media (max-width: 1024px) {
            :root { --top-toolbar-safe-right: 160px; --top-toolbar-safe-top: 72px; }
            .user-details-compact { display: none; }
            .user-info-compact { padding-right: 0; border-right: none; }
        }
        .category-checkbox-item:hover { border-color: #444; background: #161616; }
        .category-checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #4ade80; }
        .category-checkbox-item label { flex: 1; cursor: pointer; font-size: 14px; }
        .category-checkbox-item.selected { border-color: #444; background: #1a1a1a; }
        .chat-input { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .chat-input textarea { flex: 1; resize: vertical; min-height: 46px; max-height: 160px; padding: 12px 14px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); color: var(--text-primary); font-size: 14px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .chat-input textarea:focus { outline: none; border-color: #555; background: #161616; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1100px) { .chat-layout { grid-template-columns: 1fr; } .chat-panel { min-height: 560px; } }
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .filter-row { flex-direction: column; flex-wrap: nowrap; overflow-x: visible; } .filter-item { width: 100%; } }
    </style>
    <!-- Markdown 渲染：marked + DOMPurify（允许前端依赖） -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://sf3-cn.feishucdn.com/obj/feishu-static/lark/passport/qrcode/LarkSSOSDKWebQRCode-1.0.2.js"></script>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-container" id="loginPage">
        <div class="login-box" id="loginBox">
            <h1><i class="fa-solid fa-wallet" style="margin-right:8px;"></i>记账系统</h1>
            <p>后台管理系统，请登录以继续</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>用户名或邮箱</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名或邮箱" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码" required>
                </div>
                <div class="login-alert" id="loginLockedHint">账号已锁定，暂无法登录。请联系管理员将状态设置为“正常”。</div>
                <button type="submit" class="btn btn-primary">登录系统</button>
            </form>
            <div id="feishuLoginArea" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
                <button type="button" class="link-btn" onclick="showFeishuLogin()" style="margin-top:0;"><i class="fa-solid fa-qrcode" style="margin-right:6px;"></i>飞书扫码登录</button>
            </div>
            <button class="link-btn" onclick="showForgotPassword()">忘记密码？</button>
        </div>
        <!-- 飞书扫码登录 -->
        <div class="login-box" id="feishuBox" style="display:none;">
            <h1><i class="fa-solid fa-qrcode" style="margin-right:8px;"></i>飞书扫码登录</h1>
            <p>使用飞书 App 扫描下方二维码完成登录</p>
            <div id="feishuQRContainer" style="width:280px;height:280px;margin:24px auto;background:#1a1a1a;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;"></div>
            <p style="font-size:12px;color:var(--text-muted);text-align:center;">请使用飞书 App 扫码，二维码有效期为 5 分钟</p>
            <button class="link-btn" onclick="showLogin()" style="margin-top:16px;">返回密码登录</button>
        </div>
        <!-- 忘记密码：发送验证码 -->
        <div class="login-box" id="forgotBox" style="display:none;">
            <h1><i class="fa-solid fa-key" style="margin-right:8px;"></i>忘记密码</h1>
            <p>输入注册邮箱，我们将发送验证码</p>
            <form id="forgotForm">
                <div class="form-group">
                    <label>邮箱地址</label>
                    <input type="email" id="forgotEmail" placeholder="请输入注册邮箱" required>
                </div>
                <button type="submit" class="btn btn-primary">发送验证码</button>
            </form>
            <p style="font-size:12px;margin-top:8px;"><a href="javascript:void(0)" onclick="showResetWithCode()" class="link-btn" style="display:inline;padding:0;">已收到验证码？直接输入</a></p>
            <button class="link-btn" onclick="showLogin()">返回登录</button>
        </div>
        <!-- 重置密码：验证码+新密码 -->
        <div class="login-box" id="resetBox" style="display:none;">
            <h1><i class="fa-solid fa-lock" style="margin-right:8px;"></i>重置密码</h1>
            <p id="resetInfo">请输入验证码和新密码</p>
            <form id="resetForm">
                <div class="form-group">
                    <label>邮箱地址</label>
                    <input type="email" id="resetEmail" placeholder="请输入注册邮箱" required>
                </div>
                <div class="form-group">
                    <label>验证码</label>
                    <input type="text" id="resetCode" placeholder="请输入6位验证码" maxlength="6" pattern="[0-9]{6}" required>
                </div>
                <div class="form-group">
                    <label>新密码</label>
                    <input type="password" id="newPassword" placeholder="请输入新密码（至少6位）" required minlength="6">
                </div>
                <div class="form-group">
                    <label>确认密码</label>
                    <input type="password" id="confirmPassword" placeholder="请再次输入新密码" required>
                </div>
                <button type="submit" class="btn btn-primary">确认重置</button>
            </form>
            <button class="link-btn" onclick="showForgotPassword()">返回上一步</button>
        </div>
    </div>

    <!-- 主应用 -->
    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon"><i class="fa-solid fa-cube" style="font-size:18px;color:#d1d5db;"></i></div>
                <div class="logo-text">记账管理</div>
            </div>
            <nav class="nav-menu custom-scroll" id="navMenuContainer">
                <!-- 菜单由 JS 根据 current-user.menus 动态渲染 -->
            </nav>
        </div>

        <!-- 右上角工具栏 -->
        <div class="top-toolbar" id="topToolbar" style="display: none;">
            <div class="user-info-compact">
                <div class="user-avatar-compact" id="userAvatarCompact">A</div>
                <div class="user-details-compact">
                    <div class="user-name-compact" id="displayUsernameCompact">管理员</div>
                    <div class="user-role-compact" id="userRoleCompact">系统管理员</div>
                    <div class="impersonation-badge" id="impersonationBadge" style="display:none;margin-top:4px;font-size:11px;color:var(--warning);">
                        <span style="background:var(--warning);color:#fff;padding:2px 6px;border-radius:4px;">模拟登录中</span>
                    </div>
                </div>
            </div>
            <button class="top-toolbar-btn" id="exitImpersonationBtn" onclick="exitImpersonation()" title="退出模拟登录" style="display:none;background:var(--warning);color:#fff;">
                <i class="fa-solid fa-user-slash" style="font-size:18px;"></i>
            </button>
            <button class="top-toolbar-btn" id="feishuBindBtn" onclick="openFeishuBindModal()" title="绑定飞书" style="display:none;">
                <i class="fa-solid fa-qrcode" style="font-size:18px;"></i>
            </button>
            <button class="top-toolbar-btn" id="themeFab" onclick="openThemeModal()" title="切换主题">
                <i class="fa-solid fa-palette" style="font-size:18px;"></i>
            </button>
            <button class="top-toolbar-btn" onclick="logout()" title="退出登录">
                <i class="fa-solid fa-right-from-bracket" style="font-size:18px;"></i>
            </button>
        </div>
        <div class="main-content">
            <!-- 数据概览页 -->
            <div class="page-content active" id="page-dashboard">
                <div class="page-header"><div><h1 class="page-title">数据概览</h1><p class="page-subtitle">查看系统整体数据统计</p></div></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon blue"><i class="fa-solid fa-sack-dollar"></i></div><div class="stat-value" id="statTotalAmount">¥0.00</div><div class="stat-label">总消费金额</div></div>
                    <div class="stat-card"><div class="stat-icon green"><i class="fa-solid fa-vault"></i></div><div class="stat-value" id="statTotalIncome">¥0.00</div><div class="stat-label">总收入金额</div></div>
                    <div class="stat-card"><div class="stat-icon orange"><i class="fa-solid fa-receipt"></i></div><div class="stat-value" id="statTotalCount">0</div><div class="stat-label">消费记录数</div></div>
                    <div class="stat-card"><div class="stat-icon red"><i class="fa-solid fa-chart-line"></i></div><div class="stat-value" id="statIncomeCount">0</div><div class="stat-label">收入记录数</div></div>
                </div>
                <div class="data-table-container">
                    <table class="data-table"><thead><tr><th>消费类别</th><th>消费金额</th><th>记录数量</th><th>占比</th></tr></thead><tbody id="categoryStatsTable"></tbody></table>
                </div>
            </div>

            <!-- 账单管理页 -->
            <div class="page-content" id="page-expenses">
                <div class="page-header">
                    <div><h1 class="page-title">账单管理</h1><p class="page-subtitle">查看和管理所有用户的消费记录</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>开始日期</label><input type="date" id="filterStartDate"></div>
                        <div class="filter-item"><label>结束日期</label><input type="date" id="filterEndDate"></div>
                        <div class="filter-item"><label>消费类别</label><select id="filterCategory"><option value="">全部类别</option></select></div>
                        <div class="filter-item" id="filterUsernameItem" style="display: none;"><label>选择用户</label><select id="filterUserId" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">全部用户</option></select></div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadExpenses()">查询</button>
                            <button class="btn btn-success" onclick="openExpenseModal()">添加记录</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table"><thead><tr><th>ID</th><th>用户名</th><th>金额</th><th>类别</th><th>描述</th><th>消费时间</th><th>操作</th></tr></thead><tbody id="expensesTable"></tbody></table>
                    <div class="pagination"><div class="pagination-info" id="paginationInfo">共 0 条记录</div><div class="pagination-buttons" id="paginationButtons"></div></div>
                </div>
            </div>

            <!-- 账单统计页 -->
            <div class="page-content" id="page-statistics">
                <div class="page-header">
                    <div><h1 class="page-title">账单统计</h1><p class="page-subtitle">按时间范围和类别筛选，查看消费统计图表</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>时间范围类型</label>
                            <select id="statRangeType" onchange="onStatRangeTypeChange()">
                                <option value="month">按月统计</option>
                                <option value="year">按年统计</option>
                                <option value="custom">自定义时间</option>
                            </select>
                        </div>
                        <div class="filter-item" id="statMonthGroup">
                            <label>年月</label>
                            <input type="month" id="statYearMonth">
                        </div>
                        <div class="filter-item" id="statYearGroup" style="display: none;">
                            <label>年份</label>
                            <input type="number" id="statYear" min="2000" max="2100" placeholder="2024">
                        </div>
                        <div class="filter-item" id="statCustomGroup" style="display: none;">
                            <label>开始日期</label>
                            <input type="date" id="statStartDate">
                        </div>
                        <div class="filter-item" id="statCustomEndGroup" style="display: none;">
                            <label>结束日期</label>
                            <input type="date" id="statEndDate">
                        </div>
                        <div class="filter-item" id="statUserFilterItem" style="display: none;">
                            <label>选择用户</label>
                            <select id="statUserId" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                                <option value="">全部用户</option>
                            </select>
                        </div>
                        <div class="filter-item" style="flex: 1; min-width: 200px;">
                            <label>消费类别筛选</label>
                            <button class="btn btn-secondary" onclick="openCategoryDrawer()" style="width: 100%; justify-content: space-between;">
                                <span id="statCategoryButtonText">选择类别（可多选）</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                            </button>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadStatisticsData()">查询统计</button>
                            <button class="btn btn-secondary" onclick="resetStatisticsFilters()">重置</button>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.1em;"><i class="fa-solid fa-chart-pie" style="margin-right:8px;"></i>总览</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">总金额：</span>
                                <span style="font-size: 20px; font-weight: 700; color: var(--primary-light);" id="detailStatTotalAmount">¥0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">总记录数：</span>
                                <span style="font-size: 20px; font-weight: 700;" id="detailStatTotalCount">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">时间范围：</span>
                                <span style="font-size: 14px;" id="detailStatTimeRange">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.1em;"><i class="fa-solid fa-layer-group" style="margin-right:8px;"></i>类别统计</h3>
                        <div id="statCategoryList" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: var(--text-secondary); text-align: center; padding: 20px;">请点击"查询统计"获取数据</p>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="stat-card">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.1em;"><i class="fa-solid fa-chart-pie" style="margin-right:8px;"></i>饼图 - 消费类别占比</h3>
                        <canvas id="pieChart" style="max-height: 400px;"></canvas>
                    </div>
                    <div class="stat-card">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.1em;"><i class="fa-solid fa-chart-column" style="margin-right:8px;"></i>柱状图 - 消费类别金额</h3>
                        <canvas id="barChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- 类别筛选抽屉 -->
            <div class="drawer-overlay" id="categoryDrawerOverlay" onclick="closeCategoryDrawer()"></div>
            <div class="drawer" id="categoryDrawer">
                <div class="drawer-header">
                    <div class="drawer-title">选择消费类别</div>
                    <button class="drawer-close" onclick="closeCategoryDrawer()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="drawer-body" id="categoryDrawerBody">
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">可多选，留空表示统计全部类别</p>
                </div>
                <div class="drawer-footer">
                    <button class="btn btn-secondary" onclick="clearCategorySelection()">清空</button>
                    <button class="btn btn-primary" onclick="closeCategoryDrawer()">确定</button>
                </div>
            </div>

            <!-- 用户管理页 -->
            <div class="page-content" id="page-users">
                <div class="page-header">
                    <div><h1 class="page-title">用户管理</h1><p class="page-subtitle">管理系统用户，重置用户密码</p></div>
                    <div id="emailStatus"></div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>用户名</th><th>邮箱</th><th>管理员</th><th>角色</th><th>状态</th><th>注册时间</th><th>操作</th></tr></thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 消费类别页 -->
            <div class="page-content" id="page-categories">
                <div class="page-header">
                    <div><h1 class="page-title">消费类别</h1><p class="page-subtitle">手动维护消费类别，供添加账单/筛选使用</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item" style="min-width: 240px; flex: 0 0 240px;">
                            <label>类别名称</label>
                            <input type="text" id="categorySearchName" placeholder="搜索类别名称" oninput="renderCategoriesTable()">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadCategories()">查询</button>
                            <button class="btn btn-success" onclick="openCategoryModal()">添加类别</button>
                            <button class="btn btn-secondary" onclick="resetCategorySearch()">重置</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>名称</th><th>排序</th><th>创建时间</th><th>操作</th></tr></thead>
                        <tbody id="categoriesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 收入类别页 -->
            <div class="page-content" id="page-income-categories">
                <div class="page-header">
                    <div><h1 class="page-title">收入类别</h1><p class="page-subtitle">手动维护收入类别，供添加收入/筛选使用</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item" style="min-width: 240px; flex: 0 0 240px;">
                            <label>类别名称</label>
                            <input type="text" id="incomeCategorySearchName" placeholder="搜索类别名称" oninput="renderIncomeCategoriesTable()">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadIncomeCategories()">查询</button>
                            <button class="btn btn-success" onclick="openIncomeCategoryModal()">添加类别</button>
                            <button class="btn btn-secondary" onclick="resetIncomeCategorySearch()">重置</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>名称</th><th>排序</th><th>创建时间</th><th>操作</th></tr></thead>
                        <tbody id="incomeCategoriesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- 数据导出页 -->
            <div class="page-content" id="page-export">
                <div class="page-header"><div><h1 class="page-title">数据导出</h1><p class="page-subtitle">按时间范围导出消费记录为 Excel 文件</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>开始日期 *</label><input type="date" id="exportStartDate" required></div>
                        <div class="filter-item"><label>结束日期 *</label><input type="date" id="exportEndDate" required></div>
                        <div class="filter-actions"><button class="btn btn-success" onclick="exportExcel()"><i class="fa-solid fa-file-export" style="margin-right:6px;"></i>导出 Excel</button></div>
                    </div>
                </div>
                <div class="stat-card" style="max-width: 600px;">
                    <h3 style="margin-bottom: 16px; font-size: 16px; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.1em;"><i class="fa-solid fa-circle-info" style="margin-right:8px;"></i>导出说明</h3>
                    <ul style="color: var(--text-secondary); line-height: 2;">
                        <li>请选择要导出的时间范围</li>
                        <li>导出文件格式为 Excel (.xlsx)</li>
                        <li>文件包含：ID、用户名、金额、类别、描述、消费时间、创建时间</li>
                        <li>文件末尾包含金额汇总统计</li>
                        <li id="exportPermissionHint" style="color: var(--primary); font-weight: 500; margin-top: 8px;">权限说明：管理员可导出所有用户数据，普通用户只能导出自己的数据</li>
                    </ul>
                </div>
            </div>

            <!-- 收入管理页 -->
            <div class="page-content" id="page-incomes">
                <div class="page-header">
                    <div><h1 class="page-title">收入</h1><p class="page-subtitle">查看和管理所有用户的收入记录</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>开始日期</label><input type="date" id="incomeFilterStartDate"></div>
                        <div class="filter-item"><label>结束日期</label><input type="date" id="incomeFilterEndDate"></div>
                        <div class="filter-item" id="incomeFilterTypeItem" style="display: none;"><label>收入类型</label><select id="incomeFilterType" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">全部类型</option></select></div>
                        <div class="filter-item" id="incomeFilterUsernameItem" style="display: none;"><label>选择用户</label><select id="incomeFilterUserId" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">全部用户</option></select></div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadIncomes()">查询</button>
                            <button class="btn btn-success" onclick="openIncomeModal()">添加收入</button>
                            <button class="btn btn-secondary" onclick="resetIncomeFilters()">重置</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>用户名</th><th>收入金额</th><th>收入类型</th><th>收入时间</th><th>操作</th></tr></thead>
                        <tbody id="incomesTable"></tbody>
                    </table>
                    <div class="pagination">
                        <div class="pagination-info" id="incomePaginationInfo">共 0 条记录</div>
                        <div class="pagination-buttons" id="incomePaginationButtons"></div>
                    </div>
                </div>
            </div>

            <!-- AI模型管理页 -->
            <div class="page-content" id="page-ai-models">
                <div class="page-header">
                    <div><h1 class="page-title">AI模型管理</h1><p class="page-subtitle">配置和管理AI模型，用于账单分析</p></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-actions">
                            <button class="btn btn-success" onclick="openAIModelModal()">添加模型</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th style="width:40px;text-align:center;" title="拖动排序">⋮⋮</th><th>ID</th><th>模型名称</th><th>调用地址</th><th>创建时间</th><th style="min-width:200px;">操作</th></tr></thead>
                        <tbody id="aiModelsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- AI分析页 -->
            <div class="page-content" id="page-ai-analysis">
                <div class="page-header"><div><h1 class="page-title">AI分析</h1><p class="page-subtitle">使用AI模型分析指定时间范围内的消费记录</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>选择AI模型 *</label><select id="analysisModelId" onchange="onAnalysisModelChange()" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">请选择AI模型</option></select></div>
                        <div class="filter-item" id="analysisUserFilterItem" style="display:none;"><label>选择用户</label><select id="analysisUserId" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">全部用户</option></select></div>
                        <div class="filter-item"><label>开始日期 *</label><input type="date" id="analysisStartDate" required></div>
                        <div class="filter-item"><label>结束日期 *</label><input type="date" id="analysisEndDate" required></div>
                        <div class="filter-actions">
                            <button class="btn btn-success" onclick="startAIAnalysis()" id="analysisBtn"><i class="fa-solid fa-robot" style="margin-right:6px;"></i>开始分析</button>
                            <button class="btn btn-secondary" onclick="refreshAnalysisHistory()">刷新历史</button>
                        </div>
                    </div>
                </div>
                <div class="chat-layout" style="margin-top: 24px;">
                    <div class="chat-history">
                        <div class="chat-history-header">
                            <div style="font-weight:700;">分析历史</div>
                            <button class="btn btn-secondary btn-sm" onclick="refreshAnalysisHistory()">刷新</button>
                        </div>
                        <div class="chat-history-list custom-scroll" id="analysisHistoryList">
                            <div style="padding:16px;color:var(--text-secondary);text-align:center;">请选择AI模型查看历史</div>
                        </div>
                        <div class="pagination" style="border-top:1px solid var(--border);">
                            <div class="pagination-info" id="analysisPaginationInfo">第 1 / 1 页</div>
                            <div class="pagination-buttons" id="analysisPaginationButtons"></div>
                        </div>
                    </div>
                    <div class="chat-panel">
                        <div class="chat-panel-header">
                            <div style="display:flex;flex-direction:column;gap:2px;">
                                <div style="font-weight:700;"><i class="fa-solid fa-chart-line" style="margin-right:6px;"></i>AI分析结果</div>
                                <div style="font-size:12px;color:var(--text-secondary);">流式输出结束后自动渲染 Markdown</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearAnalysisResult()">清空</button>
                        </div>
                        <div class="chat-messages custom-scroll" id="aiAnalysisResult" style="white-space: normal;">
                            <div style="color: var(--text-secondary);">请选择AI模型和时间范围，然后点击“开始分析”按钮</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 角色管理页 -->
            <div class="page-content" id="page-roles">
                <div class="page-header"><div><h1 class="page-title">角色管理</h1><p class="page-subtitle">管理角色及菜单权限分配</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item" style="min-width: 240px; flex: 0 0 240px;"><label>名称/编码</label><input type="text" id="roleSearchKeyword" placeholder="搜索名称或编码" oninput="rolePage=1;renderRolesTable()"></div>
                        <div class="filter-actions"><button class="btn btn-primary" onclick="loadRoles()">查询</button><button class="btn btn-success" onclick="openRoleModal()">添加角色</button><button class="btn btn-secondary" onclick="resetRoleSearch()">重置</button></div>
                    </div>
                </div>
                <div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>名称</th><th>编码</th><th>描述</th><th>菜单数</th><th>创建时间</th><th>操作</th></tr></thead><tbody id="rolesTable"></tbody></table><div class="pagination"><div class="pagination-info" id="rolePaginationInfo">共 0 条记录</div><div class="pagination-buttons" id="rolePaginationButtons"></div></div></div>
            </div>
            <div class="page-content" id="page-menus">
                <div class="page-header"><div><h1 class="page-title">菜单管理</h1><p class="page-subtitle">配置菜单及接口绑定</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item" style="min-width: 240px; flex: 0 0 240px;"><label>名称/路径</label><input type="text" id="menuSearchKeyword" placeholder="搜索名称或路径" oninput="menuPage=1;renderMenusTable()"></div>
                        <div class="filter-actions"><button class="btn btn-primary" onclick="loadMenus()">查询</button><button class="btn btn-success" onclick="openMenuModal()">添加菜单</button><button class="btn btn-secondary" onclick="resetMenuSearch()">重置</button></div>
                    </div>
                </div>
                <div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>名称</th><th>路径</th><th>父级</th><th>图标</th><th>排序</th><th>接口数</th><th>操作</th></tr></thead><tbody id="menusTable"></tbody></table><div class="pagination"><div class="pagination-info" id="menuPaginationInfo">共 0 条记录</div><div class="pagination-buttons" id="menuPaginationButtons"></div></div></div>
            </div>
            <div class="page-content" id="page-apis">
                <div class="page-header"><div><h1 class="page-title">接口管理</h1><p class="page-subtitle">维护系统接口权限定义</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item" style="min-width: 120px; flex: 0 0 120px;"><label>方法</label><input type="text" id="apiSearchMethod" placeholder="如 GET" oninput="apiPage=1;renderAPIsTable()"></div>
                        <div class="filter-item" style="min-width: 240px; flex: 0 0 240px;"><label>路径</label><input type="text" id="apiSearchPath" placeholder="搜索路径" oninput="apiPage=1;renderAPIsTable()"></div>
                        <div class="filter-actions"><button class="btn btn-primary" onclick="loadAPIs()">查询</button><button class="btn btn-success" onclick="openAPIModal()">添加接口</button><button class="btn btn-secondary" onclick="resetAPISearch()">重置</button></div>
                    </div>
                </div>
                <div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>方法</th><th>路径</th><th>描述</th><th>创建时间</th><th>操作</th></tr></thead><tbody id="apisTable"></tbody></table><div class="pagination"><div class="pagination-info" id="apiPaginationInfo">共 0 条记录</div><div class="pagination-buttons" id="apiPaginationButtons"></div></div></div>
            </div>
            <div class="page-content" id="page-ai-chat">
                <div class="page-header">
                    <div><h1 class="page-title">AI聊天</h1><p class="page-subtitle">选择AI模型进行对话，支持流式输出并保存聊天记录</p></div>
                </div>
                <div class="chat-layout">
                    <div class="chat-history">
                        <div class="chat-history-header">
                            <div style="font-weight:700;">聊天记录</div>
                            <button class="btn btn-secondary btn-sm" onclick="refreshChatHistory()">刷新</button>
                        </div>
                        <div style="padding: 12px 12px 0;">
                            <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-secondary);font-weight:500;">选择AI模型 *</label>
                            <select id="chatModelId" onchange="onChatModelChange()" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                                <option value="">请选择AI模型</option>
                            </select>
                        </div>
                        <div class="chat-history-list custom-scroll" id="chatHistoryList">
                            <div style="padding:16px;color:var(--text-secondary);text-align:center;">请选择模型查看历史</div>
                        </div>
                    </div>
                    <div class="chat-panel">
                        <div class="chat-panel-header">
                            <div style="display:flex;flex-direction:column;gap:2px;">
                                <div style="font-weight:700;">对话窗口</div>
                                <div style="font-size:12px;color:var(--text-secondary);">发送消息后将流式返回，并自动保存本轮对话</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearChatWindow()">清空窗口</button>
                        </div>
                        <div class="chat-messages custom-scroll" id="chatMessages">
                            <div style="color:var(--text-secondary);">请选择AI模型，然后开始聊天。</div>
                        </div>
                        <div class="chat-input">
                            <textarea id="chatInput" placeholder="输入你想问AI的问题..."></textarea>
                            <button class="btn btn-success" onclick="sendChatMessage()" id="chatSendBtn">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 重置密码模态框 -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-lock" style="margin-right:6px;"></i>重置用户密码</div>
            <div class="modal-subtitle">用户：<span id="resetModalUser"></span></div>
            <div class="form-group">
                <label>新密码</label>
                <input type="password" id="adminNewPassword" placeholder="请输入新密码（至少6位）" minlength="6">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeResetModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmAdminReset()">确认重置</button>
            </div>
        </div>
    </div>

    <!-- 绑定邮箱模态框 -->
    <div class="modal" id="bindEmailModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-envelope" style="margin-right:6px;"></i>绑定/修改邮箱</div>
            <div class="modal-subtitle">用户：<span id="bindEmailModalUser"></span></div>
            <div class="form-group">
                <label>邮箱地址</label>
                <div style="display:flex;gap:8px;">
                    <input type="email" id="bindEmailInput" placeholder="请输入邮箱地址" style="flex:1;">
                    <button type="button" class="btn btn-secondary" id="bindEmailSendCodeBtn" onclick="sendBindEmailCode()">发送验证码</button>
                </div>
            </div>
            <div class="form-group" id="bindEmailCodeGroup">
                <label>验证码</label>
                <input type="text" id="bindEmailCodeInput" placeholder="请输入收到的6位验证码" maxlength="6" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div class="modal-actions" style="justify-content:space-between;">
                <div>
                    <button class="btn btn-secondary" onclick="closeBindEmailModal()">取消</button>
                    <button class="btn btn-primary" onclick="confirmBindEmail()" id="bindEmailConfirmBtn">确认绑定</button>
                </div>
                <button class="btn btn-secondary" id="bindEmailClearBtn" onclick="clearUserEmail()" style="visibility:hidden;">清除邮箱</button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑消费记录模态框 -->
    <div class="modal" id="expenseModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="expenseModalTitle"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>添加消费记录</div>
            <div class="modal-subtitle" id="expenseModalSubtitle">填写消费记录信息</div>
            <form id="expenseForm" novalidate>
                <div class="form-group" id="expenseUserIdGroup">
                    <label>选择用户 *</label>
                    <select id="expenseUserId" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                        <option value="">请选择用户</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>消费金额 *</label>
                        <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>消费类别 *</label>
                        <select id="expenseCategory" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                            <option value="">请选择类别</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>消费时间 *</label>
                    <input type="datetime-local" id="expenseTime" required>
                </div>
                <div class="form-group">
                    <label>描述说明</label>
                    <input type="text" id="expenseDescription" placeholder="可选，简要描述此笔消费">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">取消</button>
                    <button type="submit" class="btn btn-success" id="expenseSubmitBtn">确认添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除这条消费记录吗？此操作不可恢复。</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- AI模型管理模态框 -->
    <div class="modal" id="aiModelModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title" id="aiModelModalTitle"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>添加AI模型</div>
            <div class="modal-subtitle" id="aiModelModalSubtitle">配置AI模型的调用信息</div>
            <form id="aiModelForm">
                <div class="form-group">
                    <label>模型名称 *</label>
                    <input type="text" id="aiModelName" placeholder="例如：OpenAI GPT-4" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>调用地址 *</label>
                    <input type="url" id="aiModelBaseURL" placeholder="https://api.openai.com/v1" required>
                </div>
                <div class="form-group">
                    <label>API密钥 *</label>
                    <input type="password" id="aiModelAPIKey" placeholder="sk-..." required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAIModelModal()">取消</button>
                    <button type="submit" class="btn btn-success" id="aiModelSubmitBtn">确认添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除AI模型确认模态框 -->
    <div class="modal" id="deleteAIModelModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除这个AI模型配置吗？此操作不可恢复。</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteAIModelModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteAIModel()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 消费类别模态框 -->
    <div class="modal" id="categoryModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="categoryModalTitle"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>添加消费类别</div>
            <div class="modal-subtitle" id="categoryModalSubtitle">维护类别名称与排序</div>
            <form id="categoryForm">
                <div class="form-group">
                    <label>类别名称 *</label>
                    <input type="text" id="categoryName" placeholder="例如：餐饮" required maxlength="50">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>排序（越小越靠前）</label>
                        <input type="number" id="categorySort" placeholder="例如：10" step="1">
                    </div>
                    <div class="form-group">
                        <label>颜色</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="color" id="categoryColor" value="#64748b" style="width:60px;height:40px;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="text" id="categoryColorText" placeholder="#64748b" maxlength="20" style="flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);font-family:monospace;">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">取消</button>
                    <button type="submit" class="btn btn-success" id="categorySubmitBtn">确认添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除消费类别确认 -->
    <div class="modal" id="deleteCategoryModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除该消费类别吗？（软删除）</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteCategoryModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteCategory()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 角色模态框 -->
    <div class="modal" id="roleModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="roleModalTitle">添加角色</div>
            <form id="roleForm">
                <div class="form-group"><label>名称 *</label><input type="text" id="roleName" placeholder="例如：运营员" required maxlength="50"></div>
                <div class="form-group"><label>编码 *</label><input type="text" id="roleCode" placeholder="例如：operator" required maxlength="50"></div>
                <div class="form-group"><label>描述</label><input type="text" id="roleDesc" placeholder="可选" maxlength="255"></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeRoleModal()">取消</button><button type="submit" class="btn btn-success">保存</button></div>
            </form>
        </div>
    </div>
    <!-- 角色分配菜单模态框 -->
    <div class="modal" id="roleMenusModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-title">分配菜单</div>
            <div class="modal-subtitle" id="roleMenusRoleName"></div>
            <div id="roleMenusCheckboxes" style="max-height:320px;overflow-y:auto;"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeRoleMenusModal()">取消</button><button class="btn btn-success" onclick="saveRoleMenus()">保存</button></div>
        </div>
    </div>
    <!-- 删除角色确认 -->
    <div class="modal" id="deleteRoleModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除角色「<span id="deleteRoleModalName"></span>」吗？</div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeDeleteRoleModal()">取消</button><button class="btn btn-danger" onclick="confirmDeleteRole()">确认删除</button></div>
        </div>
    </div>
    <!-- 菜单模态框 -->
    <div class="modal" id="menuModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="menuModalTitle">添加菜单</div>
            <form id="menuForm">
                <div class="form-group"><label>名称 *</label><input type="text" id="menuName" required maxlength="50"></div>
                <div class="form-group"><label>路径 *</label><input type="text" id="menuPath" placeholder="例如：dashboard" required maxlength="100"></div>
                <div class="form-group"><label>父级菜单</label><select id="menuParentId" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="0">无</option></select></div>
                <div class="form-group"><label>图标</label><input type="text" id="menuIcon" placeholder="fa-chart-pie" maxlength="50"></div>
                <div class="form-group"><label>排序</label><input type="number" id="menuSort" value="0" step="1"></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeMenuModal()">取消</button><button type="submit" class="btn btn-success">保存</button></div>
            </form>
        </div>
    </div>
    <!-- 菜单绑定接口模态框 -->
    <div class="modal" id="menuAPIsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title">绑定接口</div>
            <div class="modal-subtitle" id="menuAPIsMenuName"></div>
            <div id="menuAPIsCheckboxes" style="max-height:320px;overflow-y:auto;"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeMenuAPIsModal()">取消</button><button class="btn btn-success" onclick="saveMenuAPIs()">保存</button></div>
        </div>
    </div>
    <!-- 删除菜单确认 -->
    <div class="modal" id="deleteMenuModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除菜单「<span id="deleteMenuModalName"></span>」吗？</div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeDeleteMenuModal()">取消</button><button class="btn btn-danger" onclick="confirmDeleteMenu()">确认删除</button></div>
        </div>
    </div>
    <!-- 删除接口确认 -->
    <div class="modal" id="deleteAPIModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除接口「<span id="deleteAPIModalMethod"></span> <span id="deleteAPIModalPath"></span>」吗？</div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeDeleteAPIModal()">取消</button><button class="btn btn-danger" onclick="confirmDeleteAPI()">确认删除</button></div>
        </div>
    </div>
    <!-- 接口模态框 -->
    <div class="modal" id="apiModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="apiModalTitle">添加接口</div>
            <form id="apiForm">
                <div class="form-group"><label>方法 *</label><select id="apiMethod" required><option value="GET">GET</option><option value="POST">POST</option><option value="PUT">PUT</option><option value="DELETE">DELETE</option></select></div>
                <div class="form-group"><label>路径 *</label><input type="text" id="apiPath" placeholder="/admin/expenses" required maxlength="255"></div>
                <div class="form-group"><label>描述</label><input type="text" id="apiDesc" maxlength="100"></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAPIModal()">取消</button><button type="submit" class="btn btn-success">保存</button></div>
            </form>
        </div>
    </div>

    <!-- 收入类别模态框 -->
    <div class="modal" id="incomeCategoryModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="incomeCategoryModalTitle"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>添加收入类别</div>
            <div class="modal-subtitle" id="incomeCategoryModalSubtitle">维护类别名称与排序</div>
            <form id="incomeCategoryForm">
                <div class="form-group">
                    <label>类别名称 *</label>
                    <input type="text" id="incomeCategoryName" placeholder="例如：工资" required maxlength="50">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>排序（越小越靠前）</label>
                        <input type="number" id="incomeCategorySort" placeholder="例如：10" step="1">
                    </div>
                    <div class="form-group">
                        <label>颜色</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="color" id="incomeCategoryColor" value="#64748b" style="width:60px;height:40px;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="text" id="incomeCategoryColorText" placeholder="#64748b" maxlength="20" style="flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);font-family:monospace;">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIncomeCategoryModal()">取消</button>
                    <button type="submit" class="btn btn-success" id="incomeCategorySubmitBtn">确认添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除收入类别确认 -->
    <div class="modal" id="deleteIncomeCategoryModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除该收入类别吗？（软删除）</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteIncomeCategoryModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteIncomeCategory()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 收入新增/编辑模态框 -->
    <div class="modal" id="incomeModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="incomeModalTitle"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>添加收入</div>
            <div class="modal-subtitle" id="incomeModalSubtitle">填写收入信息</div>
            <form id="incomeForm">
                <div class="form-group" id="incomeUserIdGroup">
                    <label>选择用户 *</label>
                    <select id="incomeUserId" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                        <option value="">请选择用户</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>收入金额 *</label>
                        <input type="number" id="incomeAmount" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>收入类别 *</label>
                        <select id="incomeType" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                            <option value="">请选择类别</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>收入时间 *</label>
                    <input type="datetime-local" id="incomeTime" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIncomeModal()">取消</button>
                    <button type="submit" class="btn btn-success" id="incomeSubmitBtn">确认添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 删除收入确认 -->
    <div class="modal" id="deleteIncomeModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除</div>
            <div class="modal-subtitle">确定要删除这条收入记录吗？（软删除）</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteIncomeModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteIncome()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 删除用户确认 -->
    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>确认删除用户</div>
            <div class="modal-subtitle">确定要删除用户 <span id="deleteUserModalUsername"></span> 吗？此操作不可恢复。</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteUserModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteUser()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 设置管理员权限 -->
    <div class="modal" id="setAdminModal">
        <div class="modal-content">
            <div class="modal-title" id="setAdminModalTitle">设置管理员权限</div>
            <div class="modal-subtitle">用户：<span id="setAdminModalUsername"></span></div>
            <div class="form-group">
                <label>管理员权限</label>
                <select id="setAdminIsAdmin" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                    <option value="false">否</option>
                    <option value="true">是</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSetAdminModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmSetAdmin()">确认</button>
            </div>
        </div>
    </div>

    <!-- 设置用户角色 -->
    <div class="modal" id="setUserRoleModal">
        <div class="modal-content">
            <div class="modal-title">设置用户角色</div>
            <div class="modal-subtitle">用户：<span id="setUserRoleModalUsername"></span></div>
            <div class="form-group">
                <label>角色</label>
                <select id="setUserRoleSelect" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                    <option value="">无（清除角色）</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSetUserRoleModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmSetUserRole()">确认</button>
            </div>
        </div>
    </div>

    <!-- 主题选择弹框（右上角按钮触发） -->
    <div class="modal" id="themeModal">
        <div class="modal-content theme-modal-content">
            <div class="theme-modal-header">
                <div>
                    <div class="modal-title"><i class="fa-solid fa-palette" style="margin-right:6px;"></i>选择主题</div>
                    <div class="theme-modal-sub">点击即刻生效，自动保存；刷新后保持</div>
                </div>
                <button class="drawer-close" onclick="closeThemeModal()" title="关闭">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div style="margin-top: 18px;">
                <div class="theme-options" id="themeOptions">
                    <div class="theme-option" data-theme="dark" onclick="selectThemeFromModal('dark')" title="深色主题">
                        <div class="theme-preview">
                            <div class="theme-color" style="background:#0f172a;"></div>
                            <div class="theme-color" style="background:#1e293b;"></div>
                            <div class="theme-color" style="background:#2563eb;"></div>
                        </div>
                        <div class="theme-name">深色</div>
                    </div>
                    <div class="theme-option" data-theme="light" onclick="selectThemeFromModal('light')" title="浅色主题">
                        <div class="theme-preview">
                            <div class="theme-color" style="background:#f8fafc;"></div>
                            <div class="theme-color" style="background:#ffffff;"></div>
                            <div class="theme-color" style="background:#2563eb;"></div>
                        </div>
                        <div class="theme-name">浅色</div>
                    </div>
                    <div class="theme-option" data-theme="purple" onclick="selectThemeFromModal('purple')" title="紫色主题">
                        <div class="theme-preview">
                            <div class="theme-color" style="background:#1a0b2e;"></div>
                            <div class="theme-color" style="background:#2d1b3d;"></div>
                            <div class="theme-color" style="background:#8b5cf6;"></div>
                        </div>
                        <div class="theme-name">紫色</div>
                    </div>
                    <div class="theme-option" data-theme="green" onclick="selectThemeFromModal('green')" title="绿色主题">
                        <div class="theme-preview">
                            <div class="theme-color" style="background:#0a1f1a;"></div>
                            <div class="theme-color" style="background:#1a2e28;"></div>
                            <div class="theme-color" style="background:#10b981;"></div>
                        </div>
                        <div class="theme-name">绿色</div>
                    </div>
                    <div class="theme-option" data-theme="orange" onclick="selectThemeFromModal('orange')" title="橙色主题">
                        <div class="theme-preview">
                            <div class="theme-color" style="background:#1f1a0f;"></div>
                            <div class="theme-color" style="background:#2e2518;"></div>
                            <div class="theme-color" style="background:#f59e0b;"></div>
                        </div>
                        <div class="theme-name">橙色</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 22px;">
                <button class="btn btn-secondary" onclick="closeThemeModal()">关闭</button>
                <button class="btn btn-primary" onclick="resetThemeToDefault()">恢复默认</button>
            </div>
        </div>
    </div>

    <!-- 飞书绑定弹框 -->
    <div class="modal" id="feishuBindModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-title"><i class="fa-solid fa-qrcode" style="margin-right:6px;"></i>绑定飞书</div>
            <div class="modal-subtitle">使用飞书 App 扫码，可将飞书账号绑定到当前用户</div>
            <div id="feishuBindQRContainer" style="width:260px;height:260px;margin:16px auto;background:#1a1a1a;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeFeishuBindModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 为用户绑定飞书 open_id（管理员） -->
    <div class="modal" id="feishuBindUserModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-title"><i class="fa-solid fa-qrcode" style="margin-right:6px;"></i>设置飞书绑定</div>
            <div class="modal-subtitle">用户：<span id="feishuBindUserModalUsername"></span></div>
            <div class="form-group">
                <label>飞书 open_id</label>
                <input type="text" id="feishuBindUserOpenId" placeholder="留空表示解除绑定">
            </div>
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">用户可通过右上角「绑定飞书」自助扫码绑定，或将 open_id 提供给管理员填写</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeFeishuBindUserModal()">取消</button>
                <button class="btn btn-primary" onclick="saveFeishuBindUser()">保存</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1, totalPages = 1, currentUsername = '', resetUserId = null, emailEnabled = false;
        let editingExpenseId = null, deleteExpenseId = null, allUsers = [];
        let editingAIModelId = null, deleteAIModelId = null, allAIModels = [];
        let chatStreaming = false, chatCurrentAIEl = null, chatHistoryPage = 1;
        let analysisHistoryPage = 1, analysisHistoryPageSize = 10, analysisHistoryTotalPages = 1;
        let allCategories = [], editingCategoryId = null, deleteCategoryId = null;
        let allIncomeCategories = [], editingIncomeCategoryId = null, deleteIncomeCategoryId = null;
        let incomeCurrentPage = 1, incomeTotalPages = 1, editingIncomeId = null, deleteIncomeId = null;
        let isAdmin = false; // 当前用户是否为管理员
        let currentUserId = null; // 当前用户ID
        let userMenus = []; // 当前用户可见的菜单树（来自 /admin/current-user）

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initNavigation();
            setDefaultDates();
            initTheme();
            initFeishuLogin();
            checkLoginPageParams();
        });
        
        // 主题切换功能
        function initTheme() {
            const savedTheme = localStorage.getItem('app-theme') || 'dark';
            switchTheme(savedTheme, false);
        }
        
        function switchTheme(themeName, save = true) {
            document.documentElement.setAttribute('data-theme', themeName);
            if (save) {
                localStorage.setItem('app-theme', themeName);
            }
            // 更新主题选项的激活状态
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.theme === themeName) {
                    opt.classList.add('active');
                }
            });
            // 添加切换动画
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
            // 如果图表已存在，重新渲染以应用新主题
            if (pieChartInstance || barChartInstance) {
                const categoryListEl = document.getElementById('statCategoryList');
                if (categoryListEl && categoryListEl.innerHTML && !categoryListEl.innerHTML.includes('暂无数据') && !categoryListEl.innerHTML.includes('请点击')) {
                    // 尝试从页面数据重新渲染
                    setTimeout(() => {
                        if (pieChartInstance) {
                            const data = pieChartInstance.data;
                            renderPieChart(data.labels.map((label, i) => ({
                                category: label,
                                total: data.datasets[0].data[i]
                            })));
                        }
                        if (barChartInstance) {
                            const data = barChartInstance.data;
                            renderBarChart(data.labels.map((label, i) => ({
                                category: label,
                                total: data.datasets[0].data[i]
                            })));
                        }
                    }, 100);
                }
            }
        }

        function openThemeModal() {
            const modal = document.getElementById('themeModal');
            if (!modal) return;
            modal.classList.add('show');
        }

        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            if (!modal) return;
            modal.classList.remove('show');
        }

        function selectThemeFromModal(themeName) {
            switchTheme(themeName, true);
            closeThemeModal();
            showToast('主题已切换', 'success');
        }

        function resetThemeToDefault() {
            selectThemeFromModal('dark');
        }

        // 点击弹框遮罩关闭
        (function bindThemeModalOverlayClose() {
            const modal = document.getElementById('themeModal');
            if (!modal) return;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeThemeModal();
            });
        })();

        function showLogin() {
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('forgotBox').style.display = 'none';
            document.getElementById('resetBox').style.display = 'none';
            document.getElementById('feishuBox').style.display = 'none';
            window.location.hash = '';
        }

        function showForgotPassword() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('forgotBox').style.display = 'block';
            document.getElementById('resetBox').style.display = 'none';
            document.getElementById('feishuBox').style.display = 'none';
        }

        function showResetPasswordStep(email, readOnly = true) {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('forgotBox').style.display = 'none';
            document.getElementById('resetBox').style.display = 'block';
            document.getElementById('feishuBox').style.display = 'none';
            const emailEl = document.getElementById('resetEmail');
            emailEl.value = email || '';
            emailEl.readOnly = readOnly;
            document.getElementById('resetCode').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function showResetWithCode() {
            showResetPasswordStep('', false);
        }

        let feishuQRInstance = null;

        let feishuEnabled = false;

        async function initFeishuLogin() {
            try {
                const res = await fetch('/admin/feishu/config');
                const data = await res.json();
                if (data.success) {
                    feishuEnabled = true;
                    const area = document.getElementById('feishuLoginArea');
                    if (area) area.style.display = 'block';
                    updateFeishuBindButton();
                    const usersPage = document.getElementById('page-users');
                    if (usersPage && usersPage.classList.contains('active')) loadUsers();
                }
            } catch (e) {}
        }

        function updateFeishuBindButton() {
            const btn = document.getElementById('feishuBindBtn');
            if (btn) btn.style.display = feishuEnabled ? 'flex' : 'none';
        }

        function checkLoginPageParams() {
            const params = new URLSearchParams(window.location.search);
            const error = params.get('error');
            const feishuBind = params.get('feishu_bind');
            if (error) {
                showToast(decodeURIComponent(error), 'error');
                window.history.replaceState({}, '', window.location.pathname);
            }
            if (feishuBind === 'success') {
                showToast('飞书绑定成功', 'success');
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        async function showFeishuLogin() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('forgotBox').style.display = 'none';
            document.getElementById('resetBox').style.display = 'none';
            document.getElementById('feishuBox').style.display = 'block';

            const container = document.getElementById('feishuQRContainer');
            container.innerHTML = '';

            try {
                const res = await fetch('/admin/feishu/config');
                const data = await res.json();
                if (!data.success || !data.data) {
                    showToast('飞书配置获取失败', 'error');
                    return;
                }
                const authUrl = data.data.auth_url;

                if (typeof QRLogin !== 'undefined') {
                    feishuQRInstance = new QRLogin({
                        id: 'feishuQRContainer',
                        goto: authUrl,
                        width: 240,
                        height: 240,
                        style: 'width:240px;height:240px;'
                    });

                    window.addEventListener('message', function feishuMessageHandler(event) {
                        const validOrigin = (feishuQRInstance && typeof feishuQRInstance.matchOrigin === 'function')
                            ? feishuQRInstance.matchOrigin(event.origin)
                            : ['https://accounts.feishu.cn', 'https://open.feishu.cn', 'https://passport.feishu.cn', 'https://www.feishu.cn', 'https://login.feishu.cn', 'https://sf3-cn.feishucdn.com'].some(o => event.origin === o);
                        if (!validOrigin) return;
                        const raw = event.data;
                        const tmpCode = typeof raw === 'string' ? raw : (raw && raw.tmp_code ? raw.tmp_code : null);
                        if (tmpCode && /^[a-zA-Z0-9_-]+$/.test(tmpCode)) {
                            window.removeEventListener('message', feishuMessageHandler);
                            const sep = authUrl.indexOf('?') >= 0 ? '&' : '?';
                            window.location.href = authUrl + sep + 'tmp_code=' + encodeURIComponent(tmpCode);
                        }
                    });
                } else {
                    container.innerHTML = '<p style="color:var(--text-muted);">加载二维码组件失败</p>';
                }
            } catch (e) {
                showToast('获取飞书配置失败', 'error');
            }
        }

        let feishuBindQRInstance = null;
        let feishuBindMessageHandler = null;

        async function openFeishuBindModal() {
            const modal = document.getElementById('feishuBindModal');
            const container = document.getElementById('feishuBindQRContainer');
            container.innerHTML = '';
            if (feishuBindMessageHandler) {
                window.removeEventListener('message', feishuBindMessageHandler);
                feishuBindMessageHandler = null;
            }
            try {
                const tokenRes = await fetch('/admin/feishu/bind-token', { credentials: 'same-origin' });
                const tokenData = await tokenRes.json();
                if (!tokenData.success || !tokenData.data || !tokenData.data.bind_token) {
                    showToast('请先登录后再绑定飞书', 'error');
                    return;
                }
                const bindToken = tokenData.data.bind_token;
                const res = await fetch('/admin/feishu/config?state=bind:' + encodeURIComponent(bindToken), { credentials: 'same-origin' });
                const data = await res.json();
                if (!data.success || !data.data) {
                    showToast('飞书配置获取失败', 'error');
                    return;
                }
                modal.classList.add('show');
                const authUrl = data.data.auth_url;
                if (typeof QRLogin !== 'undefined') {
                    feishuBindQRInstance = new QRLogin({
                        id: 'feishuBindQRContainer',
                        goto: authUrl,
                        width: 220,
                        height: 220,
                        style: 'width:220px;height:220px;'
                    });
                    feishuBindMessageHandler = function(event) {
                        const validOrigin = (feishuBindQRInstance && typeof feishuBindQRInstance.matchOrigin === 'function')
                            ? feishuBindQRInstance.matchOrigin(event.origin)
                            : ['https://accounts.feishu.cn', 'https://open.feishu.cn', 'https://passport.feishu.cn', 'https://www.feishu.cn', 'https://login.feishu.cn', 'https://sf3-cn.feishucdn.com'].some(o => event.origin === o);
                        if (!validOrigin) return;
                        const raw = event.data;
                        const tmpCode = typeof raw === 'string' ? raw : (raw && raw.tmp_code ? raw.tmp_code : null);
                        if (tmpCode && /^[a-zA-Z0-9_-]+$/.test(tmpCode)) {
                            window.removeEventListener('message', feishuBindMessageHandler);
                            feishuBindMessageHandler = null;
                            closeFeishuBindModal();
                            const sep = authUrl.indexOf('?') >= 0 ? '&' : '?';
                            window.location.href = authUrl + sep + 'tmp_code=' + encodeURIComponent(tmpCode);
                        }
                    };
                    window.addEventListener('message', feishuBindMessageHandler);
                } else {
                    container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">加载失败</p>';
                }
            } catch (e) {
                showToast('获取飞书配置失败', 'error');
            }
        }

        function closeFeishuBindModal() {
            document.getElementById('feishuBindModal').classList.remove('show');
            if (feishuBindMessageHandler) {
                window.removeEventListener('message', feishuBindMessageHandler);
                feishuBindMessageHandler = null;
            }
        }

        (function bindFeishuBindModalOverlay() {
            const modal = document.getElementById('feishuBindModal');
            if (!modal) return;
            modal.addEventListener('click', (e) => { if (e.target === modal) closeFeishuBindModal(); });
        })();

        let feishuBindUserId = null;

        function openFeishuBindUserModal(userId, username, currentOpenId) {
            feishuBindUserId = userId;
            document.getElementById('feishuBindUserModalUsername').textContent = username;
            document.getElementById('feishuBindUserOpenId').value = currentOpenId || '';
            document.getElementById('feishuBindUserModal').classList.add('show');
        }

        function closeFeishuBindUserModal() {
            feishuBindUserId = null;
            document.getElementById('feishuBindUserModal').classList.remove('show');
        }

        async function saveFeishuBindUser() {
            if (!feishuBindUserId) return;
            const openId = document.getElementById('feishuBindUserOpenId').value.trim();
            try {
                const res = await fetch(`/admin/users/${feishuBindUserId}/feishu`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feishu_open_id: openId })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('保存成功', 'success');
                    closeFeishuBindUserModal();
                    loadUsers();
                } else {
                    showToast(data.message || '保存失败', 'error');
                }
            } catch (e) {
                showToast('网络错误', 'error');
            }
        }

        (function bindFeishuBindUserModalOverlay() {
            const modal = document.getElementById('feishuBindUserModal');
            if (!modal) return;
            modal.addEventListener('click', (e) => { if (e.target === modal) closeFeishuBindUserModal(); });
        })();

        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim();
            try {
                const res = await fetch('/admin/password/request-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) showResetPasswordStep(email, true);
            } catch (e) { showToast('请求失败', 'error'); }
        });

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value.trim();
            const code = document.getElementById('resetCode').value.trim();
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            if (newPwd !== confirmPwd) { showToast('两次密码不一致', 'error'); return; }
            if (!email) { showToast('请输入邮箱', 'error'); return; }
            if (code.length !== 6) { showToast('请输入6位验证码', 'error'); return; }
            try {
                const res = await fetch('/admin/password/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, new_password: newPwd })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) { showLogin(); showToast('请使用新密码重新登录', 'success'); }
            } catch (e) { showToast('重置失败', 'error'); }
        });

        function checkAuth() {
            const username = getCookie('admin_username');
            if (username) {
                currentUsername = username;
                // 不使用 cookie 中的 admin_is_admin，改为从服务端 /admin/current-user 获取真实权限，防止篡改
                isAdmin = false;

                // 检查是否在模拟登录状态（通过 sessionStorage）
                const impersonatedUserId = sessionStorage.getItem('impersonated_user_id');
                const isImpersonating = impersonatedUserId && impersonatedUserId !== '';

                if (isImpersonating) {
                    currentUserId = parseInt(impersonatedUserId);
                    console.log('模拟登录：从 sessionStorage 读取用户ID:', currentUserId);
                } else {
                    const savedUserId = localStorage.getItem('admin_user_id');
                    if (savedUserId) currentUserId = parseInt(savedUserId);
                }

                showApp();
                loadEmailConfig();
                // 必须从服务端获取 is_admin 和 userId，再更新 UI 和恢复页面，防止 cookie 篡改越权
                loadCurrentUserAndUpdateUI();
            }
        }
        
        // 扁平化菜单获取所有可访问的 path 列表
        function getAllowedPaths(menus) {
            const paths = new Set();
            function collect(m) {
                if (!m || !Array.isArray(m)) return;
                for (const item of m) {
                    if (item.path) paths.add(item.path);
                    if (item.children && item.children.length) collect(item.children);
                }
            }
            collect(menus);
            return paths;
        }

        // 根据 userMenus 动态渲染侧栏菜单
        function renderNavMenus(menus) {
            const container = document.getElementById('navMenuContainer');
            if (!container) return;
            if (!menus || menus.length === 0) {
                // 无菜单时仅显示数据概览（兜底）
                container.innerHTML = `<div class="nav-item active" data-page="dashboard"><i class="fa-solid fa-chart-pie"></i><span class="nav-text">数据概览</span></div>`;
            } else {
                container.innerHTML = menus.map((m, idx) => {
                    const iconClass = m.icon ? `fa-solid ${m.icon.startsWith('fa-') ? m.icon : 'fa-' + m.icon}` : 'fa-solid fa-circle';
                    const active = idx === 0 ? ' active' : '';
                    return `<div class="nav-item${active}" data-page="${m.path || ''}"><i class="${iconClass}"></i><span class="nav-text">${m.name || m.path || ''}</span></div>`;
                }).join('');
                // 默认激活第一项（后续 restoreLastPageAfterAuth 会覆盖）
                const first = container.querySelector('.nav-item');
                if (first) first.classList.add('active');
            }
        }

        // 从服务器获取当前用户信息（含 is_admin、menus、role），并更新 UI
        async function loadCurrentUserAndUpdateUI() {
            try {
                const res = await fetch('/admin/current-user');
                const data = await res.json();
                if (data.success && data.data) {
                    currentUserId = data.data.id;
                    isAdmin = data.data.is_admin === true;
                    userMenus = data.data.menus || [];
                    renderNavMenus(userMenus);
                    const isImpersonating = data.data.username !== currentUsername;
                    if (!isImpersonating && data.data.username === currentUsername) {
                        localStorage.setItem('admin_user_id', currentUserId.toString());
                    }
                } else if (res.status === 401) {
                    showLogin();
                    return;
                } else {
                    // 降级：从用户列表查找（仅能获取 userId，is_admin 需从返回的用户里取）
                    userMenus = [];
                    const res2 = await fetch('/admin/users');
                    const data2 = await res2.json();
                    if (data2.success && data2.data) {
                        const user = data2.data.find(u => u.username === currentUsername);
                        if (user) {
                            currentUserId = user.id;
                            isAdmin = user.is_admin === true;
                            const originalAdminId = getCookie('original_admin_id');
                            if (!originalAdminId || originalAdminId === '') {
                                localStorage.setItem('admin_user_id', currentUserId.toString());
                            }
                        }
                    }
                    renderNavMenus(userMenus);
                }
            } catch (e) {
                console.error('获取当前用户失败:', e);
            }
            updateUIByPermission();
            restoreLastPageAfterAuth();
        }

        // 兼容旧调用，内部委托给 loadCurrentUserAndUpdateUI
        async function loadCurrentUserIdFromServer() {
            await loadCurrentUserAndUpdateUI();
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            // 更新右上角用户信息
            document.getElementById('displayUsernameCompact').textContent = currentUsername;
            document.getElementById('userAvatarCompact').textContent = currentUsername.charAt(0).toUpperCase();
            
            // 检查是否在模拟登录状态
            const originalAdminId = getCookie('original_admin_id');
            const isImpersonating = originalAdminId && originalAdminId !== '';
            
            if (isImpersonating) {
                // 显示模拟登录状态
                document.getElementById('impersonationBadge').style.display = 'block';
                document.getElementById('exitImpersonationBtn').style.display = 'flex';
                document.getElementById('userRoleCompact').textContent = isAdmin ? '管理员（模拟中）' : '普通用户（模拟中）';
            } else {
                // 隐藏模拟登录状态
                document.getElementById('impersonationBadge').style.display = 'none';
                document.getElementById('exitImpersonationBtn').style.display = 'none';
                document.getElementById('userRoleCompact').textContent = isAdmin ? '系统管理员' : '普通用户';
            }
            
            // 显示右上角工具栏
            document.getElementById('topToolbar').style.display = 'flex';
            updateFeishuBindButton();
        }

        // 根据权限更新UI（菜单已由 renderNavMenus 按 userMenus 渲染，此处处理页面内元素）
        function updateUIByPermission() {
            const allowed = getAllowedPaths(userMenus);
            // 若当前页不在允许列表中，跳转 dashboard
            const activePage = document.querySelector('.page-content.active');
            if (activePage) {
                const pageId = activePage.id;
                const page = pageId ? pageId.replace(/^page-/, '') : '';
                if (page && allowed.size > 0 && !allowed.has(page)) {
                    switchPage('dashboard');
                }
            }
            
            // 更新数据概览页面的副标题
            const dashboardSubtitle = document.querySelector('#page-dashboard .page-subtitle');
            if (dashboardSubtitle) {
                dashboardSubtitle.textContent = isAdmin ? '查看系统整体数据统计' : '查看个人数据统计';
            }
            
            // 账单管理页面：根据权限显示/隐藏用户筛选
            const filterUsernameItem = document.getElementById('filterUsernameItem');
            if (filterUsernameItem) {
                filterUsernameItem.style.display = isAdmin ? 'block' : 'none';
                // 如果是管理员，加载用户列表
                if (isAdmin) {
                    loadUsersForExpenses();
                }
            }
            
            // 收入管理页面：根据权限显示/隐藏搜索框（仅管理员可见）
            const incomeFilterTypeItem = document.getElementById('incomeFilterTypeItem');
            const incomeFilterUsernameItem = document.getElementById('incomeFilterUsernameItem');
            if (incomeFilterTypeItem) {
                incomeFilterTypeItem.style.display = isAdmin ? 'block' : 'none';
            }
            if (incomeFilterUsernameItem) {
                incomeFilterUsernameItem.style.display = isAdmin ? 'block' : 'none';
                // 如果是管理员，加载用户列表
                if (isAdmin) {
                    loadUsersForIncomes();
                }
            }
            
            // 账单和收入添加/编辑：根据权限显示/隐藏用户选择
            const expenseUserIdGroup = document.getElementById('expenseUserIdGroup');
            const incomeUserIdGroup = document.getElementById('incomeUserIdGroup');
            const expenseUserId = document.getElementById('expenseUserId');
            const incomeUserId = document.getElementById('incomeUserId');
            if (expenseUserIdGroup) {
                expenseUserIdGroup.style.display = isAdmin ? 'block' : 'none';
            }
            if (incomeUserIdGroup) {
                incomeUserIdGroup.style.display = isAdmin ? 'block' : 'none';
            }
            // 对于非管理员，移除 required 属性并设置当前用户ID
            if (expenseUserId) {
                if (isAdmin) {
                    expenseUserId.required = true;
                } else {
                    expenseUserId.required = false;
                    const currentUserId = getCookie('admin_user_id');
                    if (currentUserId) {
                        expenseUserId.value = currentUserId;
                    }
                }
            }
            if (incomeUserId) {
                if (isAdmin) {
                    incomeUserId.required = true;
                } else {
                    incomeUserId.required = false;
                    const currentUserId = getCookie('admin_user_id');
                    if (currentUserId) {
                        incomeUserId.value = currentUserId;
                    }
                }
            }
            
            // AI分析页面：根据权限显示/隐藏用户筛选
            const analysisUserFilterItem = document.getElementById('analysisUserFilterItem');
            if (analysisUserFilterItem) {
                analysisUserFilterItem.style.display = isAdmin ? 'block' : 'none';
            }
            
            // 账单统计页面：根据权限显示/隐藏用户筛选
            const statUserFilterItem = document.getElementById('statUserFilterItem');
            if (statUserFilterItem) {
                statUserFilterItem.style.display = isAdmin ? 'block' : 'none';
                // 如果是管理员，加载用户列表
                if (isAdmin) {
                    loadUsersForStatistics();
                }
            }
            
            // 非管理员自动设置用户ID为自己
            if (!isAdmin) {
                const currentUserId = getCookie('admin_user_id');
                if (currentUserId) {
                    const expenseSelect = document.getElementById('expenseUserId');
                    const incomeSelect = document.getElementById('incomeUserId');
                    if (expenseSelect) {
                        expenseSelect.innerHTML = `<option value="${currentUserId}">${currentUsername}</option>`;
                        expenseSelect.value = currentUserId;
                    }
                    if (incomeSelect) {
                        incomeSelect.innerHTML = `<option value="${currentUserId}">${currentUsername}</option>`;
                        incomeSelect.value = currentUserId;
                    }
                }
            }
        }

        function initNavigation() {
            const container = document.getElementById('navMenuContainer');
            if (container) {
                container.addEventListener('click', (e) => {
                    const item = e.target.closest('.nav-item');
                    if (item && item.dataset.page) {
                        switchPage(item.dataset.page);
                        setActiveNav(item.dataset.page);
                    }
                });
            }
        }

        const LAST_PAGE_KEY = 'app-last-page';

        function isResetPasswordHash(hash) {
            return (hash || '').includes('reset-password');
        }

        function normalizePageFromHash(hash) {
            if (!hash) return '';
            if (isResetPasswordHash(hash)) return '';
            const s = hash.startsWith('#') ? hash.slice(1) : hash;
            if (!s) return '';
            // 仅取 ? 前面的部分
            return s.split('?')[0].trim();
        }

        function isValidPage(page) {
            if (!page) return false;
            return !!document.getElementById(`page-${page}`);
        }

        function getRestorablePage() {
            const fromHash = normalizePageFromHash(window.location.hash);
            const fromStorage = (localStorage.getItem(LAST_PAGE_KEY) || '').trim();
            const candidate = fromHash || fromStorage;

            if (!isValidPage(candidate)) return 'dashboard';
            const allowed = getAllowedPaths(userMenus);
            if (allowed.size > 0 && !allowed.has(candidate)) return 'dashboard';
            return candidate;
        }

        function setActiveNav(page) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const nav = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (nav) nav.classList.add('active');
        }

        function restoreLastPageAfterAuth() {
            const page = getRestorablePage();
            switchPage(page, { persist: false });
            setActiveNav(page);
        }

        function switchPage(page) {
            const allowed = getAllowedPaths(userMenus);
            if (allowed.size > 0 && !allowed.has(page)) {
                page = 'dashboard';
            }
            // 默认持久化当前页面，便于刷新恢复
            // 允许内部调用时通过第二参关闭持久化，避免重复写入或干扰 reset-password hash
            const opts = arguments.length > 1 ? arguments[1] : null;
            const persist = !(opts && opts.persist === false);

            if (persist) {
                try { localStorage.setItem(LAST_PAGE_KEY, page); } catch (_) {}
                if (!isResetPasswordHash(window.location.hash)) {
                    // 避免污染重置密码 hash
                    window.location.hash = `#${page}`;
                }
            }

            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            if (page === 'dashboard') loadStatistics();
            else if (page === 'expenses') { setDefaultExpenseFilterDates(); if (isAdmin) loadUsersForExpenses(); loadExpenses(); }
            else if (page === 'statistics') { initStatisticsPage(); }
            else if (page === 'users') loadUsers();
            else if (page === 'categories') loadCategories();
            else if (page === 'income-categories') loadIncomeCategories();
            else if (page === 'incomes') { if (isAdmin) { loadUsersForIncomes(); loadIncomeCategoriesFromServer().then(() => renderIncomeCategoryOptions(document.getElementById('incomeFilterType'), true)); } setDefaultIncomeDates(); loadIncomes(); }
            else if (page === 'ai-models') loadAIModels();
            else if (page === 'ai-analysis') { 
                loadAIModelsForAnalysis(); 
                setDefaultAnalysisDates();
                loadUsersForAnalysis();
            }
            else if (page === 'ai-chat') { loadAIModelsForChat(); }
            else if (page === 'roles') loadRoles();
            else if (page === 'menus') loadMenus();
            else if (page === 'apis') loadAPIs();
        }

        function setDefaultExpenseFilterDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const s = document.getElementById('filterStartDate');
            const e = document.getElementById('filterEndDate');
            if (s && !s.value) s.value = formatDate(firstDay);
            if (e && !e.value) e.value = formatDate(today);
        }

        function setDefaultIncomeDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const s = document.getElementById('incomeFilterStartDate');
            const e = document.getElementById('incomeFilterEndDate');
            if (s && !s.value) s.value = formatDate(firstDay);
            if (e && !e.value) e.value = formatDate(today);
        }

        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('filterStartDate').value = formatDate(firstDay);
            document.getElementById('filterEndDate').value = formatDate(today);
            document.getElementById('exportStartDate').value = formatDate(firstDay);
            document.getElementById('exportEndDate').value = formatDate(today);
        }

        function setDefaultAnalysisDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('analysisStartDate').value = formatDate(firstDay);
            document.getElementById('analysisEndDate').value = formatDate(today);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lockedHint = document.getElementById('loginLockedHint');
            if (lockedHint) lockedHint.classList.remove('show');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    currentUsername = (data.data && data.data.username) ? data.data.username : username;
                    // 保存用户ID到 localStorage 和变量
                    if (data.data && data.data.user_id) {
                        currentUserId = data.data.user_id;
                        localStorage.setItem('admin_user_id', currentUserId.toString());
                    }
                    isAdmin = data.data && data.data.is_admin === true;
                    showToast('登录成功', 'success');
                    showApp();
                    loadStatistics();
                    loadEmailConfig();
                    updateUIByPermission();
                } else {
                    const msg = data.message || '登录失败';
                    const isLocked = res.status === 403 || msg.includes('锁定') || msg.toLowerCase().includes('locked');
                    if (isLocked) {
                        if (lockedHint) lockedHint.classList.add('show');
                        showToast(msg, 'warning');
                    } else {
                        showToast(msg, 'error');
                    }
                }
            } catch (err) { showToast('网络错误', 'error'); }
        });

        async function logout() {
            try { await fetch('/admin/logout', { method: 'POST' }); } catch (e) {}
            // 清除本地存储的用户ID
            localStorage.removeItem('admin_user_id');
            currentUserId = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('topToolbar').style.display = 'none';
            showLogin();
            showToast('已退出登录', 'success');
        }

        async function loadEmailConfig() {
            try {
                const res = await fetch('/admin/email-config');
                const data = await res.json();
                if (data.success) {
                    emailEnabled = data.data.enabled;
                    document.getElementById('emailStatus').innerHTML = emailEnabled 
                        ? '<span class="email-badge">邮件服务已启用</span>'
                        : '<span class="email-badge disabled">邮件服务未启用</span>';
                }
            } catch (e) {}
        }

        async function loadStatistics() {
            try {
                const res = await fetch('/admin/statistics');
                const data = await res.json();
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('statTotalAmount').textContent = `¥${stats.total_amount.toFixed(2)}`;
                    document.getElementById('statTotalCount').textContent = stats.total_count;
                    document.getElementById('statTotalIncome').textContent = `¥${(stats.total_income || 0).toFixed(2)}`;
                    document.getElementById('statIncomeCount').textContent = stats.income_count || 0;
                    const tbody = document.getElementById('categoryStatsTable');
                    if (stats.category_stats && stats.category_stats.length > 0) {
                        tbody.innerHTML = stats.category_stats.map(cat => {
                            const color = getCategoryColor(cat.category);
                            return `<tr><td><span class="category-tag" style="background: ${hexToRgba(color, 0.15)}; color: ${color};">${cat.category}</span></td><td class="amount">¥${cat.total.toFixed(2)}</td><td>${cat.count} 条</td><td>${((cat.total / stats.total_amount) * 100).toFixed(1)}%</td></tr>`;
                        }).join('');
                    } else { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">暂无数据</td></tr>'; }
                }
            } catch (err) { console.error('加载统计数据失败:', err); }
        }

        async function loadExpenses() {
            // 确保筛选下拉是最新的数据库类别
            if (!allCategories || allCategories.length === 0) {
                await refreshExpenseCategorySelectors();
            }
            const params = new URLSearchParams({ page: currentPage, page_size: 15 });
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            // 使用user_id而不是username（仅管理员）
            if (isAdmin) {
                const userId = document.getElementById('filterUserId')?.value || '';
                if (userId) {
                    params.append('user_id', userId);
                }
            }
            if (startDate) params.append('start_time', startDate);
            if (endDate) params.append('end_time', endDate);
            if (category) params.append('category', category);
            try {
                const res = await fetch(`/admin/expenses?${params}`);
                const data = await res.json();
                if (data.success) renderExpensesTable(data.data);
            } catch (err) { console.error('加载消费记录失败:', err); }
        }

        function renderExpensesTable(data) {
            const tbody = document.getElementById('expensesTable');
            if (!data.list || data.list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary);padding:40px;">暂无消费记录</td></tr>';
            } else {
                tbody.innerHTML = data.list.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.username || '-'}</td>
                        <td class="amount">¥${item.amount.toFixed(2)}</td>
                        <td><span class="category-tag" style="background: ${hexToRgba(getCategoryColor(item.category), 0.15)}; color: ${getCategoryColor(item.category)};">${item.category}</span></td>
                        <td>${item.description || '-'}</td>
                        <td>${formatDateTime(item.expense_time)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditExpenseModal(${item.id}, ${item.user_id}, ${item.amount}, '${item.category}', '${item.description || ''}', '${item.expense_time}')">编辑</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteModal(${item.id})">删除</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            totalPages = Math.ceil(data.total / data.page_size) || 1;
            document.getElementById('paginationInfo').textContent = `共 ${data.total} 条记录，第 ${data.page} / ${totalPages} 页`;
            renderPagination();
        }

        function renderPagination() {
            const container = document.getElementById('paginationButtons');
            let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>上一页</button>`;
            for (let i = 1; i <= totalPages && i <= 5; i++) html += `<button class="page-btn ${currentPage === i ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            if (totalPages > 5) html += `<span style="padding: 8px;">...</span><button class="page-btn ${currentPage === totalPages ? 'active' : ''}" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>下一页</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) { if (page < 1 || page > totalPages) return; currentPage = page; loadExpenses(); }
        function resetFilters() { setDefaultDates(); document.getElementById('filterCategory').value = ''; if (isAdmin) { const filterUserId = document.getElementById('filterUserId'); if (filterUserId) filterUserId.value = ''; } currentPage = 1; loadExpenses(); }

        let usersRoleMap = {};
        let allRolesForUsers = [];
        async function loadUsers() {
            try {
                const [usersRes, rolesRes] = await Promise.all([fetch('/admin/users'), fetch('/admin/roles')]);
                const usersData = await usersRes.json();
                const rolesData = await rolesRes.json();
                usersRoleMap = {};
                allRolesForUsers = [];
                if (rolesData.success && rolesData.data) {
                    allRolesForUsers = rolesData.data;
                    rolesData.data.forEach(r => { usersRoleMap[r.id] = r.name || r.code; });
                }
                if (usersData.success) renderUsersTable(usersData.data);
            } catch (err) { console.error('加载用户列表失败:', err); }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-secondary);padding:40px;">暂无用户</td></tr>';
            } else {
                // 优先从变量获取，如果没有则从 localStorage 获取
                let currentUserIdForTable = currentUserId;
                if (!currentUserIdForTable) {
                    const savedUserId = localStorage.getItem('admin_user_id');
                    if (savedUserId) {
                        currentUserIdForTable = parseInt(savedUserId);
                        currentUserId = currentUserIdForTable;
                    }
                }
                currentUserIdForTable = currentUserIdForTable || 0;
                const originalAdminId = getCookie('original_admin_id');
                const canImpersonate = originalAdminId && originalAdminId !== '' ? false : isAdmin; // 如果正在模拟登录，不能再次模拟
                tbody.innerHTML = users.map(user => {
                    const isCurrentUser = user.id === currentUserId;
                    const status = user.status || 'active';
                    const statusText = status === 'active' ? '正常' : '锁定';
                    const statusBadge = status === 'active'
                        ? '<span class="badge badge-success">正常</span>'
                        : '<span class="badge badge-danger">锁定</span>';
                    const toggleText = status === 'active' ? '锁定' : '解锁';
                    const nextStatus = status === 'active' ? 'locked' : 'active';
                    const roleName = user.role_id ? (usersRoleMap[user.role_id] || '#' + user.role_id) : '<span style="color:var(--text-secondary)">未设置</span>';
                    return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '<span style="color:var(--text-secondary)">未设置</span>'}</td>
                        <td>${user.is_admin ? '<span class="badge badge-success">是</span>' : '<span class="badge badge-secondary">否</span>'}</td>
                        <td>${roleName}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="icon-btn warning" data-tooltip="重置密码" onclick="openResetModal(${user.id}, '${user.username.replace(/'/g, "\\'")}')" title="重置密码"><i class="fa-solid fa-key"></i></button>
                                <button class="icon-btn secondary" data-tooltip="${user.email ? '修改邮箱' : '绑定邮箱'}" onclick="openBindEmailModal(${user.id}, '${user.username.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}', '${(user.email || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')" title="${user.email ? '修改邮箱' : '绑定邮箱'}"><i class="fa-solid fa-envelope"></i></button>
                                ${feishuEnabled ? `<button class="icon-btn secondary" data-tooltip="${user.feishu_open_id ? '已绑定' : '绑定飞书'}" onclick="openFeishuBindUserModal(${user.id}, '${(user.username || '').replace(/'/g, "\\'")}', '${(user.feishu_open_id || '').replace(/'/g, "\\'")}')" title="${user.feishu_open_id ? '已绑定' : '绑定飞书'}"><i class="fa-solid ${user.feishu_open_id ? 'fa-link' : 'fa-qrcode'}"></i></button>` : ''}
                                ${!isCurrentUser ? `<button class="icon-btn secondary" data-tooltip="设置角色" onclick="openSetUserRoleModal(${user.id}, '${user.username.replace(/'/g, "\\'")}', ${user.role_id || 'null'})" title="设置角色"><i class="fa-solid fa-user-tag"></i></button>` : ''}
                                ${!isCurrentUser ? `<button class="icon-btn info" data-tooltip="${user.is_admin ? '取消管理员' : '设为管理员'}" onclick="openSetAdminModal(${user.id}, '${user.username.replace(/'/g, "\\'")}', ${user.is_admin})" title="${user.is_admin ? '取消管理员' : '设为管理员'}"><i class="fa-solid fa-user-shield"></i></button>` : ''}
                                ${!isCurrentUser ? `
                                    ${!user.is_admin && canImpersonate ? `<button class="icon-btn info" data-tooltip="模拟登录" onclick="impersonateUser(${user.id}, '${user.username.replace(/'/g, "\\'")}')" title="模拟登录"><i class="fa-solid fa-user-secret"></i></button>` : ''}
                                    <button class="icon-btn danger" data-tooltip="删除" onclick="openDeleteUserModal(${user.id}, '${user.username.replace(/'/g, "\\'")}')" title="删除"><i class="fa-solid fa-trash"></i></button>
                                    <button class="icon-btn secondary" data-tooltip="${toggleText}" onclick="updateUserStatus(${user.id}, '${user.username.replace(/'/g, "\\'")}', '${nextStatus}')" title="${toggleText}"><i class="fa-solid ${user.status === 'locked' ? 'fa-lock-open' : 'fa-lock'}"></i></button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
            }
        }

        async function updateUserStatus(userId, username, status) {
            const actionText = status === 'active' ? '解锁' : '锁定';
            if (!confirm(`确定要${actionText}用户「${username}」吗？`)) return;
            try {
                const res = await fetch(`/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const data = await res.json();
                showToast(data.message || `${actionText}失败`, data.success ? 'success' : 'error');
                if (data.success) loadUsers();
            } catch (e) {
                showToast(`${actionText}失败`, 'error');
            }
        }

        function openResetModal(userId, username) {
            resetUserId = userId;
            document.getElementById('resetModalUser').textContent = username;
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal() { document.getElementById('resetModal').classList.remove('show'); resetUserId = null; }

        let bindEmailUserId = null;
        let bindEmailCurrentEmail = '';
        function openBindEmailModal(userId, username, currentEmail) {
            bindEmailUserId = userId;
            bindEmailCurrentEmail = currentEmail || '';
            document.getElementById('bindEmailModalUser').textContent = username;
            document.getElementById('bindEmailInput').value = bindEmailCurrentEmail;
            document.getElementById('bindEmailCodeInput').value = '';
            document.getElementById('bindEmailClearBtn').style.visibility = bindEmailCurrentEmail ? 'visible' : 'hidden';
            document.getElementById('bindEmailModal').classList.add('show');
        }
        function closeBindEmailModal() {
            document.getElementById('bindEmailModal').classList.remove('show');
            bindEmailUserId = null;
            bindEmailCurrentEmail = '';
        }
        (function bindEmailModalOverlay() {
            const modal = document.getElementById('bindEmailModal');
            if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) closeBindEmailModal(); });
        })();
        async function sendBindEmailCode() {
            const email = document.getElementById('bindEmailInput').value.trim();
            if (!email) { showToast('请先输入邮箱地址', 'warning'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('请输入有效的邮箱地址', 'warning'); return; }
            if (!bindEmailUserId) return;
            const btn = document.getElementById('bindEmailSendCodeBtn');
            btn.disabled = true;
            try {
                const res = await fetch('/admin/users/email/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: bindEmailUserId, email })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    let sec = 60;
                    const t = setInterval(function() {
                        btn.textContent = sec + '秒后重发';
                        if (--sec <= 0) { clearInterval(t); btn.disabled = false; btn.textContent = '发送验证码'; }
                    }, 1000);
                } else {
                    btn.disabled = false;
                }
            } catch (e) {
                showToast('发送失败', 'error');
                btn.disabled = false;
            }
        }
        async function confirmBindEmail() {
            const email = document.getElementById('bindEmailInput').value.trim();
            const code = document.getElementById('bindEmailCodeInput').value.trim();
            if (!email) { showToast('请先输入邮箱地址并发送验证码', 'warning'); return; }
            if (!code || code.length !== 6) { showToast('请输入6位验证码', 'warning'); return; }
            if (!bindEmailUserId) return;
            try {
                const res = await fetch(`/admin/users/${bindEmailUserId}/email`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeBindEmailModal();
                    loadUsers();
                }
            } catch (e) {
                showToast('操作失败', 'error');
            }
        }
        async function clearUserEmail() {
            if (!bindEmailUserId) return;
            if (!confirm('确定要清除该用户的邮箱吗？')) return;
            try {
                const res = await fetch(`/admin/users/${bindEmailUserId}/email`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: '', code: '' })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeBindEmailModal();
                    loadUsers();
                }
            } catch (e) {
                showToast('操作失败', 'error');
            }
        }

        async function confirmAdminReset() {
            const newPassword = document.getElementById('adminNewPassword').value;
            if (!newPassword || newPassword.length < 6) { showToast('密码至少需要6位', 'warning'); return; }
            try {
                const res = await fetch('/admin/password/admin-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: resetUserId, new_password: newPassword })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) closeResetModal();
            } catch (e) { showToast('重置失败', 'error'); }
        }

        async function sendResetEmail(userId) {
            if (!confirm('确定要发送密码重置邮件吗？')) return;
            try {
                const res = await fetch('/admin/password/send-reset-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
            } catch (e) { showToast('发送失败', 'error'); }
        }

        // 模拟登录用户
        async function impersonateUser(userId, username) {
            if (!confirm(`确定要模拟登录用户「${username}」吗？\n\n模拟登录后，您将以该用户的身份查看系统。`)) return;
            try {
                const res = await fetch('/admin/users/impersonate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();
                if (data.success) {
                    // 从响应中获取被模拟用户的ID并保存到 sessionStorage（不覆盖 localStorage）
                    if (data.data && data.data.user_id) {
                        sessionStorage.setItem('impersonated_user_id', data.data.user_id.toString());
                        console.log('模拟登录：保存用户ID到 sessionStorage:', data.data.user_id);
                    } else {
                        // 如果没有返回 user_id，使用传入的 userId 参数
                        sessionStorage.setItem('impersonated_user_id', userId.toString());
                        console.log('模拟登录：使用传入的用户ID保存到 sessionStorage:', userId);
                    }
                    showToast(data.message, 'success');
                    // 重新加载页面以更新状态
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || '模拟登录失败', 'error');
                }
            } catch (e) {
                showToast('模拟登录失败', 'error');
            }
        }

        // 退出模拟登录
        async function exitImpersonation() {
            if (!confirm('确定要退出模拟登录，恢复为管理员身份吗？')) return;
            try {
                const res = await fetch('/admin/users/exit-impersonation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    // 清除模拟登录的用户ID
                    sessionStorage.removeItem('impersonated_user_id');
                    showToast(data.message, 'success');
                    // 重新加载页面以更新状态
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || '退出模拟失败', 'error');
                }
            } catch (e) {
                showToast('退出模拟失败', 'error');
            }
        }


        let deleteUserId = null;
        let setAdminUserId = null;

        function openDeleteUserModal(userId, username) {
            deleteUserId = userId;
            document.getElementById('deleteUserModalUsername').textContent = username;
            document.getElementById('deleteUserModal').classList.add('show');
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('show');
            deleteUserId = null;
        }

        async function confirmDeleteUser() {
            if (!deleteUserId) return;
            try {
                const res = await fetch(`/admin/users/${deleteUserId}`, { method: 'DELETE' });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeDeleteUserModal();
                    loadUsers();
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        function openSetAdminModal(userId, username, currentIsAdmin) {
            setAdminUserId = userId;
            document.getElementById('setAdminModalUsername').textContent = username;
            document.getElementById('setAdminModalTitle').textContent = currentIsAdmin ? '取消管理员权限' : '设置管理员权限';
            document.getElementById('setAdminIsAdmin').value = currentIsAdmin ? 'true' : 'false';
            document.getElementById('setAdminModal').classList.add('show');
        }

        function closeSetAdminModal() {
            document.getElementById('setAdminModal').classList.remove('show');
            setAdminUserId = null;
        }

        let setUserRoleUserId = null;
        function openSetUserRoleModal(userId, username, currentRoleId) {
            setUserRoleUserId = userId;
            document.getElementById('setUserRoleModalUsername').textContent = username;
            const sel = document.getElementById('setUserRoleSelect');
            sel.innerHTML = '<option value="">无（清除角色）</option>' + (allRolesForUsers || []).map(r => 
                `<option value="${r.id}" ${currentRoleId === r.id ? 'selected' : ''}>${r.name || r.code}</option>`
            ).join('');
            document.getElementById('setUserRoleModal').classList.add('show');
        }
        function closeSetUserRoleModal() {
            document.getElementById('setUserRoleModal').classList.remove('show');
            setUserRoleUserId = null;
        }
        async function confirmSetUserRole() {
            if (!setUserRoleUserId) return;
            const sel = document.getElementById('setUserRoleSelect');
            const val = sel.value;
            const roleId = val === '' ? null : parseInt(val, 10);
            try {
                const res = await fetch(`/admin/users/${setUserRoleUserId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_id: roleId })
                });
                const data = await res.json();
                showToast(data.message || '操作完成', data.success ? 'success' : 'error');
                if (data.success) { closeSetUserRoleModal(); loadUsers(); }
            } catch (e) { showToast('请求失败', 'error'); }
        }
        (function bindSetUserRoleModalOverlay() {
            const modal = document.getElementById('setUserRoleModal');
            if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) closeSetUserRoleModal(); });
        })();

        async function confirmSetAdmin() {
            if (!setAdminUserId) return;
            const isAdmin = document.getElementById('setAdminIsAdmin').value === 'true';
            try {
                const res = await fetch(`/admin/users/${setAdminUserId}/admin`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_admin: isAdmin })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    closeSetAdminModal();
                    loadUsers();
                }
            } catch (e) {
                showToast('更新失败', 'error');
            }
        }

        function exportExcel() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            if (!startDate || !endDate) { showToast('请选择日期范围', 'warning'); return; }
            window.location.href = `/admin/export/excel?start_time=${startDate}&end_time=${endDate}`;
            showToast('正在生成 Excel...', 'success');
        }

        // ===== 角色/菜单/接口管理 =====
        let allRoles = [], allMenus = [], allAPIs = [];
        let editingRoleId = null, editingMenuId = null, editingAPIId = null;
        let assigningMenusRoleId = null, assigningAPIsMenuId = null;

        function loadRoles() { renderRolesPage(); }
        let rolePage = 1, rolePageSize = 15, roleTotalPages = 1;
        function resetRoleSearch() { const inp = document.getElementById('roleSearchKeyword'); if (inp) inp.value = ''; rolePage = 1; renderRolesTable(); }
        async function renderRolesPage() {
            try {
                const res = await fetch('/admin/roles');
                const data = await res.json();
                if (data.success) { allRoles = data.data || []; } else { allRoles = []; }
            } catch (e) { allRoles = []; }
            rolePage = 1;
            renderRolesTable();
        }
        function renderRolesTable() {
            const tbody = document.getElementById('rolesTable');
            if (!tbody) return;
            const kw = (document.getElementById('roleSearchKeyword')?.value || '').trim().toLowerCase();
            const list = (allRoles || []).filter(r => {
                if (!kw) return true;
                return ((r.name || '').toLowerCase().includes(kw)) || ((r.code || '').toLowerCase().includes(kw));
            });
            const total = list.length;
            roleTotalPages = Math.max(1, Math.ceil(total / rolePageSize));
            if (rolePage > roleTotalPages) rolePage = roleTotalPages;
            const start = (rolePage - 1) * rolePageSize;
            const pageList = list.slice(start, start + rolePageSize);
            if (!pageList.length) { tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--text-secondary);padding:40px;">${kw ? '未找到匹配的角色' : '暂无角色'}</td></tr>`; document.getElementById('rolePaginationInfo').textContent = '共 0 条记录'; document.getElementById('rolePaginationButtons').innerHTML = ''; return; }
            tbody.innerHTML = pageList.map(r => {
                const menuCnt = (r.menu_ids || []).length;
                return `<tr><td>${r.id}</td><td>${r.name || ''}</td><td><code>${r.code || ''}</code></td><td>${r.description || '-'}</td><td>${menuCnt}</td><td>${formatDateTime(r.created_at) || '-'}</td>
                <td><button class="btn btn-primary btn-sm" onclick="openEditRoleModal(${r.id})">编辑</button>
                <button class="btn btn-info btn-sm" onclick="openRoleMenusModal(${r.id})">分配菜单</button>
                <button class="btn btn-danger btn-sm" onclick="openDeleteRoleModal(${r.id})">删除</button></td></tr>`;
            }).join('');
            document.getElementById('rolePaginationInfo').textContent = `共 ${total} 条记录，第 ${rolePage} / ${roleTotalPages} 页`;
            const rb = document.getElementById('rolePaginationButtons');
            let rbHtml = `<button class="page-btn" onclick="goToRolePage(${rolePage - 1})" ${rolePage <= 1 ? 'disabled' : ''}>上一页</button>`;
            for (let i = 1; i <= roleTotalPages && i <= 5; i++) rbHtml += `<button class="page-btn ${rolePage === i ? 'active' : ''}" onclick="goToRolePage(${i})">${i}</button>`;
            if (roleTotalPages > 5) rbHtml += `<span style="padding: 8px;">...</span><button class="page-btn ${rolePage === roleTotalPages ? 'active' : ''}" onclick="goToRolePage(${roleTotalPages})">${roleTotalPages}</button>`;
            rbHtml += `<button class="page-btn" onclick="goToRolePage(${rolePage + 1})" ${rolePage >= roleTotalPages ? 'disabled' : ''}>下一页</button>`;
            rb.innerHTML = rbHtml;
        }
        function goToRolePage(page) { if (page < 1 || page > roleTotalPages) return; rolePage = page; renderRolesTable(); }

        function openRoleModal() { editingRoleId = null; document.getElementById('roleModalTitle').textContent = '添加角色'; document.getElementById('roleForm').reset(); document.getElementById('roleModal').classList.add('show'); }
        function openEditRoleModal(id) {
            const r = allRoles.find(x => x.id === id); if (!r) return;
            editingRoleId = id; document.getElementById('roleModalTitle').textContent = '编辑角色';
            document.getElementById('roleName').value = r.name || ''; document.getElementById('roleCode').value = r.code || ''; document.getElementById('roleDesc').value = r.description || '';
            document.getElementById('roleModal').classList.add('show');
        }
        function closeRoleModal() { document.getElementById('roleModal').classList.remove('show'); editingRoleId = null; }
        document.getElementById('roleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('roleName').value.trim(); const code = document.getElementById('roleCode').value.trim();
            if (!name || !code) { showToast('请填写名称和编码', 'warning'); return; }
            const body = { name, code, description: document.getElementById('roleDesc').value.trim() };
            const url = editingRoleId ? `/admin/roles/${editingRoleId}` : '/admin/roles';
            const method = editingRoleId ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { showToast('保存成功', 'success'); closeRoleModal(); renderRolesPage(); } else { showToast(data.message || '操作失败', 'error'); }
            } catch (err) { showToast('请求失败', 'error'); }
        });

        async function openRoleMenusModal(roleId) {
            assigningMenusRoleId = roleId;
            const role = allRoles.find(r => r.id === roleId);
            document.getElementById('roleMenusRoleName').textContent = role ? role.name : '';
            let checkedIds = new Set(role && role.menu_ids ? role.menu_ids : []);
            try { const rr = await fetch(`/admin/roles/${roleId}`); const rd = await rr.json(); if (rd.success && rd.data && rd.data.menu_ids) checkedIds = new Set(rd.data.menu_ids); } catch (_) {}
            const menuRes = await fetch('/admin/menus'); const tree = (await menuRes.json()).data || [];
            function flattenMenus(arr, out) { for (const m of arr || []) { out.push(m); if (m.children && m.children.length) flattenMenus(m.children, out); } }
            const allM = []; flattenMenus(tree, allM);
            document.getElementById('roleMenusCheckboxes').innerHTML = allM.map(m => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;"><input type="checkbox" value="${m.id}" ${checkedIds.has(m.id) ? 'checked' : ''}> ${m.name} <code style="font-size:12px;">${m.path || ''}</code></label>
            `).join('');
            document.getElementById('roleMenusModal').classList.add('show');
        }
        function closeRoleMenusModal() { document.getElementById('roleMenusModal').classList.remove('show'); assigningMenusRoleId = null; }
        (function bindRoleModalOverlay() { const m = document.getElementById('roleModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeRoleModal(); }); })();
        (function bindRoleMenusModalOverlay() { const m = document.getElementById('roleMenusModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeRoleMenusModal(); }); })();
        (function bindDeleteRoleModalOverlay() { const m = document.getElementById('deleteRoleModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeDeleteRoleModal(); }); })();
        async function saveRoleMenus() {
            if (!assigningMenusRoleId) return;
            const checkboxes = document.querySelectorAll('#roleMenusCheckboxes input[type=checkbox]:checked');
            const menuIds = Array.from(checkboxes).map(c => parseInt(c.value, 10));
            try {
                const res = await fetch(`/admin/roles/${assigningMenusRoleId}/menus`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ menu_ids: menuIds }) });
                const data = await res.json();
                if (data.success) { showToast('保存成功', 'success'); closeRoleMenusModal(); } else { showToast(data.message || '操作失败', 'error'); }
            } catch (err) { showToast('请求失败', 'error'); }
        }

        function loadMenus() { renderMenusPage(); }
        let menuPage = 1, menuPageSize = 15, menuTotalPages = 1;
        function resetMenuSearch() { const inp = document.getElementById('menuSearchKeyword'); if (inp) inp.value = ''; menuPage = 1; renderMenusTable(); }
        async function renderMenusPage() {
            try {
                const res = await fetch('/admin/menus');
                const data = await res.json();
                if (data.success) {
                    function flatten(arr, out, depth) { depth = depth || 0; for (const m of arr || []) { out.push({ ...m, _depth: depth }); if (m.children?.length) flatten(m.children, out, depth + 1); } }
                    allMenus = []; flatten(data.data || [], allMenus);
                } else allMenus = [];
            } catch (e) { allMenus = []; }
            menuPage = 1;
            renderMenusTable();
        }
        function renderMenusTable() {
            const tbody = document.getElementById('menusTable');
            if (!tbody) return;
            const kw = (document.getElementById('menuSearchKeyword')?.value || '').trim().toLowerCase();
            const list = (allMenus || []).filter(m => {
                if (!kw) return true;
                return ((m.name || '').toLowerCase().includes(kw)) || ((m.path || '').toLowerCase().includes(kw));
            });
            const total = list.length;
            menuTotalPages = Math.max(1, Math.ceil(total / menuPageSize));
            if (menuPage > menuTotalPages) menuPage = menuTotalPages;
            const start = (menuPage - 1) * menuPageSize;
            const pageList = list.slice(start, start + menuPageSize);
            if (!pageList.length) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-secondary);padding:40px;">${kw ? '未找到匹配的菜单' : '暂无菜单'}</td></tr>`; document.getElementById('menuPaginationInfo').textContent = '共 0 条记录'; document.getElementById('menuPaginationButtons').innerHTML = ''; return; }
            const flatAll = allMenus || [];
            const parentById = flatAll.reduce((a, m) => { a[m.id] = flatAll.find(p => p.id === m.parent_id); return a; }, {});
            const parentName = (m) => { const p = parentById[m.id] || flatAll.find(x => x.id === m.parent_id); return p ? p.name : '-'; };
            tbody.innerHTML = pageList.map(m => {
                const depth = m._depth || 0;
                const apiCnt = (m.apis || []).length;
                const pname = (m.parent_id && m.parent_id > 0) ? parentName(m) : '-';
                return `<tr><td>${m.id}</td><td style="padding-left:${depth * 16}px">${m.name || ''}</td><td><code>${m.path || ''}</code></td><td>${pname}</td><td>${m.icon || '-'}</td><td>${m.sort_order ?? 0}</td><td>${apiCnt}</td>
                <td><button class="btn btn-primary btn-sm" onclick="openEditMenuModal(${m.id})">编辑</button>
                <button class="btn btn-info btn-sm" onclick="openMenuAPIsModal(${m.id})">绑定接口</button>
                <button class="btn btn-danger btn-sm" onclick="openDeleteMenuModal(${m.id})">删除</button></td></tr>`;
            }).join('');
            document.getElementById('menuPaginationInfo').textContent = `共 ${total} 条记录，第 ${menuPage} / ${menuTotalPages} 页`;
            const mb = document.getElementById('menuPaginationButtons');
            let mbHtml = `<button class="page-btn" onclick="goToMenuPage(${menuPage - 1})" ${menuPage <= 1 ? 'disabled' : ''}>上一页</button>`;
            for (let i = 1; i <= menuTotalPages && i <= 5; i++) mbHtml += `<button class="page-btn ${menuPage === i ? 'active' : ''}" onclick="goToMenuPage(${i})">${i}</button>`;
            if (menuTotalPages > 5) mbHtml += `<span style="padding: 8px;">...</span><button class="page-btn ${menuPage === menuTotalPages ? 'active' : ''}" onclick="goToMenuPage(${menuTotalPages})">${menuTotalPages}</button>`;
            mbHtml += `<button class="page-btn" onclick="goToMenuPage(${menuPage + 1})" ${menuPage >= menuTotalPages ? 'disabled' : ''}>下一页</button>`;
            mb.innerHTML = mbHtml;
        }
        function goToMenuPage(page) { if (page < 1 || page > menuTotalPages) return; menuPage = page; renderMenusTable(); }

        function fillMenuParentOptions() {
            const sel = document.getElementById('menuParentId');
            if (!sel) return;
            const flat = allMenus || [];
            const excludeIds = new Set();
            if (editingMenuId) {
                excludeIds.add(editingMenuId);
                let changed = true;
                while (changed) { changed = false; for (const m of flat) { if (m.parent_id && excludeIds.has(m.parent_id) && !excludeIds.has(m.id)) { excludeIds.add(m.id); changed = true; } } }
            }
            sel.innerHTML = '<option value="0">无</option>' + flat.filter(m => !excludeIds.has(m.id)).map(m => `<option value="${m.id}">${(m.name || '')} (${m.path || ''})</option>`).join('');
        }
        function openMenuModal() { editingMenuId = null; document.getElementById('menuModalTitle').textContent = '添加菜单'; document.getElementById('menuForm').reset(); document.getElementById('menuSort').value = 0; fillMenuParentOptions(); document.getElementById('menuParentId').value = '0'; document.getElementById('menuModal').classList.add('show'); }
        function openEditMenuModal(id) {
            const m = allMenus.find(x => x.id === id); if (!m) return;
            editingMenuId = id; document.getElementById('menuModalTitle').textContent = '编辑菜单';
            document.getElementById('menuName').value = m.name || ''; document.getElementById('menuPath').value = m.path || ''; document.getElementById('menuIcon').value = m.icon || ''; document.getElementById('menuSort').value = m.sort_order ?? 0;
            fillMenuParentOptions(); document.getElementById('menuParentId').value = (m.parent_id && m.parent_id > 0) ? m.parent_id : '0';
            document.getElementById('menuModal').classList.add('show');
        }
        function closeMenuModal() { document.getElementById('menuModal').classList.remove('show'); editingMenuId = null; }
        document.getElementById('menuForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('menuName').value.trim(); const path = document.getElementById('menuPath').value.trim();
            if (!name || !path) { showToast('请填写名称和路径', 'warning'); return; }
            const pidVal = document.getElementById('menuParentId')?.value || '0';
            const parentId = parseInt(pidVal, 10) || 0;
            const body = { parent_id: parentId, name, path, icon: document.getElementById('menuIcon').value.trim(), sort_order: parseInt(document.getElementById('menuSort').value, 10) || 0 };
            const url = editingMenuId ? `/admin/menus/${editingMenuId}` : '/admin/menus'; const method = editingMenuId ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { showToast('保存成功', 'success'); closeMenuModal(); renderMenusPage(); } else { showToast(data.message || '操作失败', 'error'); }
            } catch (err) { showToast('请求失败', 'error'); }
        });

        async function openMenuAPIsModal(menuId) {
            assigningAPIsMenuId = menuId;
            const menu = allMenus.find(m => m.id === menuId);
            document.getElementById('menuAPIsMenuName').textContent = menu ? menu.name : '';
            const currentIds = (menu && menu.apis) ? menu.apis.map(a => a.id) : [];
            const apisRes = await fetch('/admin/apis'); const apisData = await apisRes.json();
            const apis = apisData.success ? apisData.data || [] : [];
            const ckSet = new Set(currentIds);
            document.getElementById('menuAPIsCheckboxes').innerHTML = apis.map(a => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;"><input type="checkbox" value="${a.id}" ${ckSet.has(a.id) ? 'checked' : ''}> ${a.method} ${a.path} ${a.desc ? '(' + a.desc + ')' : ''}</label>
            `).join('');
            document.getElementById('menuAPIsModal').classList.add('show');
        }
        function closeMenuAPIsModal() { document.getElementById('menuAPIsModal').classList.remove('show'); assigningAPIsMenuId = null; }
        (function bindMenuModalOverlay() { const m = document.getElementById('menuModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeMenuModal(); }); })();
        (function bindMenuAPIsModalOverlay() { const m = document.getElementById('menuAPIsModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeMenuAPIsModal(); }); })();
        (function bindDeleteMenuModalOverlay() { const m = document.getElementById('deleteMenuModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeDeleteMenuModal(); }); })();
        async function saveMenuAPIs() {
            if (!assigningAPIsMenuId) return;
            const checkboxes = document.querySelectorAll('#menuAPIsCheckboxes input[type=checkbox]:checked');
            const apiIds = Array.from(checkboxes).map(c => parseInt(c.value, 10));
            try {
                const res = await fetch(`/admin/menus/${assigningAPIsMenuId}/apis`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ api_ids: apiIds }) });
                const data = await res.json();
                if (data.success) { showToast('保存成功', 'success'); closeMenuAPIsModal(); } else { showToast(data.message || '操作失败', 'error'); }
            } catch (err) { showToast('请求失败', 'error'); }
        }

        function loadAPIs() { renderAPIsPage(); }
        let apiPage = 1, apiPageSize = 15, apiTotalPages = 1;
        function resetAPISearch() { const m = document.getElementById('apiSearchMethod'); const p = document.getElementById('apiSearchPath'); if (m) m.value = ''; if (p) p.value = ''; apiPage = 1; renderAPIsTable(); }
        async function renderAPIsPage() {
            try {
                const res = await fetch('/admin/apis');
                const data = await res.json();
                if (data.success) allAPIs = data.data || []; else allAPIs = [];
            } catch (e) { allAPIs = []; }
            apiPage = 1;
            renderAPIsTable();
        }
        function renderAPIsTable() {
            const tbody = document.getElementById('apisTable');
            if (!tbody) return;
            const methodKw = (document.getElementById('apiSearchMethod')?.value || '').trim().toLowerCase();
            const pathKw = (document.getElementById('apiSearchPath')?.value || '').trim().toLowerCase();
            const list = (allAPIs || []).filter(a => {
                if (methodKw && !(a.method || '').toLowerCase().includes(methodKw)) return false;
                if (pathKw && !(a.path || '').toLowerCase().includes(pathKw)) return false;
                return true;
            });
            const total = list.length;
            apiTotalPages = Math.max(1, Math.ceil(total / apiPageSize));
            if (apiPage > apiTotalPages) apiPage = apiTotalPages;
            const start = (apiPage - 1) * apiPageSize;
            const pageList = list.slice(start, start + apiPageSize);
            if (!pageList.length) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px;">${(methodKw || pathKw) ? '未找到匹配的接口' : '暂无接口'}</td></tr>`; document.getElementById('apiPaginationInfo').textContent = '共 0 条记录'; document.getElementById('apiPaginationButtons').innerHTML = ''; return; }
            tbody.innerHTML = pageList.map(a => `
                <tr><td>${a.id}</td><td><code>${a.method || ''}</code></td><td><code>${a.path || ''}</code></td><td>${a.desc || '-'}</td><td>${formatDateTime(a.created_at) || '-'}</td>
                <td><button class="btn btn-primary btn-sm" onclick="openEditAPIModal(${a.id})">编辑</button>
                <button class="btn btn-danger btn-sm" onclick="openDeleteAPIModal(${a.id})">删除</button></td></tr>
            `).join('');
            document.getElementById('apiPaginationInfo').textContent = `共 ${total} 条记录，第 ${apiPage} / ${apiTotalPages} 页`;
            const ab = document.getElementById('apiPaginationButtons');
            let abHtml = `<button class="page-btn" onclick="goToAPIPage(${apiPage - 1})" ${apiPage <= 1 ? 'disabled' : ''}>上一页</button>`;
            for (let i = 1; i <= apiTotalPages && i <= 5; i++) abHtml += `<button class="page-btn ${apiPage === i ? 'active' : ''}" onclick="goToAPIPage(${i})">${i}</button>`;
            if (apiTotalPages > 5) abHtml += `<span style="padding: 8px;">...</span><button class="page-btn ${apiPage === apiTotalPages ? 'active' : ''}" onclick="goToAPIPage(${apiTotalPages})">${apiTotalPages}</button>`;
            abHtml += `<button class="page-btn" onclick="goToAPIPage(${apiPage + 1})" ${apiPage >= apiTotalPages ? 'disabled' : ''}>下一页</button>`;
            ab.innerHTML = abHtml;
        }
        function goToAPIPage(page) { if (page < 1 || page > apiTotalPages) return; apiPage = page; renderAPIsTable(); }

        function openAPIModal() { editingAPIId = null; document.getElementById('apiModalTitle').textContent = '添加接口'; document.getElementById('apiForm').reset(); document.getElementById('apiModal').classList.add('show'); }
        function openEditAPIModal(id) {
            const a = allAPIs.find(x => x.id === id); if (!a) return;
            editingAPIId = id; document.getElementById('apiModalTitle').textContent = '编辑接口';
            document.getElementById('apiMethod').value = a.method || 'GET'; document.getElementById('apiPath').value = a.path || ''; document.getElementById('apiDesc').value = a.desc || '';
            document.getElementById('apiModal').classList.add('show');
        }
        function closeAPIModal() { document.getElementById('apiModal').classList.remove('show'); editingAPIId = null; }
        (function bindAPIModalOverlay() { const m = document.getElementById('apiModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeAPIModal(); }); })();
        (function bindDeleteAPIModalOverlay() { const m = document.getElementById('deleteAPIModal'); if (m) m.addEventListener('click', (e) => { if (e.target === m) closeDeleteAPIModal(); }); })();
        document.getElementById('apiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const method = document.getElementById('apiMethod').value; const path = document.getElementById('apiPath').value.trim();
            if (!path) { showToast('请填写路径', 'warning'); return; }
            const body = { method, path, desc: document.getElementById('apiDesc').value.trim() };
            const url = editingAPIId ? `/admin/apis/${editingAPIId}` : '/admin/apis'; const method2 = editingAPIId ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, { method: method2, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) { showToast('保存成功', 'success'); closeAPIModal(); renderAPIsPage(); } else { showToast(data.message || '操作失败', 'error'); }
            } catch (err) { showToast('请求失败', 'error'); }
        });

        let deleteRoleId = null;
        function openDeleteRoleModal(id) { deleteRoleId = id; const r = (allRoles || []).find(x => x.id === id); const el = document.getElementById('deleteRoleModalName'); if (el) el.textContent = (r && r.name) || '#' + id; document.getElementById('deleteRoleModal').classList.add('show'); }
        function closeDeleteRoleModal() { deleteRoleId = null; document.getElementById('deleteRoleModal').classList.remove('show'); }
        async function confirmDeleteRole() { if (!deleteRoleId) return; try { const res = await fetch(`/admin/roles/${deleteRoleId}`, { method: 'DELETE' }); const data = await res.json(); if (data.success) { showToast('删除成功', 'success'); closeDeleteRoleModal(); renderRolesPage(); } else showToast(data.message || '删除失败', 'error'); } catch (e) { showToast('请求失败', 'error'); } }
        let deleteMenuId = null;
        function openDeleteMenuModal(id) { deleteMenuId = id; const m = (allMenus || []).find(x => x.id === id); const el = document.getElementById('deleteMenuModalName'); if (el) el.textContent = (m && m.name) || '#' + id; document.getElementById('deleteMenuModal').classList.add('show'); }
        function closeDeleteMenuModal() { deleteMenuId = null; document.getElementById('deleteMenuModal').classList.remove('show'); }
        async function confirmDeleteMenu() { if (!deleteMenuId) return; try { const res = await fetch(`/admin/menus/${deleteMenuId}`, { method: 'DELETE' }); const data = await res.json(); if (data.success) { showToast('删除成功', 'success'); closeDeleteMenuModal(); renderMenusPage(); } else showToast(data.message || '删除失败', 'error'); } catch (e) { showToast('请求失败', 'error'); } }
        let deleteAPIId = null;
        function openDeleteAPIModal(id) { deleteAPIId = id; const a = (allAPIs || []).find(x => x.id === id); const mel = document.getElementById('deleteAPIModalMethod'); const pel = document.getElementById('deleteAPIModalPath'); if (mel) mel.textContent = a ? (a.method || '') : ''; if (pel) pel.textContent = a ? (a.path || '') : '#' + id; document.getElementById('deleteAPIModal').classList.add('show'); }
        function closeDeleteAPIModal() { deleteAPIId = null; document.getElementById('deleteAPIModal').classList.remove('show'); }
        async function confirmDeleteAPI() { if (!deleteAPIId) return; try { const res = await fetch(`/admin/apis/${deleteAPIId}`, { method: 'DELETE' }); const data = await res.json(); if (data.success) { showToast('删除成功', 'success'); closeDeleteAPIModal(); renderAPIsPage(); } else showToast(data.message || '删除失败', 'error'); } catch (e) { showToast('请求失败', 'error'); } }

        async function loadCategories() {
            await loadCategoriesFromServer();
            renderCategoriesTable();
            // 同步刷新账单页面下拉
            renderCategoryOptions(document.getElementById('filterCategory'), true);
            renderCategoryOptions(document.getElementById('expenseCategory'), false);
        }

        function resetCategorySearch() {
            const input = document.getElementById('categorySearchName');
            if (input) input.value = '';
            renderCategoriesTable();
        }

        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTable');
            if (!tbody) return;
            const keyword = (document.getElementById('categorySearchName')?.value || '').trim().toLowerCase();
            const list = (allCategories || []).filter(c => {
                if (!keyword) return true;
                const name = (c.name || '').toLowerCase();
                return name.includes(keyword);
            });
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:40px;">${keyword ? '未找到匹配的类别' : '暂无类别'}</td></tr>`;
                return;
            }
            tbody.innerHTML = list.map(c => {
                const color = c.color || '#64748b';
                const escapedName = (c.name || '').replace(/'/g, "\\'");
                return `
                <tr>
                    <td>${c.id}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="category-tag" style="background: ${hexToRgba(color, 0.15)}; color: ${color};">${c.name}</span>
                        </div>
                    </td>
                    <td>${c.sort ?? 0}</td>
                    <td>${formatDateTime(c.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="openEditCategoryModal(${c.id}, '${escapedName}', ${c.sort ?? 0}, '${color}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteCategoryModal(${c.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function openCategoryModal() {
            editingCategoryId = null;
            document.getElementById('categoryModalTitle').textContent = '➕ 添加消费类别';
            document.getElementById('categoryModalSubtitle').textContent = '维护类别名称与排序';
            document.getElementById('categorySubmitBtn').textContent = '确认添加';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryColor').value = '#64748b';
            document.getElementById('categoryColorText').value = '#64748b';
            document.getElementById('categoryModal').classList.add('show');
        }
        
        // 颜色工具函数
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        // 根据类别名称获取颜色
        function getCategoryColor(categoryName) {
            const category = allCategories.find(c => c.name === categoryName);
            return category?.color || '#64748b';
        }

        function openEditCategoryModal(id, name, sort, color) {
            editingCategoryId = id;
            document.getElementById('categoryModalTitle').textContent = '✏️ 编辑消费类别';
            document.getElementById('categoryModalSubtitle').textContent = `编辑 ID: ${id}`;
            document.getElementById('categorySubmitBtn').textContent = '保存修改';
            document.getElementById('categoryName').value = name || '';
            document.getElementById('categorySort').value = (sort ?? 0);
            const categoryColor = color || '#64748b';
            document.getElementById('categoryColor').value = categoryColor;
            document.getElementById('categoryColorText').value = categoryColor;
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
            editingCategoryId = null;
        }

        // 颜色选择器同步
        document.getElementById('categoryColor').addEventListener('input', function() {
            document.getElementById('categoryColorText').value = this.value;
        });
        document.getElementById('categoryColorText').addEventListener('input', function() {
            const colorValue = this.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(colorValue)) {
                document.getElementById('categoryColor').value = colorValue;
            }
        });

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = (document.getElementById('categoryName').value || '').trim();
            const sortStr = document.getElementById('categorySort').value;
            const sort = sortStr === '' ? 0 : parseInt(sortStr, 10);
            const color = (document.getElementById('categoryColorText').value || '#64748b').trim();
            if (!name) { showToast('请输入类别名称', 'warning'); return; }
            if (!/^#[0-9A-Fa-f]{6}$/.test(color)) { showToast('颜色格式不正确，请使用 #RRGGBB 格式', 'warning'); return; }

            try {
                let res;
                if (editingCategoryId) {
                    res = await fetch(`/admin/categories/${editingCategoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort, color })
                    });
                } else {
                    res = await fetch('/admin/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort, color })
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || '成功', 'success');
                    closeCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message || '失败', 'error');
                }
            } catch (err) {
                showToast('操作失败', 'error');
            }
        });

        function openDeleteCategoryModal(id) {
            deleteCategoryId = id;
            document.getElementById('deleteCategoryModal').classList.add('show');
        }

        function closeDeleteCategoryModal() {
            document.getElementById('deleteCategoryModal').classList.remove('show');
            deleteCategoryId = null;
        }

        async function confirmDeleteCategory() {
            if (!deleteCategoryId) return;
            try {
                const res = await fetch(`/admin/categories/${deleteCategoryId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    closeDeleteCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        // ===== 收入类别管理功能 =====
        async function loadIncomeCategories() {
            await loadIncomeCategoriesFromServer();
            renderIncomeCategoriesTable();
            renderIncomeCategoryOptions(document.getElementById('incomeType'));
            renderIncomeCategoryOptions(document.getElementById('incomeFilterType'), true);
        }

        function resetIncomeCategorySearch() {
            const input = document.getElementById('incomeCategorySearchName');
            if (input) input.value = '';
            renderIncomeCategoriesTable();
        }

        function renderIncomeCategoriesTable() {
            const tbody = document.getElementById('incomeCategoriesTable');
            if (!tbody) return;
            const keyword = (document.getElementById('incomeCategorySearchName')?.value || '').trim().toLowerCase();
            const list = (allIncomeCategories || []).filter(c => {
                if (!keyword) return true;
                const name = (c.name || '').toLowerCase();
                return name.includes(keyword);
            });
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:40px;">${keyword ? '未找到匹配的类别' : '暂无类别'}</td></tr>`;
                return;
            }
            tbody.innerHTML = list.map(c => {
                const color = c.color || '#64748b';
                const escapedName = (c.name || '').replace(/'/g, "\\'");
                return `
                <tr>
                    <td>${c.id}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="category-tag" style="background: ${hexToRgba(color, 0.15)}; color: ${color};">${c.name}</span>
                        </div>
                    </td>
                    <td>${c.sort ?? 0}</td>
                    <td>${formatDateTime(c.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="openEditIncomeCategoryModal(${c.id}, '${escapedName}', ${c.sort ?? 0}, '${color}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteIncomeCategoryModal(${c.id})">删除</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function openIncomeCategoryModal() {
            editingIncomeCategoryId = null;
            document.getElementById('incomeCategoryModalTitle').textContent = '➕ 添加收入类别';
            document.getElementById('incomeCategoryModalSubtitle').textContent = '维护类别名称与排序';
            document.getElementById('incomeCategorySubmitBtn').textContent = '确认添加';
            document.getElementById('incomeCategoryForm').reset();
            document.getElementById('incomeCategoryColor').value = '#64748b';
            document.getElementById('incomeCategoryColorText').value = '#64748b';
            document.getElementById('incomeCategoryModal').classList.add('show');
        }

        function openEditIncomeCategoryModal(id, name, sort, color) {
            editingIncomeCategoryId = id;
            document.getElementById('incomeCategoryModalTitle').textContent = '✏️ 编辑收入类别';
            document.getElementById('incomeCategoryModalSubtitle').textContent = `编辑 ID: ${id}`;
            document.getElementById('incomeCategorySubmitBtn').textContent = '保存修改';
            document.getElementById('incomeCategoryName').value = name || '';
            document.getElementById('incomeCategorySort').value = (sort ?? 0);
            const categoryColor = color || '#64748b';
            document.getElementById('incomeCategoryColor').value = categoryColor;
            document.getElementById('incomeCategoryColorText').value = categoryColor;
            document.getElementById('incomeCategoryModal').classList.add('show');
        }

        function closeIncomeCategoryModal() {
            document.getElementById('incomeCategoryModal').classList.remove('show');
            editingIncomeCategoryId = null;
        }

        document.getElementById('incomeCategoryColor').addEventListener('input', function() {
            document.getElementById('incomeCategoryColorText').value = this.value;
        });
        document.getElementById('incomeCategoryColorText').addEventListener('input', function() {
            const colorValue = this.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(colorValue)) {
                document.getElementById('incomeCategoryColor').value = colorValue;
            }
        });

        document.getElementById('incomeCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = (document.getElementById('incomeCategoryName').value || '').trim();
            const sortStr = document.getElementById('incomeCategorySort').value;
            const sort = sortStr === '' ? 0 : parseInt(sortStr, 10);
            const color = (document.getElementById('incomeCategoryColorText').value || '#64748b').trim();
            if (!name) { showToast('请输入类别名称', 'warning'); return; }
            if (!/^#[0-9A-Fa-f]{6}$/.test(color)) { showToast('颜色格式不正确，请使用 #RRGGBB 格式', 'warning'); return; }

            try {
                let res;
                if (editingIncomeCategoryId) {
                    res = await fetch(`/admin/income-categories/${editingIncomeCategoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort, color })
                    });
                } else {
                    res = await fetch('/admin/income-categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort, color })
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || '成功', 'success');
                    closeIncomeCategoryModal();
                    loadIncomeCategories();
                } else {
                    showToast(data.message || '失败', 'error');
                }
            } catch (err) {
                showToast('操作失败', 'error');
            }
        });

        function openDeleteIncomeCategoryModal(id) {
            deleteIncomeCategoryId = id;
            document.getElementById('deleteIncomeCategoryModal').classList.add('show');
        }

        function closeDeleteIncomeCategoryModal() {
            document.getElementById('deleteIncomeCategoryModal').classList.remove('show');
            deleteIncomeCategoryId = null;
        }

        async function confirmDeleteIncomeCategory() {
            if (!deleteIncomeCategoryId) return;
            try {
                const res = await fetch(`/admin/income-categories/${deleteIncomeCategoryId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    closeDeleteIncomeCategoryModal();
                    loadIncomeCategories();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        async function loadIncomeCategoriesFromServer() {
            try {
                const res = await fetch('/admin/income-categories');
                const data = await res.json();
                if (data.success) {
                    allIncomeCategories = data.data || [];
                } else {
                    allIncomeCategories = [];
                }
            } catch (e) {
                allIncomeCategories = [];
            }
            return allIncomeCategories;
        }

        function renderIncomeCategoryOptions(selectEl, includeAll = false) {
            if (!selectEl) return;
            const current = selectEl.value;
            let html = includeAll ? '<option value="">全部类型</option>' : '<option value="">请选择类别</option>';
            html += (allIncomeCategories || []).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            selectEl.innerHTML = html;
            if (current) selectEl.value = current;
        }

        // ===== 收入管理功能 =====
        async function loadUsersForIncomeSelect() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('incomeUserId');
                    if (select && isAdmin) {
                        select.innerHTML = '<option value="">请选择用户</option>' +
                            (data.data || []).map(u => `<option value="${u.id}">${u.username}</option>`).join('');
                    } else if (select && !isAdmin) {
                        // 优先从变量获取，如果没有则从 localStorage 获取
                        let userIdToSet = currentUserId;
                        if (!userIdToSet) {
                            const savedUserId = localStorage.getItem('admin_user_id');
                            if (savedUserId) {
                                userIdToSet = parseInt(savedUserId);
                                currentUserId = userIdToSet;
                            }
                        }
                        if (userIdToSet) {
                            select.innerHTML = `<option value="${userIdToSet}">${currentUsername}</option>`;
                            select.value = userIdToSet;
                        }
                    }
                }
            } catch (e) {}
        }

        async function openIncomeModal() {
            editingIncomeId = null;
            document.getElementById('incomeModalTitle').textContent = '➕ 添加收入';
            document.getElementById('incomeModalSubtitle').textContent = '填写收入信息';
            document.getElementById('incomeSubmitBtn').textContent = '确认添加';
            
            // 根据权限处理用户选择
            const incomeUserId = document.getElementById('incomeUserId');
            let userIdToSet = null;
            if (!isAdmin) {
                // 非管理员：移除 required 属性并获取当前用户ID
                incomeUserId.required = false;
                
                // 对于非管理员，总是从服务器获取用户ID，确保准确性
                // 这样可以处理模拟登录的情况（original_admin_id cookie 是 HttpOnly，无法读取）
                console.log('非管理员（收入）：从服务器获取用户ID，currentUsername:', currentUsername, 'currentUserId:', currentUserId);
                currentUserId = null; // 清除旧的用户ID，强制从服务器获取
                await loadCurrentUserIdFromServer();
                if (currentUserId) {
                    userIdToSet = currentUserId;
                    console.log('非管理员（收入）：获取用户ID为:', userIdToSet);
                } else {
                    console.error('非管理员（收入）：无法获取当前用户ID，currentUsername:', currentUsername);
                    // 如果服务器获取失败，尝试从 localStorage 获取（降级方案）
                    const savedUserId = localStorage.getItem('admin_user_id');
                    if (savedUserId) {
                        userIdToSet = parseInt(savedUserId);
                        currentUserId = userIdToSet;
                        console.log('非管理员（收入）：使用 localStorage 中的用户ID:', userIdToSet);
                    }
                }
            } else {
                // 管理员：需要选择用户
                incomeUserId.required = true;
            }
            
            document.getElementById('incomeForm').reset();
            
            const now = new Date();
            document.getElementById('incomeTime').value = formatDateTimeLocal(now);
            
            // 重置后重新设置用户ID（非管理员）
            if (!isAdmin && userIdToSet) {
                incomeUserId.value = userIdToSet;
            }
            
            loadUsersForIncomeSelect();
            await loadIncomeCategoriesFromServer();
            renderIncomeCategoryOptions(document.getElementById('incomeType'));
            document.getElementById('incomeModal').classList.add('show');
        }

        async function openEditIncomeModal(id, userId, amount, type, incomeTime) {
            editingIncomeId = id;
            document.getElementById('incomeModalTitle').textContent = '✏️ 编辑收入';
            document.getElementById('incomeModalSubtitle').textContent = `编辑 ID: ${id}`;
            document.getElementById('incomeSubmitBtn').textContent = '保存修改';
            document.getElementById('incomeAmount').value = amount;
            document.getElementById('incomeTime').value = formatDateTimeLocal(incomeTime);
            loadUsersForIncomeSelect();
            await loadIncomeCategoriesFromServer();
            renderIncomeCategoryOptions(document.getElementById('incomeType'));
            document.getElementById('incomeType').value = type || '';
            setTimeout(() => { document.getElementById('incomeUserId').value = userId; }, 80);
            document.getElementById('incomeModal').classList.add('show');
        }

        function closeIncomeModal() {
            document.getElementById('incomeModal').classList.remove('show');
            editingIncomeId = null;
        }

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // 对于非管理员，自动获取当前用户ID
            let userId = parseInt(document.getElementById('incomeUserId').value);
            if ((!userId || isNaN(userId)) && !isAdmin) {
                // 优先从变量获取，如果没有则从 localStorage 获取
                if (currentUserId) {
                    userId = currentUserId;
                } else {
                    const savedUserId = localStorage.getItem('admin_user_id');
                    if (savedUserId) {
                        userId = parseInt(savedUserId);
                        currentUserId = userId;
                    } else {
                        // 如果都没有，尝试从服务器获取
                        await loadCurrentUserIdFromServer();
                        if (currentUserId) {
                            userId = currentUserId;
                        }
                    }
                }
            }
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const type = (document.getElementById('incomeType').value || '').trim();
            const timeStr = document.getElementById('incomeTime').value;
            if (!userId || isNaN(userId) || !amount || !type || !timeStr) {
                showToast('请填写所有必填项', 'warning');
                return;
            }
            const payload = {
                user_id: userId,
                amount: amount,
                type: type,
                income_time: formatDateTimeForApi(timeStr)
            };
            try {
                let res;
                if (editingIncomeId) {
                    res = await fetch(`/admin/incomes/${editingIncomeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    res = await fetch('/admin/incomes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || '成功', 'success');
                    closeIncomeModal();
                    loadIncomes();
                    loadStatistics();
                } else {
                    showToast(data.message || '失败', 'error');
                }
            } catch (e) {
                showToast('操作失败', 'error');
            }
        });

        async function loadIncomes() {
            const params = new URLSearchParams({ page: incomeCurrentPage, page_size: 15 });
            const startDate = document.getElementById('incomeFilterStartDate').value;
            const endDate = document.getElementById('incomeFilterEndDate').value;
            const type = document.getElementById('incomeFilterType').value;
            // 使用user_id而不是username（仅管理员）
            if (isAdmin) {
                const userId = document.getElementById('incomeFilterUserId')?.value || '';
                if (userId) {
                    params.append('user_id', userId);
                }
            }
            if (startDate) params.append('start_time', startDate);
            if (endDate) params.append('end_time', endDate);
            if (type) params.append('type', type);
            try {
                const res = await fetch(`/admin/incomes?${params}`);
                const data = await res.json();
                if (data.success) renderIncomesTable(data.data);
            } catch (e) {}
        }

        function renderIncomesTable(data) {
            const tbody = document.getElementById('incomesTable');
            if (!data.list || data.list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px;">暂无收入记录</td></tr>';
            } else {
                tbody.innerHTML = data.list.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.username || '-'}</td>
                        <td class="amount" style="color: var(--success);">¥${item.amount.toFixed(2)}</td>
                        <td>${item.type || '-'}</td>
                        <td>${formatDateTime(item.income_time)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditIncomeModal(${item.id}, ${item.user_id}, ${item.amount}, ${JSON.stringify(item.type || '')}, ${JSON.stringify(item.income_time)})">编辑</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteIncomeModal(${item.id})">删除</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            incomeTotalPages = Math.ceil(data.total / data.page_size) || 1;
            document.getElementById('incomePaginationInfo').textContent = `共 ${data.total} 条记录，第 ${data.page} / ${incomeTotalPages} 页`;
            renderIncomePagination();
        }

        function renderIncomePagination() {
            const container = document.getElementById('incomePaginationButtons');
            let html = `<button class="page-btn" onclick="goToIncomePage(${incomeCurrentPage - 1})" ${incomeCurrentPage <= 1 ? 'disabled' : ''}>上一页</button>`;
            html += `<button class="page-btn" onclick="goToIncomePage(${incomeCurrentPage + 1})" ${incomeCurrentPage >= incomeTotalPages ? 'disabled' : ''}>下一页</button>`;
            container.innerHTML = html;
        }

        function goToIncomePage(page) {
            if (page < 1 || page > incomeTotalPages) return;
            incomeCurrentPage = page;
            loadIncomes();
        }

        function resetIncomeFilters() {
            document.getElementById('incomeFilterType').value = '';
            if (isAdmin) {
                const incomeFilterUserId = document.getElementById('incomeFilterUserId');
                if (incomeFilterUserId) incomeFilterUserId.value = '';
            }
            document.getElementById('incomeFilterStartDate').value = '';
            document.getElementById('incomeFilterEndDate').value = '';
            incomeCurrentPage = 1;
            setDefaultIncomeDates();
            loadIncomes();
        }

        function openDeleteIncomeModal(id) {
            deleteIncomeId = id;
            document.getElementById('deleteIncomeModal').classList.add('show');
        }

        function closeDeleteIncomeModal() {
            document.getElementById('deleteIncomeModal').classList.remove('show');
            deleteIncomeId = null;
        }

        async function confirmDeleteIncome() {
            if (!deleteIncomeId) return;
            try {
                const res = await fetch(`/admin/incomes/${deleteIncomeId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    closeDeleteIncomeModal();
                    loadIncomes();
                    loadStatistics();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function formatDateTime(str) { if (!str) return '-'; return new Date(str).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }
        function formatDateTimeLocal(str) {
            if (!str) return '';
            const d = new Date(str);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        function formatDateTimeForApi(str) {
            if (!str) return '';
            const d = new Date(str);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift(); return null; }
        function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 1500); }

        // ===== 消费记录管理功能 =====
        async function loadUsersForSelect() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    allUsers = data.data;
                    const select = document.getElementById('expenseUserId');
                    select.innerHTML = '<option value="">请选择用户</option>' + 
                        allUsers.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
                }
            } catch (e) { console.error('加载用户列表失败:', e); }
        }

        async function loadCategoriesFromServer() {
            try {
                const res = await fetch('/admin/categories');
                const data = await res.json();
                if (data.success) {
                    allCategories = data.data || [];
                } else {
                    allCategories = [];
                }
            } catch (e) {
                allCategories = [];
            }
            return allCategories;
        }

        function renderCategoryOptions(selectEl, includeAll = false) {
            if (!selectEl) return;
            const current = selectEl.value;
            let html = includeAll ? '<option value="">全部类别</option>' : '<option value="">请选择类别</option>';
            html += (allCategories || []).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            selectEl.innerHTML = html;
            if (current) selectEl.value = current;
        }

        async function refreshExpenseCategorySelectors() {
            await loadCategoriesFromServer();
            renderCategoryOptions(document.getElementById('filterCategory'), true);
            renderCategoryOptions(document.getElementById('expenseCategory'), false);
        }

        async function openExpenseModal() {
            editingExpenseId = null;
            document.getElementById('expenseModalTitle').textContent = '➕ 添加消费记录';
            document.getElementById('expenseModalSubtitle').textContent = '填写消费记录信息';
            document.getElementById('expenseSubmitBtn').textContent = '确认添加';
            
            // 根据权限处理用户选择（在重置之前设置，避免被重置清除）
            const expenseUserId = document.getElementById('expenseUserId');
            let userIdToSet = null;
            if (!isAdmin) {
                // 非管理员：移除 required 属性并获取当前用户ID
                expenseUserId.required = false;
                
                // 检查是否在模拟登录状态（通过 sessionStorage）
                const impersonatedUserId = sessionStorage.getItem('impersonated_user_id');
                const isImpersonating = impersonatedUserId && impersonatedUserId !== '';
                
                if (isImpersonating) {
                    // 模拟登录时，优先使用 sessionStorage 中的用户ID
                    userIdToSet = parseInt(impersonatedUserId);
                    currentUserId = userIdToSet;
                    console.log('模拟登录：使用 sessionStorage 中的用户ID:', userIdToSet);
                    // 同时从服务器验证一次，确保准确性
                    await loadCurrentUserIdFromServer();
                    if (currentUserId && currentUserId !== userIdToSet) {
                        console.warn('模拟登录：服务器返回的用户ID与 sessionStorage 不一致，使用服务器返回的ID');
                        userIdToSet = currentUserId;
                    }
                } else {
                    // 正常登录时，从服务器获取用户ID
                    console.log('非管理员：从服务器获取用户ID，currentUsername:', currentUsername, 'currentUserId:', currentUserId);
                    if (!currentUserId) {
                        await loadCurrentUserIdFromServer();
                    }
                    if (currentUserId) {
                        userIdToSet = currentUserId;
                        console.log('非管理员：获取用户ID为:', userIdToSet);
                    } else {
                        console.error('非管理员：无法获取当前用户ID，currentUsername:', currentUsername);
                        // 如果服务器获取失败，尝试从 localStorage 获取（降级方案）
                        const savedUserId = localStorage.getItem('admin_user_id');
                        if (savedUserId) {
                            userIdToSet = parseInt(savedUserId);
                            currentUserId = userIdToSet;
                            console.log('非管理员：使用 localStorage 中的用户ID:', userIdToSet);
                        }
                    }
                }
            } else {
                // 管理员：需要选择用户
                expenseUserId.required = true;
            }
            
            document.getElementById('expenseForm').reset();
            
            // 设置默认时间为当前时间
            const now = new Date();
            document.getElementById('expenseTime').value = formatDateTimeLocal(now);
            
            // 重置后重新设置用户ID（非管理员）
            if (!isAdmin && userIdToSet) {
                expenseUserId.value = userIdToSet;
                console.log('非管理员：设置用户ID为:', userIdToSet);
            } else if (isAdmin) {
                loadUsersForSelect();
            }
            
            // 确保非管理员时 required 属性被移除
            if (!isAdmin) {
                expenseUserId.required = false;
            }
            
            // 等待类别加载完成后再显示模态框
            await refreshExpenseCategorySelectors();
            document.getElementById('expenseModal').classList.add('show');
        }

        function openEditExpenseModal(id, userId, amount, category, description, expenseTime) {
            editingExpenseId = id;
            document.getElementById('expenseModalTitle').textContent = '✏️ 编辑消费记录';
            document.getElementById('expenseModalSubtitle').textContent = `编辑 ID: ${id} 的消费记录`;
            document.getElementById('expenseSubmitBtn').textContent = '保存修改';
            loadUsersForSelect().then(() => {
                document.getElementById('expenseUserId').value = userId;
            });
            document.getElementById('expenseAmount').value = amount;
            refreshExpenseCategorySelectors().then(() => {
                document.getElementById('expenseCategory').value = category;
            });
            document.getElementById('expenseDescription').value = description;
            document.getElementById('expenseTime').value = formatDateTimeLocal(expenseTime);
            loadUsersForSelect();
            setTimeout(() => { document.getElementById('expenseUserId').value = userId; }, 100);
            document.getElementById('expenseModal').classList.add('show');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('show');
            editingExpenseId = null;
        }

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('表单提交开始，isAdmin:', isAdmin);
            
            // 对于非管理员，自动获取当前用户ID
            let userId = parseInt(document.getElementById('expenseUserId').value);
            console.log('初始 userId:', userId);
            
            if ((!userId || isNaN(userId)) && !isAdmin) {
                // 优先从变量获取，如果没有则从 localStorage 获取
                if (currentUserId) {
                    userId = currentUserId;
                    console.log('从变量获取用户ID:', userId);
                } else {
                    const savedUserId = localStorage.getItem('admin_user_id');
                    if (savedUserId) {
                        userId = parseInt(savedUserId);
                        currentUserId = userId;
                        console.log('从 localStorage 获取用户ID:', userId);
                    } else {
                        // 如果都没有，尝试从服务器获取
                        await loadCurrentUserIdFromServer();
                        if (currentUserId) {
                            userId = currentUserId;
                            console.log('从服务器获取用户ID:', userId);
                        }
                    }
                }
            }
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;
            const expenseTime = document.getElementById('expenseTime').value;

            console.log('表单数据:', { userId, amount, category, description, expenseTime });

            // 验证类别是否已选择（不能为空字符串）
            if (!userId || isNaN(userId) || !amount || !category || category.trim() === '' || !expenseTime) {
                console.error('表单验证失败:', { userId, amount, category, expenseTime });
                if (!category || category.trim() === '') {
                    showToast('请选择消费类别', 'warning');
                } else {
                    showToast('请填写所有必填项', 'warning');
                }
                return;
            }

            const data = {
                user_id: userId,
                amount: amount,
                category: category,
                description: description,
                expense_time: formatDateTimeForApi(expenseTime)
            };

            console.log('准备发送数据:', data);

            try {
                let res;
                if (editingExpenseId) {
                    // 编辑模式
                    console.log('编辑模式，ID:', editingExpenseId);
                    res = await fetch(`/admin/expenses/${editingExpenseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // 添加模式
                    console.log('添加模式，发送 POST 请求到 /admin/expenses');
                    res = await fetch('/admin/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                console.log('请求响应状态:', res.status, res.statusText);
                const result = await res.json();
                console.log('服务器响应:', result);
                if (result.success) {
                    showToast(result.message, 'success');
                    closeExpenseModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    console.error('服务器返回错误:', result);
                    showToast(result.message || '操作失败', 'error');
                }
            } catch (err) {
                console.error('提交表单时发生错误:', err);
                showToast('操作失败: ' + (err.message || '未知错误'), 'error');
            }
        });

        function openDeleteModal(id) {
            deleteExpenseId = id;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteExpenseId = null;
        }

        async function confirmDelete() {
            if (!deleteExpenseId) return;
            try {
                const res = await fetch(`/admin/expenses/${deleteExpenseId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    closeDeleteModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        // ===== AI模型管理功能 =====
        async function loadAIModels() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data;
                    renderAIModelsTable(data.data);
                }
            } catch (e) {
                console.error('加载AI模型列表失败:', e);
                showToast('加载失败', 'error');
            }
        }

        function renderAIModelsTable(models) {
            const tbody = document.getElementById('aiModelsTable');
            if (!models || models.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px;">暂无AI模型配置</td></tr>';
                if (window.aiModelsSortable) { aiModelsSortable.destroy(); aiModelsSortable = null; }
            } else {
                tbody.innerHTML = models.map(model => `
                    <tr data-id="${model.id}">
                        <td style="cursor:grab;text-align:center;color:var(--text-secondary);user-select:none;" class="drag-handle" title="拖动调整顺序">⋮⋮</td>
                        <td>${model.id}</td>
                        <td><strong>${model.name}</strong></td>
                        <td style="color: var(--text-secondary);"><span class="url-ellipsis" title="${(model.base_url||'').replace(/"/g, '&quot;')}">${model.base_url}</span></td>
                        <td>${formatDateTime(model.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-success btn-sm" onclick="detectAIModel(${model.id})">检测</button>
                                <button class="btn btn-primary btn-sm" onclick="openEditAIModelModalById(${model.id})">编辑</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteAIModelModal(${model.id})">删除</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                initAIModelsSortable();
            }
        }

        function openEditAIModelModalById(id) {
            const m = allAIModels.find(x => x.id === id);
            if (m) openEditAIModelModal(m.id, m.name, m.base_url);
        }

        let aiModelsSortable = null;
        function initAIModelsSortable() {
            if (aiModelsSortable) { aiModelsSortable.destroy(); aiModelsSortable = null; }
            const tbody = document.getElementById('aiModelsTable');
            if (!tbody || tbody.querySelector('tr[data-id]') === null) return;
            aiModelsSortable = Sortable.create(tbody, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: async function(evt) {
                    const rows = tbody.querySelectorAll('tr[data-id]');
                    const modelIds = Array.from(rows).map(r => parseInt(r.dataset.id, 10));
                    try {
                        const res = await fetch('/admin/ai-models/reorder', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model_ids: modelIds })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast('排序已保存', 'success');
                            allAIModels = allAIModels.sort((a, b) => modelIds.indexOf(a.id) - modelIds.indexOf(b.id));
                            loadAIModelsForAnalysis();
                            loadAIModelsForChat();
                        } else {
                            showToast(data.message || '排序保存失败', 'error');
                            loadAIModels();
                        }
                    } catch (e) {
                        showToast('排序保存失败', 'error');
                        loadAIModels();
                    }
                }
            });
        }

        function openAIModelModal() {
            editingAIModelId = null;
            document.getElementById('aiModelModalTitle').textContent = '➕ 添加AI模型';
            document.getElementById('aiModelModalSubtitle').textContent = '配置AI模型的调用信息';
            document.getElementById('aiModelSubmitBtn').textContent = '确认添加';
            document.getElementById('aiModelForm').reset();
            document.getElementById('aiModelModal').classList.add('show');
        }

        function openEditAIModelModal(id, name, baseURL) {
            editingAIModelId = id;
            document.getElementById('aiModelModalTitle').textContent = '✏️ 编辑AI模型';
            document.getElementById('aiModelModalSubtitle').textContent = `编辑 ID: ${id} 的AI模型配置`;
            document.getElementById('aiModelSubmitBtn').textContent = '保存修改';
            document.getElementById('aiModelName').value = name;
            document.getElementById('aiModelBaseURL').value = baseURL;
            document.getElementById('aiModelAPIKey').value = ''; // 不显示原密钥，需要重新输入
            document.getElementById('aiModelAPIKey').placeholder = '如需更新密钥，请输入新密钥';
            document.getElementById('aiModelAPIKey').required = false; // 编辑时密钥可选
            document.getElementById('aiModelModal').classList.add('show');
        }

        function closeAIModelModal() {
            document.getElementById('aiModelModal').classList.remove('show');
            editingAIModelId = null;
            document.getElementById('aiModelAPIKey').required = true; // 恢复必填
            document.getElementById('aiModelAPIKey').placeholder = 'sk-...';
        }

        document.getElementById('aiModelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('aiModelName').value;
            const baseURL = document.getElementById('aiModelBaseURL').value;
            const apiKey = document.getElementById('aiModelAPIKey').value;

            if (!name || !baseURL) {
                showToast('请填写所有必填项', 'warning');
                return;
            }

            // 编辑模式下，如果API密钥为空，则不更新密钥
            const data = {
                name: name,
                base_url: baseURL
            };
            if (apiKey || !editingAIModelId) {
                data.api_key = apiKey;
            }

            try {
                let res;
                if (editingAIModelId) {
                    res = await fetch(`/admin/ai-models/${editingAIModelId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/admin/ai-models', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeAIModelModal();
                    loadAIModels();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (err) {
                showToast('操作失败', 'error');
            }
        });

        async function detectAIModel(id) {
            try {
                const res = await fetch(`/admin/ai-models/${id}/test`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('接口可用', 'success');
                } else {
                    showToast(data.message || '检测失败', 'error');
                }
            } catch (e) {
                showToast('检测失败: ' + (e.message || '网络错误'), 'error');
            }
        }

        function openDeleteAIModelModal(id) {
            deleteAIModelId = id;
            document.getElementById('deleteAIModelModal').classList.add('show');
        }

        function closeDeleteAIModelModal() {
            document.getElementById('deleteAIModelModal').classList.remove('show');
            deleteAIModelId = null;
        }

        async function confirmDeleteAIModel() {
            if (!deleteAIModelId) return;
            try {
                const res = await fetch(`/admin/ai-models/${deleteAIModelId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    closeDeleteAIModelModal();
                    loadAIModels();
                    loadAIModelsForAnalysis(); // 同时更新分析页面的下拉列表
                } else {
                    showToast(data.message, 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        // ===== AI分析功能 =====
        async function loadUsersForAnalysis() {
            if (!isAdmin) return; // 非管理员不需要加载用户列表
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    allUsers = data.data || [];
                    const select = document.getElementById('analysisUserId');
                    if (select) {
                        select.innerHTML = '<option value="">全部用户</option>';
                        allUsers.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username + (user.is_admin ? ' (管理员)' : '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('加载用户列表失败:', e);
            }
        }

        // ===== 账单统计功能 =====
        async function loadUsersForStatistics() {
            if (!isAdmin) return; // 非管理员不需要加载用户列表
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('statUserId');
                    if (select) {
                        select.innerHTML = '<option value="">全部用户</option>';
                        (data.data || []).forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username + (user.is_admin ? ' (管理员)' : '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('加载用户列表失败:', e);
            }
        }

        // ===== 账单管理功能 =====
        async function loadUsersForExpenses() {
            if (!isAdmin) return; // 非管理员不需要加载用户列表
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('filterUserId');
                    if (select) {
                        select.innerHTML = '<option value="">全部用户</option>';
                        (data.data || []).forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username + (user.is_admin ? ' (管理员)' : '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('加载用户列表失败:', e);
            }
        }

        // ===== 收入管理功能 =====
        async function loadUsersForIncomes() {
            if (!isAdmin) return; // 非管理员不需要加载用户列表
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('incomeFilterUserId');
                    if (select) {
                        select.innerHTML = '<option value="">全部用户</option>';
                        (data.data || []).forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.username + (user.is_admin ? ' (管理员)' : '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('加载用户列表失败:', e);
            }
        }

        async function loadAIModelsForAnalysis() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data;
                    const select = document.getElementById('analysisModelId');
                    select.innerHTML = '<option value="">请选择AI模型</option>' + 
                        data.data.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    // 默认加载一次历史
                    refreshAnalysisHistory();
                }
            } catch (e) {
                console.error('加载AI模型列表失败:', e);
            }
        }

        function clearAnalysisResult() {
            const resultDiv = document.getElementById('aiAnalysisResult');
            resultDiv.innerHTML = '<div style="color: var(--text-secondary);">请选择AI模型和时间范围，然后点击“开始分析”按钮</div>';
        }

        function onAnalysisModelChange() {
            analysisHistoryPage = 1;
            refreshAnalysisHistory();
        }

        async function refreshAnalysisHistory() {
            const modelId = document.getElementById('analysisModelId').value;
            const listEl = document.getElementById('analysisHistoryList');
            if (!modelId) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">请选择AI模型查看历史</div>';
                document.getElementById('analysisPaginationInfo').textContent = '第 1 / 1 页';
                document.getElementById('analysisPaginationButtons').innerHTML = '';
                return;
            }
            try {
                const params = new URLSearchParams({ model_id: modelId, page: analysisHistoryPage, page_size: analysisHistoryPageSize });
                const res = await fetch(`/admin/ai-analysis/history?${params}`);
                const data = await res.json();
                if (!data.success) {
                    listEl.innerHTML = `<div style="padding:16px;color:var(--danger);text-align:center;">${data.message || '加载失败'}</div>`;
                    return;
                }
                const total = (data.data && typeof data.data.total === 'number') ? data.data.total : 0;
                analysisHistoryTotalPages = Math.max(1, Math.ceil(total / analysisHistoryPageSize));
                // 防止删除后页码越界
                if (analysisHistoryPage > analysisHistoryTotalPages) {
                    analysisHistoryPage = analysisHistoryTotalPages;
                    return refreshAnalysisHistory();
                }
                renderAnalysisHistory(data.data.list || []);
                renderAnalysisPagination(total);
            } catch (e) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--danger);text-align:center;">加载失败</div>';
            }
        }

        function renderAnalysisPagination(total) {
            const info = document.getElementById('analysisPaginationInfo');
            const btns = document.getElementById('analysisPaginationButtons');
            info.textContent = `共 ${total} 条，第 ${analysisHistoryPage} / ${analysisHistoryTotalPages} 页`;
            btns.innerHTML = `
                <button class="page-btn" onclick="goToAnalysisPage(${analysisHistoryPage - 1})" ${analysisHistoryPage <= 1 ? 'disabled' : ''}>上一页</button>
                <button class="page-btn" onclick="goToAnalysisPage(${analysisHistoryPage + 1})" ${analysisHistoryPage >= analysisHistoryTotalPages ? 'disabled' : ''}>下一页</button>
            `;
        }

        function goToAnalysisPage(page) {
            if (page < 1 || page > analysisHistoryTotalPages) return;
            analysisHistoryPage = page;
            refreshAnalysisHistory();
        }

        function renderAnalysisHistory(items) {
            const listEl = document.getElementById('analysisHistoryList');
            if (!items || items.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">暂无分析历史</div>';
                return;
            }
            listEl.innerHTML = items.map(it => {
                const t = it.created_at ? formatDateTime(it.created_at) : '-';
                const title = `${it.start_date} ~ ${it.end_date}`;
                return `<div class="chat-history-item" data-id="${it.id}">
                    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
                        <div style="flex:1;min-width:0;">
                            <div class="t">${t}</div>
                            <div class="q">${title}</div>
                        </div>
                        <div style="display:flex;gap:8px;flex-shrink:0;">
                            <button class="btn btn-primary btn-sm" onclick="showAnalysisRecord(${it.id})">查看</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAnalysisRecord(${it.id})">删除</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            window.__analysisHistoryCache = items;
        }

        function showAnalysisRecord(id) {
            const items = window.__analysisHistoryCache || [];
            const it = items.find(x => x.id === id);
            if (!it) return;
            const resultDiv = document.getElementById('aiAnalysisResult');
            resultDiv.innerHTML = renderMarkdown(it.result || '');
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        async function deleteAnalysisRecord(id) {
            if (!confirm('确定要删除这条分析历史吗？')) return;
            try {
                const res = await fetch(`/admin/ai-analysis/history/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    refreshAnalysisHistory();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        async function startAIAnalysis() {
            const modelId = document.getElementById('analysisModelId').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;
            const userId = document.getElementById('analysisUserId')?.value || '';

            if (!modelId || !startDate || !endDate) {
                showToast('请填写所有必填项', 'warning');
                return;
            }

            const btn = document.getElementById('analysisBtn');
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            btn.disabled = true;
            btn.textContent = '分析中...';
            resultDiv.textContent = '正在分析，请稍候...\n\n';
            let raw = '';

            // 构建请求体
            const requestBody = {
                model_id: parseInt(modelId),
                start_time: startDate,
                end_time: endDate
            };
            // 仅管理员可以传递 user_id
            if (isAdmin && userId) {
                requestBody.user_id = parseInt(userId);
            }

            try {
                const response = await fetch('/admin/ai-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '分析失败');
                }

                // 处理SSE流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                resultDiv.textContent = '';
                let sawDone = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // 保留最后一个不完整的行

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        if (line.startsWith('data: ')) {
                            const payload = line.slice(6);
                            // 新格式：JSON 帧
                            try {
                                const frame = JSON.parse(payload);
                                if (frame.type === 'delta') {
                                    raw += frame.content || '';
                                    resultDiv.textContent += frame.content || '';
                                    resultDiv.scrollTop = resultDiv.scrollHeight;
                                } else if (frame.type === 'done') {
                                    sawDone = true;
                                } else if (frame.type === 'error') {
                                    throw new Error(frame.content || '分析失败');
                                }
                            } catch (e) {
                                // 兼容旧格式（纯文本）
                                if (payload.trim() === '[DONE]') { sawDone = true; continue; }
                                raw += payload;
                                resultDiv.textContent += payload;
                                resultDiv.scrollTop = resultDiv.scrollHeight;
                            }
                        } else if (line.startsWith('event: ')) {
                            // 忽略事件类型
                            continue;
                        } else if (line.startsWith('id: ')) {
                            // 忽略ID
                            continue;
                        } else if (line.trim()) {
                            // 其他内容直接显示
                            raw += line;
                            resultDiv.textContent += line;
                            resultDiv.scrollTop = resultDiv.scrollHeight;
                        }
                    }
                }

                // 处理剩余的buffer
                if (buffer.trim()) {
                    raw += buffer;
                    resultDiv.textContent += buffer;
                }

                if (resultDiv.textContent.trim() === '') {
                    resultDiv.textContent = '分析完成，但未收到内容。';
                }

                // DONE 后立即渲染 Markdown（marked）
                if (sawDone || raw.trim()) {
                    resultDiv.innerHTML = renderMarkdown(raw || resultDiv.textContent);
                }
                refreshAnalysisHistory();
            } catch (error) {
                resultDiv.textContent = `分析失败: ${error.message}`;
                showToast('分析失败', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '🤖 开始分析';
            }
        }

        // ===== AI聊天功能 =====
        async function loadAIModelsForChat() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data || [];
                    const select = document.getElementById('chatModelId');
                    const prev = select.value;
                    select.innerHTML = '<option value="">请选择AI模型</option>' +
                        allAIModels.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    if (prev) select.value = prev;
                }
            } catch (e) {
                console.error('加载AI模型列表失败:', e);
            }
        }

        function onChatModelChange() {
            chatHistoryPage = 1;
            refreshChatHistory();
            clearChatWindow();
        }

        async function refreshChatHistory() {
            const modelId = document.getElementById('chatModelId').value;
            const listEl = document.getElementById('chatHistoryList');
            if (!modelId) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">请选择模型查看历史</div>';
                return;
            }
            try {
                const params = new URLSearchParams({ model_id: modelId, page: chatHistoryPage, page_size: 30 });
                const res = await fetch(`/admin/ai-chat/history?${params}`);
                const data = await res.json();
                if (!data.success) {
                    listEl.innerHTML = `<div style="padding:16px;color:var(--danger);text-align:center;">${data.message || '加载失败'}</div>`;
                    return;
                }
                renderChatHistory(data.data.list || []);
            } catch (e) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--danger);text-align:center;">加载失败</div>';
            }
        }

        async function deleteChatRecord(id) {
            if (!confirm('确定要删除这条聊天记录吗？')) return;
            try {
                const res = await fetch(`/admin/ai-chat/history/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功', 'success');
                    refreshChatHistory();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        function renderChatHistory(items) {
            const listEl = document.getElementById('chatHistoryList');
            if (!items || items.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">暂无聊天记录</div>';
                return;
            }
            listEl.innerHTML = items.map(it => {
                const t = it.created_at ? formatDateTime(it.created_at) : '-';
                const q = (it.user_text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                return `<div class="chat-history-item" data-id="${it.id}">
                    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
                        <div style="flex:1;min-width:0;cursor:pointer;" onclick="showChatRecord(${it.id})">
                            <div class="t">${t}</div>
                            <div class="q">${q}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteChatRecord(${it.id})">删除</button>
                    </div>
                </div>`;
            }).join('');
            // 缓存到 window 方便点击展示
            window.__chatHistoryCache = items;
        }

        function showChatRecord(id) {
            const items = window.__chatHistoryCache || [];
            const it = items.find(x => x.id === id);
            if (!it) return;
            const msgEl = document.getElementById('chatMessages');
            msgEl.innerHTML = '';
            appendChatBubble('user', it.user_text || '');
            const aiEl = appendChatBubble('ai', '');
            setChatBubbleFormatted(aiEl, it.ai_text || '');
            msgEl.scrollTop = msgEl.scrollHeight;
        }

        function clearChatWindow() {
            const msgEl = document.getElementById('chatMessages');
            msgEl.innerHTML = '<div style="color:var(--text-secondary);">开始一段新的对话吧。</div>';
            chatCurrentAIEl = null;
        }

        function appendChatBubble(role, text) {
            const msgEl = document.getElementById('chatMessages');
            // 清掉提示占位
            if (msgEl.children.length === 1 && msgEl.children[0].tagName === 'DIV' && msgEl.children[0].className === '') {
                // do nothing
            }
            if (msgEl.textContent.includes('请选择AI模型') || msgEl.textContent.includes('开始一段新的对话吧。')) {
                msgEl.innerHTML = '';
            }
            const div = document.createElement('div');
            div.className = `chat-msg ${role}`;
            div.textContent = text || '';
            msgEl.appendChild(div);
            msgEl.scrollTop = msgEl.scrollHeight;
            return div;
        }

        function escapeHtml(s) {
            return (s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Markdown 渲染（marked + DOMPurify）。依赖加载失败时自动降级为纯文本。
        function renderMarkdown(text) {
            const src = text || '';
            try {
                if (window.marked && window.DOMPurify) {
                    const html = window.marked.parse(src, { breaks: true, gfm: true });
                    return window.DOMPurify.sanitize(html);
                }
            } catch (e) {}
            // 降级：纯文本 + 换行
            return escapeHtml(src).replace(/\n/g, '<br>');
        }

        function setChatBubbleFormatted(el, rawText) {
            if (!el) return;
            el.innerHTML = renderMarkdown(rawText || '');
        }

        async function sendChatMessage() {
            if (chatStreaming) return;
            const modelId = document.getElementById('chatModelId').value;
            const input = document.getElementById('chatInput');
            const text = (input.value || '').trim();
            if (!modelId) { showToast('请先选择AI模型', 'warning'); return; }
            if (!text) { showToast('请输入内容', 'warning'); return; }

            const btn = document.getElementById('chatSendBtn');
            btn.disabled = true;
            chatStreaming = true;
            input.disabled = true;

            appendChatBubble('user', text);
            chatCurrentAIEl = appendChatBubble('ai', '');
            input.value = '';
            let aiRaw = '';
            let sawDone = false;

            try {
                const response = await fetch('/admin/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: parseInt(modelId), message: text })
                });

                if (!response.ok) {
                    const errJson = await response.json().catch(() => ({}));
                    throw new Error(errJson.message || `请求失败(${response.status})`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const payload = line.slice(6);
                        try {
                            const frame = JSON.parse(payload);
                            if (frame.type === 'delta') {
                                const delta = frame.content || '';
                                aiRaw += delta;
                                if (chatCurrentAIEl) chatCurrentAIEl.textContent += delta;
                            } else if (frame.type === 'done') {
                                sawDone = true;
                            } else if (frame.type === 'error') {
                                throw new Error(frame.content || '聊天失败');
                            }
                        } catch (e) {
                            // 兼容旧格式
                            if (payload.trim() === '[DONE]') { sawDone = true; continue; }
                            aiRaw += payload;
                            if (chatCurrentAIEl) chatCurrentAIEl.textContent += payload;
                        }
                        const msgEl = document.getElementById('chatMessages');
                        msgEl.scrollTop = msgEl.scrollHeight;
                    }
                }

                // 收到结束标记后立刻格式化整段内容
                if (chatCurrentAIEl) {
                    setChatBubbleFormatted(chatCurrentAIEl, aiRaw || chatCurrentAIEl.textContent);
                }

                // 结束后刷新历史
                refreshChatHistory();
            } catch (e) {
                if (chatCurrentAIEl) chatCurrentAIEl.textContent += `\n\n（错误：${e.message}）`;
                showToast('发送失败', 'error');
            } finally {
                btn.disabled = false;
                chatStreaming = false;
                input.disabled = false;
                input.focus();
            }
        }

        // ========== 账单统计相关函数 ==========
        let pieChartInstance = null;
        let barChartInstance = null;
        let allCategoriesForStats = [];

        async function initStatisticsPage() {
            // 加载类别列表用于多选
            try {
                const res = await fetch('/api/v1/categories');
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    allCategoriesForStats = data.data;
                    renderCategoryCheckboxes();
                }
            } catch (e) {
                console.error('加载类别列表失败:', e);
            }
            // 如果是管理员，加载用户列表
            if (isAdmin) {
                await loadUsersForStatistics();
            }
            // 设置默认时间
            setDefaultStatisticsDates();
            // 初始化完成后自动加载数据
            await loadStatisticsData();
        }

        function renderCategoryCheckboxes() {
            const container = document.getElementById('categoryDrawerBody');
            if (!container) return;
            container.innerHTML = '';
            allCategoriesForStats.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'category-checkbox-item';
                item.onclick = function(e) {
                    if (e.target && e.target.type === 'checkbox') {
                        updateCategoryItemStyle(item, e.target.checked);
                        updateCategoryButtonText();
                        return;
                    }
                    // 点击整行/文字都切换（避免 label 默认行为导致双切换）
                    if (e.target && e.target.tagName === 'LABEL') return;
                    if (e.target && e.target.tagName === 'SPAN') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        updateCategoryItemStyle(item, checkbox.checked);
                        updateCategoryButtonText();
                        return;
                    }
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    updateCategoryItemStyle(item, checkbox.checked);
                    updateCategoryButtonText();
                };
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = cat.name;
                checkbox.id = `statCat_${cat.id}`;
                checkbox.onchange = function() {
                    updateCategoryItemStyle(item, this.checked);
                    updateCategoryButtonText();
                };
                
                const text = document.createElement('span');
                text.textContent = cat.name;
                text.style.userSelect = 'none';
                
                item.appendChild(checkbox);
                item.appendChild(text);
                container.appendChild(item);
            });
        }

        function updateCategoryItemStyle(item, checked) {
            if (checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }

        function updateCategoryButtonText() {
            const selected = getSelectedCategories();
            const btnText = document.getElementById('statCategoryButtonText');
            if (selected.length === 0) {
                btnText.textContent = '选择类别（可多选）';
            } else {
                btnText.textContent = `已选择 ${selected.length} 个类别`;
            }
        }

        function openCategoryDrawer() {
            document.getElementById('categoryDrawer').classList.add('show');
            document.getElementById('categoryDrawerOverlay').classList.add('show');
        }

        function closeCategoryDrawer() {
            document.getElementById('categoryDrawer').classList.remove('show');
            document.getElementById('categoryDrawerOverlay').classList.remove('show');
        }

        function clearCategorySelection() {
            document.querySelectorAll('#categoryDrawerBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                const item = cb.closest('.category-checkbox-item');
                if (item) updateCategoryItemStyle(item, false);
            });
            updateCategoryButtonText();
        }

        function setDefaultStatisticsDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthInput = document.getElementById('statYearMonth');
            if (monthInput) {
                const yearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = yearMonth;
            }
            const yearInput = document.getElementById('statYear');
            if (yearInput) yearInput.value = today.getFullYear();
            const startInput = document.getElementById('statStartDate');
            const endInput = document.getElementById('statEndDate');
            if (startInput && !startInput.value) startInput.value = formatDate(firstDay);
            if (endInput && !endInput.value) endInput.value = formatDate(today);
        }

        function onStatRangeTypeChange() {
            const rangeType = document.getElementById('statRangeType').value;
            document.getElementById('statMonthGroup').style.display = rangeType === 'month' ? 'block' : 'none';
            document.getElementById('statYearGroup').style.display = rangeType === 'year' ? 'block' : 'none';
            document.getElementById('statCustomGroup').style.display = rangeType === 'custom' ? 'block' : 'none';
            document.getElementById('statCustomEndGroup').style.display = rangeType === 'custom' ? 'block' : 'none';
        }

        function resetStatisticsFilters() {
            document.getElementById('statRangeType').value = 'month';
            onStatRangeTypeChange();
            setDefaultStatisticsDates();
            // 重置用户筛选（仅管理员）
            if (isAdmin) {
                const statUserId = document.getElementById('statUserId');
                if (statUserId) {
                    statUserId.value = '';
                }
            }
            // 取消所有类别选择
            document.querySelectorAll('#categoryDrawerBody input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                const item = cb.closest('.category-checkbox-item');
                if (item) updateCategoryItemStyle(item, false);
            });
            updateCategoryButtonText();
            // 清空图表
            if (pieChartInstance) { pieChartInstance.destroy(); pieChartInstance = null; }
            if (barChartInstance) { barChartInstance.destroy(); barChartInstance = null; }
            document.getElementById('detailStatTotalAmount').textContent = '¥0.00';
            document.getElementById('detailStatTotalCount').textContent = '0';
            document.getElementById('detailStatTimeRange').textContent = '-';
            document.getElementById('statCategoryList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">请点击"查询统计"获取数据</p>';
        }

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('#categoryDrawerBody input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function loadStatisticsData() {
            const rangeType = document.getElementById('statRangeType').value;
            let url = '/admin/expenses/detailed-statistics?range_type=' + encodeURIComponent(rangeType);
            
            // 根据时间范围类型添加参数
            if (rangeType === 'month') {
                const yearMonth = document.getElementById('statYearMonth').value;
                if (!yearMonth) { showToast('请选择年月', 'warning'); return; }
                url += '&year_month=' + encodeURIComponent(yearMonth);
            } else if (rangeType === 'year') {
                const year = document.getElementById('statYear').value;
                if (!year) { showToast('请输入年份', 'warning'); return; }
                url += '&year=' + encodeURIComponent(year);
            } else if (rangeType === 'custom') {
                const startDate = document.getElementById('statStartDate').value;
                const endDate = document.getElementById('statEndDate').value;
                if (!startDate || !endDate) { showToast('请选择开始和结束日期', 'warning'); return; }
                url += '&start_time=' + encodeURIComponent(startDate) + '&end_time=' + encodeURIComponent(endDate);
            }

            // 添加用户筛选（仅管理员）
            if (isAdmin) {
                const userId = document.getElementById('statUserId')?.value || '';
                if (userId) {
                    url += '&user_id=' + encodeURIComponent(userId);
                }
            }
            
            // 添加类别筛选
            const selectedCategories = getSelectedCategories();
            if (selectedCategories.length > 0) {
                url += '&categories=' + encodeURIComponent(selectedCategories.join(','));
            }

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.success && data.data) {
                    renderStatistics(data.data);
                } else {
                    showToast(data.message || '获取统计数据失败', 'error');
                }
            } catch (e) {
                console.error('获取统计数据失败:', e);
                showToast('获取统计数据失败', 'error');
            }
        }

        function renderStatistics(data) {
            // 更新总览 - 确保数据类型正确
            const totalAmount = typeof data.total_amount === 'number' ? data.total_amount : parseFloat(data.total_amount) || 0;
            const totalCount = typeof data.total_count === 'number' ? data.total_count : parseInt(data.total_count) || 0;
            document.getElementById('detailStatTotalAmount').textContent = '¥' + totalAmount.toFixed(2);
            document.getElementById('detailStatTotalCount').textContent = totalCount;
            document.getElementById('detailStatTimeRange').textContent = (data.start_time || '-') + ' 至 ' + (data.end_time || '-');

            // 更新类别列表
            const categoryListEl = document.getElementById('statCategoryList');
            if (data.category_stats && data.category_stats.length > 0) {
                categoryListEl.innerHTML = data.category_stats.map(stat => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>${stat.category}</span>
                        <span style="font-weight: 600;">¥${stat.total.toFixed(2)} (${stat.count}条, ${stat.percentage.toFixed(1)}%)</span>
                    </div>
                `).join('');
            } else {
                categoryListEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">暂无数据</p>';
            }

            // 渲染图表
            renderPieChart(data.category_stats || []);
            renderBarChart(data.category_stats || []);
        }

        function renderPieChart(categoryStats) {
            const ctx = document.getElementById('pieChart');
            if (!ctx) return;

            if (pieChartInstance) {
                pieChartInstance.destroy();
            }

            if (categoryStats.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            // 使用类别数据库中的颜色，如果没有则使用默认颜色
            const getCategoryColor = (categoryName) => {
                const category = allCategoriesForStats.find(c => c.name === categoryName);
                return category?.color || '#64748b';
            };

            // 生成颜色数组（带透明度）
            const backgroundColors = categoryStats.map(s => {
                const color = getCategoryColor(s.category);
                return hexToRgba(color, 0.85);
            });
            
            const borderColors = categoryStats.map(s => {
                const color = getCategoryColor(s.category);
                return hexToRgba(color, 1);
            });

            // 获取主题颜色
            const computedStyle = getComputedStyle(document.documentElement);
            const bgMain = computedStyle.getPropertyValue('--bg-main').trim();
            const textPrimary = computedStyle.getPropertyValue('--text-primary').trim();
            const textSecondary = computedStyle.getPropertyValue('--text-secondary').trim();
            const border = computedStyle.getPropertyValue('--border').trim();

            pieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categoryStats.map(s => s.category),
                    datasets: [{
                        data: categoryStats.map(s => s.total),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 3,
                        hoverBorderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textPrimary,
                                padding: 18,
                                font: { 
                                    size: 13,
                                    weight: '500',
                                    family: "'Noto Sans SC', sans-serif"
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: backgroundColors[i],
                                                strokeStyle: borderColors[i],
                                                lineWidth: 2,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: bgMain,
                            titleColor: textPrimary,
                            bodyColor: textPrimary,
                            borderColor: border,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderBarChart(categoryStats) {
            const ctx = document.getElementById('barChart');
            if (!ctx) return;

            if (barChartInstance) {
                barChartInstance.destroy();
            }

            if (categoryStats.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            // 使用类别数据库中的颜色
            const getCategoryColor = (categoryName) => {
                const category = allCategoriesForStats.find(c => c.name === categoryName);
                return category?.color || '#64748b';
            };

            // 生成渐变色数组
            const createGradient = (ctx, color) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                const rgba = hexToRgba(color, 1);
                gradient.addColorStop(0, hexToRgba(color, 0.9));
                gradient.addColorStop(1, hexToRgba(color, 0.5));
                return gradient;
            };

            // 获取主题颜色
            const computedStyle = getComputedStyle(document.documentElement);
            const bgMain = computedStyle.getPropertyValue('--bg-main').trim();
            const bgCard = computedStyle.getPropertyValue('--bg-card').trim();
            const textPrimary = computedStyle.getPropertyValue('--text-primary').trim();
            const textSecondary = computedStyle.getPropertyValue('--text-secondary').trim();
            const border = computedStyle.getPropertyValue('--border').trim();
            const primary = computedStyle.getPropertyValue('--primary').trim();

            // 为每个类别创建渐变
            const chartCtx = ctx.getContext('2d');
            const backgroundColors = categoryStats.map(s => {
                const color = getCategoryColor(s.category);
                return createGradient(chartCtx, color);
            });
            
            const borderColors = categoryStats.map(s => {
                const color = getCategoryColor(s.category);
                return hexToRgba(color, 1);
            });

            barChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryStats.map(s => s.category),
                    datasets: [{
                        label: '消费金额',
                        data: categoryStats.map(s => s.total),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        barThickness: 'flex',
                        maxBarThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: bgMain,
                            titleColor: textPrimary,
                            bodyColor: textPrimary,
                            borderColor: border,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `金额: ¥${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textSecondary,
                                font: {
                                    size: 12,
                                    family: "'Noto Sans SC', sans-serif"
                                },
                                callback: function(value) {
                                    return '¥' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: border,
                                lineWidth: 1,
                                drawBorder: true,
                                borderColor: border
                            },
                            border: {
                                color: border,
                                width: 1
                            }
                        },
                        x: {
                            ticks: {
                                color: textSecondary,
                                font: {
                                    size: 12,
                                    family: "'Noto Sans SC', sans-serif"
                                }
                            },
                            grid: {
                                display: false
                            },
                            border: {
                                color: border,
                                width: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    onHover: (event, activeElements) => {
                        ctx.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }
    </script>
</body>
</html>
