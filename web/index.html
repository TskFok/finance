<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°è´¦ç³»ç»Ÿ - åå°ç®¡ç†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-main); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%); position: relative; overflow: hidden; }
        .login-container::before { content: ''; position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(37, 99, 235, 0.15) 0%, transparent 70%); top: -200px; right: -200px; }
        .login-container::after { content: ''; position: absolute; width: 400px; height: 400px; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%); bottom: -100px; left: -100px; }
        .login-box { background: var(--bg-card); padding: 48px; border-radius: 24px; box-shadow: var(--shadow); width: 100%; max-width: 420px; position: relative; z-index: 1; border: 1px solid var(--border); }
        .login-box h1 { text-align: center; margin-bottom: 8px; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary-light), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-box p { text-align: center; color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        .form-group input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 15px; background: var(--bg-input); color: var(--text-primary); transition: all 0.3s ease; }
        .form-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15); }
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.35); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .link-btn { background: none; border: none; color: var(--primary-light); cursor: pointer; font-size: 14px; text-decoration: underline; margin-top: 16px; display: block; text-align: center; }
        .link-btn:hover { color: var(--primary); }
        .app-container { display: none; min-height: 100vh; }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 16px; display: flex; flex-direction: column; }
        .logo { display: flex; align-items: center; gap: 12px; padding: 0 12px 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--primary), var(--success)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .logo-text { font-size: 18px; font-weight: 700; }
        .nav-menu { flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary); margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg-input); color: var(--text-primary); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .nav-item svg { width: 20px; height: 20px; }
        .user-info { padding: 16px; background: var(--bg-input); border-radius: 12px; display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--warning), var(--danger)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-details { flex: 1; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 12px; color: var(--text-secondary); }
        .logout-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s ease; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .main-content { margin-left: 260px; padding: 32px; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .page-title { font-size: 28px; font-weight: 700; }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 24px; }
        .stat-icon.blue { background: rgba(37, 99, 235, 0.15); color: var(--primary-light); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { color: var(--text-secondary); font-size: 14px; }
        .filter-bar { background: var(--bg-card); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border); }
        .filter-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 180px; }
        .filter-item label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .filter-item input, .filter-item select { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--bg-input); color: var(--text-primary); transition: all 0.2s ease; }
        .filter-item input:focus, .filter-item select:focus { outline: none; border-color: var(--primary); }
        .filter-actions { display: flex; gap: 12px; }
        .data-table-container { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: var(--bg-input); padding: 16px 20px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: rgba(37, 99, 235, 0.05); }
        .category-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .category-tag.é¤é¥® { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .category-tag.äº¤é€š { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .category-tag.è´­ç‰© { background: rgba(168, 85, 247, 0.15); color: #a78bfa; }
        .category-tag.å¨±ä¹ { background: rgba(236, 72, 153, 0.15); color: #f472b6; }
        .category-tag.åŒ»ç–— { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .category-tag.æ•™è‚² { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .category-tag.ä½æˆ¿ { background: rgba(20, 184, 166, 0.15); color: #2dd4bf; }
        .category-tag.å…¶ä»– { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }
        .amount { font-weight: 600; color: var(--danger); }
        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-top: 1px solid var(--border); }
        .pagination-info { color: var(--text-secondary); font-size: 14px; }
        .pagination-buttons { display: flex; gap: 8px; }
        .page-btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-input); color: var(--text-primary); cursor: pointer; transition: all 0.2s ease; font-size: 14px; }
        .page-btn:hover:not(:disabled) { background: var(--primary); border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: var(--primary); border-color: var(--primary); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .toast { position: fixed; top: 24px; right: 24px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 9999; animation: slideIn 0.3s ease; box-shadow: var(--shadow); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; padding: 32px; max-width: 450px; width: 90%; border: 1px solid var(--border); }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .modal-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .modal-actions .btn { flex: 1; }
        .action-btns { display: flex; gap: 8px; }
        .email-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: var(--success); color: white; margin-left: 8px; }
        .email-badge.disabled { background: var(--secondary); }
        .chat-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        .chat-history { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .chat-history-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .chat-history-list { max-height: 520px; overflow: auto; padding: 8px; }
        .chat-history-item { padding: 12px 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .chat-history-item:hover { background: rgba(37, 99, 235, 0.07); border-color: rgba(37, 99, 235, 0.2); }
        .chat-history-item .t { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .chat-history-item .q { font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; min-height: 620px; }
        .chat-panel-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; justify-content: space-between; }
        .chat-messages { padding: 18px 20px; overflow: auto; flex: 1; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); }
        .chat-msg { max-width: 78%; padding: 12px 14px; border-radius: 14px; margin: 10px 0; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
        .chat-msg.user { margin-left: auto; background: rgba(37, 99, 235, 0.18); border: 1px solid rgba(37, 99, 235, 0.35); }
        .chat-msg.ai { margin-right: auto; background: rgba(16, 185, 129, 0.12); border: 1px solid rgba(16, 185, 129, 0.28); }
        .chat-msg pre { background: rgba(15, 23, 42, 0.55); border: 1px solid rgba(148, 163, 184, 0.18); padding: 12px 12px; border-radius: 12px; overflow: auto; margin: 10px 0; }
        .chat-msg code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace; font-size: 13px; }
        .chat-msg pre code { display: block; white-space: pre; }
        .chat-msg ul { margin: 8px 0 8px 18px; }
        .chat-msg ol { margin: 8px 0 8px 18px; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .chat-input { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .chat-input textarea { flex: 1; resize: vertical; min-height: 46px; max-height: 160px; padding: 12px 14px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-input); color: var(--text-primary); font-size: 14px; }
        .chat-input textarea:focus { outline: none; border-color: var(--primary); }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1100px) { .chat-layout { grid-template-columns: 1fr; } .chat-panel { min-height: 560px; } }
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .filter-row { flex-direction: column; } .filter-item { width: 100%; } }
    </style>
    <!-- Markdown æ¸²æŸ“ï¼šmarked + DOMPurifyï¼ˆå…è®¸å‰ç«¯ä¾èµ–ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box" id="loginBox">
            <h1>ğŸ’° è®°è´¦ç³»ç»Ÿ</h1>
            <p>åå°ç®¡ç†ç³»ç»Ÿï¼Œè¯·ç™»å½•ä»¥ç»§ç»­</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç™»å½•ç³»ç»Ÿ</button>
            </form>
            <button class="link-btn" onclick="showForgotPassword()">å¿˜è®°å¯†ç ï¼Ÿ</button>
        </div>
        <!-- å¿˜è®°å¯†ç  -->
        <div class="login-box" id="forgotBox" style="display:none;">
            <h1>ğŸ”‘ å¿˜è®°å¯†ç </h1>
            <p>è¾“å…¥æ³¨å†Œé‚®ç®±ï¼Œæˆ‘ä»¬å°†å‘é€é‡ç½®é“¾æ¥</p>
            <form id="forgotForm">
                <div class="form-group">
                    <label>é‚®ç®±åœ°å€</label>
                    <input type="email" id="forgotEmail" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±" required>
                </div>
                <button type="submit" class="btn btn-primary">å‘é€é‡ç½®é‚®ä»¶</button>
            </form>
            <button class="link-btn" onclick="showLogin()">è¿”å›ç™»å½•</button>
        </div>
        <!-- é‡ç½®å¯†ç  -->
        <div class="login-box" id="resetBox" style="display:none;">
            <h1>ğŸ” é‡ç½®å¯†ç </h1>
            <p id="resetInfo">è¯·è¾“å…¥æ–°å¯†ç </p>
            <form id="resetForm">
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç¡®è®¤é‡ç½®</button>
            </form>
            <button class="link-btn" onclick="showLogin()">è¿”å›ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ’°</div>
                <div class="logo-text">è®°è´¦ç®¡ç†</div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    æ•°æ®æ¦‚è§ˆ
                </div>
                <div class="nav-item" data-page="expenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    è´¦å•ç®¡ç†
                </div>
                <div class="nav-item" data-page="users">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    ç”¨æˆ·ç®¡ç†
                </div>
                <div class="nav-item" data-page="categories">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M3 12h18"/><path d="M3 18h18"/><path d="M8 6v12"/></svg>
                    æ¶ˆè´¹ç±»åˆ«
                </div>
                <div class="nav-item" data-page="export">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    æ•°æ®å¯¼å‡º
                </div>
                <div class="nav-item" data-page="incomes">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7H14a3.5 3.5 0 0 1 0 7H6"/></svg>
                    æ”¶å…¥
                </div>
                <div class="nav-item" data-page="ai-models">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    AIæ¨¡å‹
                </div>
                <div class="nav-item" data-page="ai-analysis">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                    AIåˆ†æ
                </div>
                <div class="nav-item" data-page="ai-chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/><path d="M8 10h8"/><path d="M8 14h5"/></svg>
                    AIèŠå¤©
                </div>
            </nav>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="displayUsername">ç®¡ç†å‘˜</div>
                    <div class="user-role">ç³»ç»Ÿç®¡ç†å‘˜</div>
                </div>
                <button class="logout-btn" onclick="logout()" title="é€€å‡ºç™»å½•">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- æ•°æ®æ¦‚è§ˆé¡µ -->
            <div class="page-content active" id="page-dashboard">
                <div class="page-header"><div><h1 class="page-title">æ•°æ®æ¦‚è§ˆ</h1><p class="page-subtitle">æŸ¥çœ‹ç³»ç»Ÿæ•´ä½“æ•°æ®ç»Ÿè®¡</p></div></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon blue">ğŸ’µ</div><div class="stat-value" id="statTotalAmount">Â¥0.00</div><div class="stat-label">æ€»æ¶ˆè´¹é‡‘é¢</div></div>
                    <div class="stat-card"><div class="stat-icon green">ğŸ’°</div><div class="stat-value" id="statTotalIncome">Â¥0.00</div><div class="stat-label">æ€»æ”¶å…¥é‡‘é¢</div></div>
                    <div class="stat-card"><div class="stat-icon orange">ğŸ“</div><div class="stat-value" id="statTotalCount">0</div><div class="stat-label">æ¶ˆè´¹è®°å½•æ•°</div></div>
                    <div class="stat-card"><div class="stat-icon red">ğŸ“ˆ</div><div class="stat-value" id="statIncomeCount">0</div><div class="stat-label">æ”¶å…¥è®°å½•æ•°</div></div>
                </div>
                <div class="data-table-container">
                    <table class="data-table"><thead><tr><th>æ¶ˆè´¹ç±»åˆ«</th><th>æ¶ˆè´¹é‡‘é¢</th><th>è®°å½•æ•°é‡</th><th>å æ¯”</th></tr></thead><tbody id="categoryStatsTable"></tbody></table>
                </div>
            </div>

            <!-- è´¦å•ç®¡ç†é¡µ -->
            <div class="page-content" id="page-expenses">
                <div class="page-header">
                    <div><h1 class="page-title">è´¦å•ç®¡ç†</h1><p class="page-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„æ¶ˆè´¹è®°å½•</p></div>
                    <button class="btn btn-success" onclick="openExpenseModal()">â• æ·»åŠ è®°å½•</button>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="filterStartDate"></div>
                        <div class="filter-item"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="filterEndDate"></div>
                        <div class="filter-item"><label>æ¶ˆè´¹ç±»åˆ«</label><select id="filterCategory"><option value="">å…¨éƒ¨ç±»åˆ«</option></select></div>
                        <div class="filter-item"><label>ç”¨æˆ·å</label><input type="text" id="filterUsername" placeholder="æœç´¢ç”¨æˆ·å"></div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadExpenses()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table"><thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‡‘é¢</th><th>ç±»åˆ«</th><th>æè¿°</th><th>æ¶ˆè´¹æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="expensesTable"></tbody></table>
                    <div class="pagination"><div class="pagination-info" id="paginationInfo">å…± 0 æ¡è®°å½•</div><div class="pagination-buttons" id="paginationButtons"></div></div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†é¡µ -->
            <div class="page-content" id="page-users">
                <div class="page-header">
                    <div><h1 class="page-title">ç”¨æˆ·ç®¡ç†</h1><p class="page-subtitle">ç®¡ç†ç³»ç»Ÿç”¨æˆ·ï¼Œé‡ç½®ç”¨æˆ·å¯†ç </p></div>
                    <div id="emailStatus"></div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- æ¶ˆè´¹ç±»åˆ«é¡µ -->
            <div class="page-content" id="page-categories">
                <div class="page-header">
                    <div><h1 class="page-title">æ¶ˆè´¹ç±»åˆ«</h1><p class="page-subtitle">æ‰‹åŠ¨ç»´æŠ¤æ¶ˆè´¹ç±»åˆ«ï¼Œä¾›æ·»åŠ è´¦å•/ç­›é€‰ä½¿ç”¨</p></div>
                    <button class="btn btn-success" onclick="openCategoryModal()">â• æ·»åŠ ç±»åˆ«</button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>åç§°</th><th>æ’åº</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="categoriesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- æ•°æ®å¯¼å‡ºé¡µ -->
            <div class="page-content" id="page-export">
                <div class="page-header"><div><h1 class="page-title">æ•°æ®å¯¼å‡º</h1><p class="page-subtitle">æŒ‰æ—¶é—´èŒƒå›´å¯¼å‡ºæ¶ˆè´¹è®°å½•ä¸º Excel æ–‡ä»¶</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>å¼€å§‹æ—¥æœŸ *</label><input type="date" id="exportStartDate" required></div>
                        <div class="filter-item"><label>ç»“æŸæ—¥æœŸ *</label><input type="date" id="exportEndDate" required></div>
                        <div class="filter-actions"><button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ å¯¼å‡º Excel</button></div>
                    </div>
                </div>
                <div class="stat-card" style="max-width: 600px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px;">ğŸ“‹ å¯¼å‡ºè¯´æ˜</h3>
                    <ul style="color: var(--text-secondary); line-height: 2;"><li>è¯·é€‰æ‹©è¦å¯¼å‡ºçš„æ—¶é—´èŒƒå›´</li><li>å¯¼å‡ºæ–‡ä»¶æ ¼å¼ä¸º Excel (.xlsx)</li><li>æ–‡ä»¶åŒ…å«ï¼šIDã€ç”¨æˆ·åã€é‡‘é¢ã€ç±»åˆ«ã€æè¿°ã€æ¶ˆè´¹æ—¶é—´ã€åˆ›å»ºæ—¶é—´</li><li>æ–‡ä»¶æœ«å°¾åŒ…å«é‡‘é¢æ±‡æ€»ç»Ÿè®¡</li></ul>
                </div>
            </div>

            <!-- æ”¶å…¥ç®¡ç†é¡µ -->
            <div class="page-content" id="page-incomes">
                <div class="page-header">
                    <div><h1 class="page-title">æ”¶å…¥</h1><p class="page-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„æ”¶å…¥è®°å½•</p></div>
                    <button class="btn btn-success" onclick="openIncomeModal()">â• æ·»åŠ æ”¶å…¥</button>
                </div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="incomeFilterStartDate"></div>
                        <div class="filter-item"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="incomeFilterEndDate"></div>
                        <div class="filter-item"><label>æ”¶å…¥ç±»å‹</label><input type="text" id="incomeFilterType" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„"></div>
                        <div class="filter-item"><label>ç”¨æˆ·å</label><input type="text" id="incomeFilterUsername" placeholder="æœç´¢ç”¨æˆ·å"></div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="loadIncomes()">æŸ¥è¯¢</button>
                            <button class="btn btn-secondary" onclick="resetIncomeFilters()">é‡ç½®</button>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>æ”¶å…¥é‡‘é¢</th><th>æ”¶å…¥ç±»å‹</th><th>æ”¶å…¥æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="incomesTable"></tbody>
                    </table>
                    <div class="pagination">
                        <div class="pagination-info" id="incomePaginationInfo">å…± 0 æ¡è®°å½•</div>
                        <div class="pagination-buttons" id="incomePaginationButtons"></div>
                    </div>
                </div>
            </div>

            <!-- AIæ¨¡å‹ç®¡ç†é¡µ -->
            <div class="page-content" id="page-ai-models">
                <div class="page-header">
                    <div><h1 class="page-title">AIæ¨¡å‹ç®¡ç†</h1><p class="page-subtitle">é…ç½®å’Œç®¡ç†AIæ¨¡å‹ï¼Œç”¨äºè´¦å•åˆ†æ</p></div>
                    <button class="btn btn-success" onclick="openAIModelModal()">â• æ·»åŠ æ¨¡å‹</button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>æ¨¡å‹åç§°</th><th>è°ƒç”¨åœ°å€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="aiModelsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- AIåˆ†æé¡µ -->
            <div class="page-content" id="page-ai-analysis">
                <div class="page-header"><div><h1 class="page-title">AIåˆ†æ</h1><p class="page-subtitle">ä½¿ç”¨AIæ¨¡å‹åˆ†ææŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ¶ˆè´¹è®°å½•</p></div></div>
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="filter-item"><label>é€‰æ‹©AIæ¨¡å‹ *</label><select id="analysisModelId" onchange="onAnalysisModelChange()" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);"><option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option></select></div>
                        <div class="filter-item"><label>å¼€å§‹æ—¥æœŸ *</label><input type="date" id="analysisStartDate" required></div>
                        <div class="filter-item"><label>ç»“æŸæ—¥æœŸ *</label><input type="date" id="analysisEndDate" required></div>
                        <div class="filter-actions">
                            <button class="btn btn-success" onclick="startAIAnalysis()" id="analysisBtn">ğŸ¤– å¼€å§‹åˆ†æ</button>
                            <button class="btn btn-secondary" onclick="refreshAnalysisHistory()">åˆ·æ–°å†å²</button>
                        </div>
                    </div>
                </div>
                <div class="chat-layout" style="margin-top: 24px;">
                    <div class="chat-history">
                        <div class="chat-history-header">
                            <div style="font-weight:700;">åˆ†æå†å²</div>
                            <button class="btn btn-secondary btn-sm" onclick="refreshAnalysisHistory()">åˆ·æ–°</button>
                        </div>
                        <div class="chat-history-list" id="analysisHistoryList">
                            <div style="padding:16px;color:var(--text-secondary);text-align:center;">è¯·é€‰æ‹©AIæ¨¡å‹æŸ¥çœ‹å†å²</div>
                        </div>
                        <div class="pagination" style="border-top:1px solid var(--border);">
                            <div class="pagination-info" id="analysisPaginationInfo">ç¬¬ 1 / 1 é¡µ</div>
                            <div class="pagination-buttons" id="analysisPaginationButtons"></div>
                        </div>
                    </div>
                    <div class="chat-panel">
                        <div class="chat-panel-header">
                            <div style="display:flex;flex-direction:column;gap:2px;">
                                <div style="font-weight:700;">ğŸ“Š AIåˆ†æç»“æœ</div>
                                <div style="font-size:12px;color:var(--text-secondary);">æµå¼è¾“å‡ºç»“æŸåè‡ªåŠ¨æ¸²æŸ“ Markdown</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearAnalysisResult()">æ¸…ç©º</button>
                        </div>
                        <div class="chat-messages" id="aiAnalysisResult" style="white-space: normal;">
                            <div style="color: var(--text-secondary);">è¯·é€‰æ‹©AIæ¨¡å‹å’Œæ—¶é—´èŒƒå›´ï¼Œç„¶åç‚¹å‡»â€œå¼€å§‹åˆ†æâ€æŒ‰é’®</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIèŠå¤©é¡µ -->
            <div class="page-content" id="page-ai-chat">
                <div class="page-header">
                    <div><h1 class="page-title">AIèŠå¤©</h1><p class="page-subtitle">é€‰æ‹©AIæ¨¡å‹è¿›è¡Œå¯¹è¯ï¼Œæ”¯æŒæµå¼è¾“å‡ºå¹¶ä¿å­˜èŠå¤©è®°å½•</p></div>
                </div>
                <div class="chat-layout">
                    <div class="chat-history">
                        <div class="chat-history-header">
                            <div style="font-weight:700;">èŠå¤©è®°å½•</div>
                            <button class="btn btn-secondary btn-sm" onclick="refreshChatHistory()">åˆ·æ–°</button>
                        </div>
                        <div style="padding: 12px 12px 0;">
                            <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-secondary);font-weight:500;">é€‰æ‹©AIæ¨¡å‹ *</label>
                            <select id="chatModelId" onchange="onChatModelChange()" style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                                <option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>
                            </select>
                        </div>
                        <div class="chat-history-list" id="chatHistoryList">
                            <div style="padding:16px;color:var(--text-secondary);text-align:center;">è¯·é€‰æ‹©æ¨¡å‹æŸ¥çœ‹å†å²</div>
                        </div>
                    </div>
                    <div class="chat-panel">
                        <div class="chat-panel-header">
                            <div style="display:flex;flex-direction:column;gap:2px;">
                                <div style="font-weight:700;">å¯¹è¯çª—å£</div>
                                <div style="font-size:12px;color:var(--text-secondary);">å‘é€æ¶ˆæ¯åå°†æµå¼è¿”å›ï¼Œå¹¶è‡ªåŠ¨ä¿å­˜æœ¬è½®å¯¹è¯</div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearChatWindow()">æ¸…ç©ºçª—å£</button>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div style="color:var(--text-secondary);">è¯·é€‰æ‹©AIæ¨¡å‹ï¼Œç„¶åå¼€å§‹èŠå¤©ã€‚</div>
                        </div>
                        <div class="chat-input">
                            <textarea id="chatInput" placeholder="è¾“å…¥ä½ æƒ³é—®AIçš„é—®é¢˜..."></textarea>
                            <button class="btn btn-success" onclick="sendChatMessage()" id="chatSendBtn">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ” é‡ç½®ç”¨æˆ·å¯†ç </div>
            <div class="modal-subtitle">ç”¨æˆ·ï¼š<span id="resetModalUser"></span></div>
            <div class="form-group">
                <label>æ–°å¯†ç </label>
                <input type="password" id="adminNewPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeResetModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmAdminReset()">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¶ˆè´¹è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="expenseModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="expenseModalTitle">â• æ·»åŠ æ¶ˆè´¹è®°å½•</div>
            <div class="modal-subtitle" id="expenseModalSubtitle">å¡«å†™æ¶ˆè´¹è®°å½•ä¿¡æ¯</div>
            <form id="expenseForm">
                <div class="form-group">
                    <label>é€‰æ‹©ç”¨æˆ· *</label>
                    <select id="expenseUserId" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>æ¶ˆè´¹é‡‘é¢ *</label>
                        <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>æ¶ˆè´¹ç±»åˆ« *</label>
                        <select id="expenseCategory" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                            <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ¶ˆè´¹æ—¶é—´ *</label>
                    <input type="datetime-local" id="expenseTime" required>
                </div>
                <div class="form-group">
                    <label>æè¿°è¯´æ˜</label>
                    <input type="text" id="expenseDescription" placeholder="å¯é€‰ï¼Œç®€è¦æè¿°æ­¤ç¬”æ¶ˆè´¹">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="expenseSubmitBtn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-subtitle">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆè´¹è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- AIæ¨¡å‹ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="aiModelModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title" id="aiModelModalTitle">â• æ·»åŠ AIæ¨¡å‹</div>
            <div class="modal-subtitle" id="aiModelModalSubtitle">é…ç½®AIæ¨¡å‹çš„è°ƒç”¨ä¿¡æ¯</div>
            <form id="aiModelForm">
                <div class="form-group">
                    <label>æ¨¡å‹åç§° *</label>
                    <input type="text" id="aiModelName" placeholder="ä¾‹å¦‚ï¼šOpenAI GPT-4" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>è°ƒç”¨åœ°å€ *</label>
                    <input type="url" id="aiModelBaseURL" placeholder="https://api.openai.com/v1" required>
                </div>
                <div class="form-group">
                    <label>APIå¯†é’¥ *</label>
                    <input type="password" id="aiModelAPIKey" placeholder="sk-..." required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAIModelModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="aiModelSubmitBtn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤AIæ¨¡å‹ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteAIModelModal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-subtitle">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAIæ¨¡å‹é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteAIModelModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDeleteAIModel()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ¶ˆè´¹ç±»åˆ«æ¨¡æ€æ¡† -->
    <div class="modal" id="categoryModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="categoryModalTitle">â• æ·»åŠ æ¶ˆè´¹ç±»åˆ«</div>
            <div class="modal-subtitle" id="categoryModalSubtitle">ç»´æŠ¤ç±»åˆ«åç§°ä¸æ’åº</div>
            <form id="categoryForm">
                <div class="form-group">
                    <label>ç±»åˆ«åç§° *</label>
                    <input type="text" id="categoryName" placeholder="ä¾‹å¦‚ï¼šé¤é¥®" required maxlength="50">
                </div>
                <div class="form-group">
                    <label>æ’åºï¼ˆè¶Šå°è¶Šé å‰ï¼‰</label>
                    <input type="number" id="categorySort" placeholder="ä¾‹å¦‚ï¼š10" step="1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="categorySubmitBtn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤æ¶ˆè´¹ç±»åˆ«ç¡®è®¤ -->
    <div class="modal" id="deleteCategoryModal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-subtitle">ç¡®å®šè¦åˆ é™¤è¯¥æ¶ˆè´¹ç±»åˆ«å—ï¼Ÿï¼ˆè½¯åˆ é™¤ï¼‰</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteCategoryModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDeleteCategory()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ”¶å…¥æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="incomeModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-title" id="incomeModalTitle">â• æ·»åŠ æ”¶å…¥</div>
            <div class="modal-subtitle" id="incomeModalSubtitle">å¡«å†™æ”¶å…¥ä¿¡æ¯</div>
            <form id="incomeForm">
                <div class="form-group">
                    <label>é€‰æ‹©ç”¨æˆ· *</label>
                    <select id="incomeUserId" required style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg-input);color:var(--text-primary);">
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="form-group">
                        <label>æ”¶å…¥é‡‘é¢ *</label>
                        <input type="number" id="incomeAmount" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>æ”¶å…¥ç±»å‹ *</label>
                        <input type="text" id="incomeType" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„" required maxlength="50">
                    </div>
                </div>
                <div class="form-group">
                    <label>æ”¶å…¥æ—¶é—´ *</label>
                    <input type="datetime-local" id="incomeTime" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIncomeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="incomeSubmitBtn">ç¡®è®¤æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤æ”¶å…¥ç¡®è®¤ -->
    <div class="modal" id="deleteIncomeModal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            <div class="modal-subtitle">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¶å…¥è®°å½•å—ï¼Ÿï¼ˆè½¯åˆ é™¤ï¼‰</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteIncomeModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDeleteIncome()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1, totalPages = 1, currentUsername = '', resetToken = '', resetUserId = null, emailEnabled = false;
        let editingExpenseId = null, deleteExpenseId = null, allUsers = [];
        let editingAIModelId = null, deleteAIModelId = null, allAIModels = [];
        let chatStreaming = false, chatCurrentAIEl = null, chatHistoryPage = 1;
        let analysisHistoryPage = 1, analysisHistoryPageSize = 10, analysisHistoryTotalPages = 1;
        let allCategories = [], editingCategoryId = null, deleteCategoryId = null;
        let incomeCurrentPage = 1, incomeTotalPages = 1, editingIncomeId = null, deleteIncomeId = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkResetToken();
            checkAuth();
            initNavigation();
            setDefaultDates();
        });

        function checkResetToken() {
            const hash = window.location.hash;
            if (hash.includes('reset-password')) {
                const params = new URLSearchParams(hash.split('?')[1]);
                resetToken = params.get('token');
                if (resetToken) verifyResetToken();
            }
        }

        async function verifyResetToken() {
            try {
                const res = await fetch(`/admin/password/verify-token?token=${resetToken}`);
                const data = await res.json();
                if (data.success) {
                    showResetPassword(data.data.username);
                } else {
                    showToast(data.message, 'error');
                    showLogin();
                }
            } catch (e) { showToast('éªŒè¯å¤±è´¥', 'error'); showLogin(); }
        }

        function showLogin() {
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('forgotBox').style.display = 'none';
            document.getElementById('resetBox').style.display = 'none';
            window.location.hash = '';
        }

        function showForgotPassword() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('forgotBox').style.display = 'block';
            document.getElementById('resetBox').style.display = 'none';
        }

        function showResetPassword(username) {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('forgotBox').style.display = 'none';
            document.getElementById('resetBox').style.display = 'block';
            document.getElementById('resetInfo').textContent = `ä¸ºç”¨æˆ· ${username} è®¾ç½®æ–°å¯†ç `;
        }

        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            try {
                const res = await fetch('/admin/password/request-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) showLogin();
            } catch (e) { showToast('è¯·æ±‚å¤±è´¥', 'error'); }
        });

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            if (newPwd !== confirmPwd) { showToast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error'); return; }
            try {
                const res = await fetch('/admin/password/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: resetToken, new_password: newPwd })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) { showLogin(); window.location.hash = ''; }
            } catch (e) { showToast('é‡ç½®å¤±è´¥', 'error'); }
        });

        function checkAuth() {
            const username = getCookie('admin_username');
            if (username) { currentUsername = username; showApp(); loadStatistics(); loadEmailConfig(); }
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('displayUsername').textContent = currentUsername;
            document.getElementById('userAvatar').textContent = currentUsername.charAt(0).toUpperCase();
        }

        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    switchPage(page);
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                });
            });
        }

        function switchPage(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
            if (page === 'dashboard') loadStatistics();
            else if (page === 'expenses') loadExpenses();
            else if (page === 'users') loadUsers();
            else if (page === 'categories') loadCategories();
            else if (page === 'incomes') { setDefaultIncomeDates(); loadIncomes(); }
            else if (page === 'ai-models') loadAIModels();
            else if (page === 'ai-analysis') { loadAIModelsForAnalysis(); setDefaultAnalysisDates(); }
            else if (page === 'ai-chat') { loadAIModelsForChat(); }
        }

        function setDefaultIncomeDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const s = document.getElementById('incomeFilterStartDate');
            const e = document.getElementById('incomeFilterEndDate');
            if (s && !s.value) s.value = formatDate(firstDay);
            if (e && !e.value) e.value = formatDate(today);
        }

        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('filterStartDate').value = formatDate(firstDay);
            document.getElementById('filterEndDate').value = formatDate(today);
            document.getElementById('exportStartDate').value = formatDate(firstDay);
            document.getElementById('exportEndDate').value = formatDate(today);
        }

        function setDefaultAnalysisDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('analysisStartDate').value = formatDate(firstDay);
            document.getElementById('analysisEndDate').value = formatDate(today);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    currentUsername = username;
                    showToast('ç™»å½•æˆåŠŸ', 'success');
                    showApp();
                    loadStatistics();
                    loadEmailConfig();
                } else { showToast(data.message || 'ç™»å½•å¤±è´¥', 'error'); }
            } catch (err) { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
        });

        async function logout() {
            try { await fetch('/admin/logout', { method: 'POST' }); } catch (e) {}
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            showLogin();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        async function loadEmailConfig() {
            try {
                const res = await fetch('/admin/email-config');
                const data = await res.json();
                if (data.success) {
                    emailEnabled = data.data.enabled;
                    document.getElementById('emailStatus').innerHTML = emailEnabled 
                        ? '<span class="email-badge">é‚®ä»¶æœåŠ¡å·²å¯ç”¨</span>'
                        : '<span class="email-badge disabled">é‚®ä»¶æœåŠ¡æœªå¯ç”¨</span>';
                }
            } catch (e) {}
        }

        async function loadStatistics() {
            try {
                const res = await fetch('/admin/statistics');
                const data = await res.json();
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('statTotalAmount').textContent = `Â¥${stats.total_amount.toFixed(2)}`;
                    document.getElementById('statTotalCount').textContent = stats.total_count;
                    document.getElementById('statTotalIncome').textContent = `Â¥${(stats.total_income || 0).toFixed(2)}`;
                    document.getElementById('statIncomeCount').textContent = stats.income_count || 0;
                    const tbody = document.getElementById('categoryStatsTable');
                    if (stats.category_stats && stats.category_stats.length > 0) {
                        tbody.innerHTML = stats.category_stats.map(cat => `<tr><td><span class="category-tag ${cat.category}">${cat.category}</span></td><td class="amount">Â¥${cat.total.toFixed(2)}</td><td>${cat.count} æ¡</td><td>${((cat.total / stats.total_amount) * 100).toFixed(1)}%</td></tr>`).join('');
                    } else { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>'; }
                }
            } catch (err) { console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', err); }
        }

        async function loadExpenses() {
            // ç¡®ä¿ç­›é€‰ä¸‹æ‹‰æ˜¯æœ€æ–°çš„æ•°æ®åº“ç±»åˆ«
            if (!allCategories || allCategories.length === 0) {
                await refreshExpenseCategorySelectors();
            }
            const params = new URLSearchParams({ page: currentPage, page_size: 15 });
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            const username = document.getElementById('filterUsername').value;
            if (startDate) params.append('start_time', startDate);
            if (endDate) params.append('end_time', endDate);
            if (category) params.append('category', category);
            if (username) params.append('username', username);
            try {
                const res = await fetch(`/admin/expenses?${params}`);
                const data = await res.json();
                if (data.success) renderExpensesTable(data.data);
            } catch (err) { console.error('åŠ è½½æ¶ˆè´¹è®°å½•å¤±è´¥:', err); }
        }

        function renderExpensesTable(data) {
            const tbody = document.getElementById('expensesTable');
            if (!data.list || data.list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— æ¶ˆè´¹è®°å½•</td></tr>';
            } else {
                tbody.innerHTML = data.list.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.username || '-'}</td>
                        <td class="amount">Â¥${item.amount.toFixed(2)}</td>
                        <td><span class="category-tag ${item.category}">${item.category}</span></td>
                        <td>${item.description || '-'}</td>
                        <td>${formatDateTime(item.expense_time)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditExpenseModal(${item.id}, ${item.user_id}, ${item.amount}, '${item.category}', '${item.description || ''}', '${item.expense_time}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteModal(${item.id})">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            totalPages = Math.ceil(data.total / data.page_size) || 1;
            document.getElementById('paginationInfo').textContent = `å…± ${data.total} æ¡è®°å½•ï¼Œç¬¬ ${data.page} / ${totalPages} é¡µ`;
            renderPagination();
        }

        function renderPagination() {
            const container = document.getElementById('paginationButtons');
            let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            for (let i = 1; i <= totalPages && i <= 5; i++) html += `<button class="page-btn ${currentPage === i ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            if (totalPages > 5) html += `<span style="padding: 8px;">...</span><button class="page-btn ${currentPage === totalPages ? 'active' : ''}" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) { if (page < 1 || page > totalPages) return; currentPage = page; loadExpenses(); }
        function resetFilters() { setDefaultDates(); document.getElementById('filterCategory').value = ''; document.getElementById('filterUsername').value = ''; currentPage = 1; loadExpenses(); }

        async function loadUsers() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) renderUsersTable(data.data);
            } catch (err) { console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err); }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— ç”¨æˆ·</td></tr>';
            } else {
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '<span style="color:var(--text-secondary)">æœªè®¾ç½®</span>'}</td>
                        <td>${formatDateTime(user.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-warning btn-sm" onclick="openResetModal(${user.id}, '${user.username}')">é‡ç½®å¯†ç </button>
                                ${user.email && emailEnabled ? `<button class="btn btn-primary btn-sm" onclick="sendResetEmail(${user.id})">å‘é€é‚®ä»¶</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function openResetModal(userId, username) {
            resetUserId = userId;
            document.getElementById('resetModalUser').textContent = username;
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal() { document.getElementById('resetModal').classList.remove('show'); resetUserId = null; }

        async function confirmAdminReset() {
            const newPassword = document.getElementById('adminNewPassword').value;
            if (!newPassword || newPassword.length < 6) { showToast('å¯†ç è‡³å°‘éœ€è¦6ä½', 'warning'); return; }
            try {
                const res = await fetch('/admin/password/admin-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: resetUserId, new_password: newPassword })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                if (data.success) closeResetModal();
            } catch (e) { showToast('é‡ç½®å¤±è´¥', 'error'); }
        }

        async function sendResetEmail(userId) {
            if (!confirm('ç¡®å®šè¦å‘é€å¯†ç é‡ç½®é‚®ä»¶å—ï¼Ÿ')) return;
            try {
                const res = await fetch('/admin/password/send-reset-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
            } catch (e) { showToast('å‘é€å¤±è´¥', 'error'); }
        }

        function exportExcel() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            if (!startDate || !endDate) { showToast('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´', 'warning'); return; }
            window.location.href = `/admin/export/excel?start_time=${startDate}&end_time=${endDate}`;
            showToast('æ­£åœ¨ç”Ÿæˆ Excel...', 'success');
        }

        // ===== æ¶ˆè´¹ç±»åˆ«ç®¡ç†åŠŸèƒ½ =====
        async function loadCategories() {
            await loadCategoriesFromServer();
            renderCategoriesTable();
            // åŒæ­¥åˆ·æ–°è´¦å•é¡µé¢ä¸‹æ‹‰
            renderCategoryOptions(document.getElementById('filterCategory'), true);
            renderCategoryOptions(document.getElementById('expenseCategory'), false);
        }

        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTable');
            if (!tbody) return;
            if (!allCategories || allCategories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— ç±»åˆ«</td></tr>';
                return;
            }
            tbody.innerHTML = allCategories.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.sort ?? 0}</td>
                    <td>${formatDateTime(c.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="openEditCategoryModal(${c.id}, '${(c.name || '').replace(/'/g, "\\'")}', ${c.sort ?? 0})">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteCategoryModal(${c.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openCategoryModal() {
            editingCategoryId = null;
            document.getElementById('categoryModalTitle').textContent = 'â• æ·»åŠ æ¶ˆè´¹ç±»åˆ«';
            document.getElementById('categoryModalSubtitle').textContent = 'ç»´æŠ¤ç±»åˆ«åç§°ä¸æ’åº';
            document.getElementById('categorySubmitBtn').textContent = 'ç¡®è®¤æ·»åŠ ';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModal').classList.add('show');
        }

        function openEditCategoryModal(id, name, sort) {
            editingCategoryId = id;
            document.getElementById('categoryModalTitle').textContent = 'âœï¸ ç¼–è¾‘æ¶ˆè´¹ç±»åˆ«';
            document.getElementById('categoryModalSubtitle').textContent = `ç¼–è¾‘ ID: ${id}`;
            document.getElementById('categorySubmitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('categoryName').value = name || '';
            document.getElementById('categorySort').value = (sort ?? 0);
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
            editingCategoryId = null;
        }

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = (document.getElementById('categoryName').value || '').trim();
            const sortStr = document.getElementById('categorySort').value;
            const sort = sortStr === '' ? 0 : parseInt(sortStr, 10);
            if (!name) { showToast('è¯·è¾“å…¥ç±»åˆ«åç§°', 'warning'); return; }

            try {
                let res;
                if (editingCategoryId) {
                    res = await fetch(`/admin/categories/${editingCategoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort })
                    });
                } else {
                    res = await fetch('/admin/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, sort })
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'æˆåŠŸ', 'success');
                    closeCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message || 'å¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        });

        function openDeleteCategoryModal(id) {
            deleteCategoryId = id;
            document.getElementById('deleteCategoryModal').classList.add('show');
        }

        function closeDeleteCategoryModal() {
            document.getElementById('deleteCategoryModal').classList.remove('show');
            deleteCategoryId = null;
        }

        async function confirmDeleteCategory() {
            if (!deleteCategoryId) return;
            try {
                const res = await fetch(`/admin/categories/${deleteCategoryId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteCategoryModal();
                    loadCategories();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ===== æ”¶å…¥ç®¡ç†åŠŸèƒ½ =====
        async function loadUsersForIncomeSelect() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('incomeUserId');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>' +
                        (data.data || []).map(u => `<option value="${u.id}">${u.username}</option>`).join('');
                }
            } catch (e) {}
        }

        function openIncomeModal() {
            editingIncomeId = null;
            document.getElementById('incomeModalTitle').textContent = 'â• æ·»åŠ æ”¶å…¥';
            document.getElementById('incomeModalSubtitle').textContent = 'å¡«å†™æ”¶å…¥ä¿¡æ¯';
            document.getElementById('incomeSubmitBtn').textContent = 'ç¡®è®¤æ·»åŠ ';
            document.getElementById('incomeForm').reset();
            const now = new Date();
            document.getElementById('incomeTime').value = formatDateTimeLocal(now);
            loadUsersForIncomeSelect();
            document.getElementById('incomeModal').classList.add('show');
        }

        function openEditIncomeModal(id, userId, amount, type, incomeTime) {
            editingIncomeId = id;
            document.getElementById('incomeModalTitle').textContent = 'âœï¸ ç¼–è¾‘æ”¶å…¥';
            document.getElementById('incomeModalSubtitle').textContent = `ç¼–è¾‘ ID: ${id}`;
            document.getElementById('incomeSubmitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('incomeAmount').value = amount;
            document.getElementById('incomeType').value = type || '';
            document.getElementById('incomeTime').value = formatDateTimeLocal(incomeTime);
            loadUsersForIncomeSelect();
            setTimeout(() => { document.getElementById('incomeUserId').value = userId; }, 80);
            document.getElementById('incomeModal').classList.add('show');
        }

        function closeIncomeModal() {
            document.getElementById('incomeModal').classList.remove('show');
            editingIncomeId = null;
        }

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = parseInt(document.getElementById('incomeUserId').value);
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const type = (document.getElementById('incomeType').value || '').trim();
            const timeStr = document.getElementById('incomeTime').value;
            if (!userId || !amount || !type || !timeStr) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'warning');
                return;
            }
            const payload = {
                user_id: userId,
                amount: amount,
                type: type,
                income_time: formatDateTimeForApi(timeStr)
            };
            try {
                let res;
                if (editingIncomeId) {
                    res = await fetch(`/admin/incomes/${editingIncomeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    res = await fetch('/admin/incomes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'æˆåŠŸ', 'success');
                    closeIncomeModal();
                    loadIncomes();
                    loadStatistics();
                } else {
                    showToast(data.message || 'å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        });

        async function loadIncomes() {
            const params = new URLSearchParams({ page: incomeCurrentPage, page_size: 15 });
            const startDate = document.getElementById('incomeFilterStartDate').value;
            const endDate = document.getElementById('incomeFilterEndDate').value;
            const type = document.getElementById('incomeFilterType').value;
            const username = document.getElementById('incomeFilterUsername').value;
            if (startDate) params.append('start_time', startDate);
            if (endDate) params.append('end_time', endDate);
            if (type) params.append('type', type);
            if (username) params.append('username', username);
            try {
                const res = await fetch(`/admin/incomes?${params}`);
                const data = await res.json();
                if (data.success) renderIncomesTable(data.data);
            } catch (e) {}
        }

        function renderIncomesTable(data) {
            const tbody = document.getElementById('incomesTable');
            if (!data.list || data.list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— æ”¶å…¥è®°å½•</td></tr>';
            } else {
                tbody.innerHTML = data.list.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.username || '-'}</td>
                        <td class="amount" style="color: var(--success);">Â¥${item.amount.toFixed(2)}</td>
                        <td>${item.type || '-'}</td>
                        <td>${formatDateTime(item.income_time)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditIncomeModal(${item.id}, ${item.user_id}, ${item.amount}, ${JSON.stringify(item.type || '')}, ${JSON.stringify(item.income_time)})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteIncomeModal(${item.id})">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            incomeTotalPages = Math.ceil(data.total / data.page_size) || 1;
            document.getElementById('incomePaginationInfo').textContent = `å…± ${data.total} æ¡è®°å½•ï¼Œç¬¬ ${data.page} / ${incomeTotalPages} é¡µ`;
            renderIncomePagination();
        }

        function renderIncomePagination() {
            const container = document.getElementById('incomePaginationButtons');
            let html = `<button class="page-btn" onclick="goToIncomePage(${incomeCurrentPage - 1})" ${incomeCurrentPage <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            html += `<button class="page-btn" onclick="goToIncomePage(${incomeCurrentPage + 1})" ${incomeCurrentPage >= incomeTotalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            container.innerHTML = html;
        }

        function goToIncomePage(page) {
            if (page < 1 || page > incomeTotalPages) return;
            incomeCurrentPage = page;
            loadIncomes();
        }

        function resetIncomeFilters() {
            document.getElementById('incomeFilterType').value = '';
            document.getElementById('incomeFilterUsername').value = '';
            document.getElementById('incomeFilterStartDate').value = '';
            document.getElementById('incomeFilterEndDate').value = '';
            incomeCurrentPage = 1;
            setDefaultIncomeDates();
            loadIncomes();
        }

        function openDeleteIncomeModal(id) {
            deleteIncomeId = id;
            document.getElementById('deleteIncomeModal').classList.add('show');
        }

        function closeDeleteIncomeModal() {
            document.getElementById('deleteIncomeModal').classList.remove('show');
            deleteIncomeId = null;
        }

        async function confirmDeleteIncome() {
            if (!deleteIncomeId) return;
            try {
                const res = await fetch(`/admin/incomes/${deleteIncomeId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteIncomeModal();
                    loadIncomes();
                    loadStatistics();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function formatDateTime(str) { if (!str) return '-'; return new Date(str).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }
        function formatDateTimeLocal(str) {
            if (!str) return '';
            const d = new Date(str);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        function formatDateTimeForApi(str) {
            if (!str) return '';
            const d = new Date(str);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift(); return null; }
        function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }

        // ===== æ¶ˆè´¹è®°å½•ç®¡ç†åŠŸèƒ½ =====
        async function loadUsersForSelect() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.success) {
                    allUsers = data.data;
                    const select = document.getElementById('expenseUserId');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>' + 
                        allUsers.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
                }
            } catch (e) { console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', e); }
        }

        async function loadCategoriesFromServer() {
            try {
                const res = await fetch('/admin/categories');
                const data = await res.json();
                if (data.success) {
                    allCategories = data.data || [];
                } else {
                    allCategories = [];
                }
            } catch (e) {
                allCategories = [];
            }
            return allCategories;
        }

        function renderCategoryOptions(selectEl, includeAll = false) {
            if (!selectEl) return;
            const current = selectEl.value;
            let html = includeAll ? '<option value="">å…¨éƒ¨ç±»åˆ«</option>' : '<option value="">è¯·é€‰æ‹©ç±»åˆ«</option>';
            html += (allCategories || []).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            selectEl.innerHTML = html;
            if (current) selectEl.value = current;
        }

        async function refreshExpenseCategorySelectors() {
            await loadCategoriesFromServer();
            renderCategoryOptions(document.getElementById('filterCategory'), true);
            renderCategoryOptions(document.getElementById('expenseCategory'), false);
        }

        function openExpenseModal() {
            editingExpenseId = null;
            document.getElementById('expenseModalTitle').textContent = 'â• æ·»åŠ æ¶ˆè´¹è®°å½•';
            document.getElementById('expenseModalSubtitle').textContent = 'å¡«å†™æ¶ˆè´¹è®°å½•ä¿¡æ¯';
            document.getElementById('expenseSubmitBtn').textContent = 'ç¡®è®¤æ·»åŠ ';
            document.getElementById('expenseForm').reset();
            // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            document.getElementById('expenseTime').value = formatDateTimeLocal(now);
            loadUsersForSelect();
            refreshExpenseCategorySelectors();
            document.getElementById('expenseModal').classList.add('show');
        }

        function openEditExpenseModal(id, userId, amount, category, description, expenseTime) {
            editingExpenseId = id;
            document.getElementById('expenseModalTitle').textContent = 'âœï¸ ç¼–è¾‘æ¶ˆè´¹è®°å½•';
            document.getElementById('expenseModalSubtitle').textContent = `ç¼–è¾‘ ID: ${id} çš„æ¶ˆè´¹è®°å½•`;
            document.getElementById('expenseSubmitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            loadUsersForSelect().then(() => {
                document.getElementById('expenseUserId').value = userId;
            });
            document.getElementById('expenseAmount').value = amount;
            refreshExpenseCategorySelectors().then(() => {
                document.getElementById('expenseCategory').value = category;
            });
            document.getElementById('expenseDescription').value = description;
            document.getElementById('expenseTime').value = formatDateTimeLocal(expenseTime);
            loadUsersForSelect();
            setTimeout(() => { document.getElementById('expenseUserId').value = userId; }, 100);
            document.getElementById('expenseModal').classList.add('show');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('show');
            editingExpenseId = null;
        }

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = parseInt(document.getElementById('expenseUserId').value);
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;
            const expenseTime = document.getElementById('expenseTime').value;

            if (!userId || !amount || !category || !expenseTime) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'warning');
                return;
            }

            const data = {
                user_id: userId,
                amount: amount,
                category: category,
                description: description,
                expense_time: formatDateTimeForApi(expenseTime)
            };

            try {
                let res;
                if (editingExpenseId) {
                    // ç¼–è¾‘æ¨¡å¼
                    res = await fetch(`/admin/expenses/${editingExpenseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // æ·»åŠ æ¨¡å¼
                    res = await fetch('/admin/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeExpenseModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (err) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        });

        function openDeleteModal(id) {
            deleteExpenseId = id;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteExpenseId = null;
        }

        async function confirmDelete() {
            if (!deleteExpenseId) return;
            try {
                const res = await fetch(`/admin/expenses/${deleteExpenseId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ===== AIæ¨¡å‹ç®¡ç†åŠŸèƒ½ =====
        async function loadAIModels() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data;
                    renderAIModelsTable(data.data);
                }
            } catch (e) {
                console.error('åŠ è½½AIæ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        function renderAIModelsTable(models) {
            const tbody = document.getElementById('aiModelsTable');
            if (!models || models.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— AIæ¨¡å‹é…ç½®</td></tr>';
            } else {
                tbody.innerHTML = models.map(model => `
                    <tr>
                        <td>${model.id}</td>
                        <td><strong>${model.name}</strong></td>
                        <td style="word-break: break-all; color: var(--text-secondary);">${model.base_url}</td>
                        <td>${formatDateTime(model.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="openEditAIModelModal(${model.id}, '${model.name}', '${model.base_url}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="openDeleteAIModelModal(${model.id})">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function openAIModelModal() {
            editingAIModelId = null;
            document.getElementById('aiModelModalTitle').textContent = 'â• æ·»åŠ AIæ¨¡å‹';
            document.getElementById('aiModelModalSubtitle').textContent = 'é…ç½®AIæ¨¡å‹çš„è°ƒç”¨ä¿¡æ¯';
            document.getElementById('aiModelSubmitBtn').textContent = 'ç¡®è®¤æ·»åŠ ';
            document.getElementById('aiModelForm').reset();
            document.getElementById('aiModelModal').classList.add('show');
        }

        function openEditAIModelModal(id, name, baseURL) {
            editingAIModelId = id;
            document.getElementById('aiModelModalTitle').textContent = 'âœï¸ ç¼–è¾‘AIæ¨¡å‹';
            document.getElementById('aiModelModalSubtitle').textContent = `ç¼–è¾‘ ID: ${id} çš„AIæ¨¡å‹é…ç½®`;
            document.getElementById('aiModelSubmitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('aiModelName').value = name;
            document.getElementById('aiModelBaseURL').value = baseURL;
            document.getElementById('aiModelAPIKey').value = ''; // ä¸æ˜¾ç¤ºåŸå¯†é’¥ï¼Œéœ€è¦é‡æ–°è¾“å…¥
            document.getElementById('aiModelAPIKey').placeholder = 'å¦‚éœ€æ›´æ–°å¯†é’¥ï¼Œè¯·è¾“å…¥æ–°å¯†é’¥';
            document.getElementById('aiModelAPIKey').required = false; // ç¼–è¾‘æ—¶å¯†é’¥å¯é€‰
            document.getElementById('aiModelModal').classList.add('show');
        }

        function closeAIModelModal() {
            document.getElementById('aiModelModal').classList.remove('show');
            editingAIModelId = null;
            document.getElementById('aiModelAPIKey').required = true; // æ¢å¤å¿…å¡«
            document.getElementById('aiModelAPIKey').placeholder = 'sk-...';
        }

        document.getElementById('aiModelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('aiModelName').value;
            const baseURL = document.getElementById('aiModelBaseURL').value;
            const apiKey = document.getElementById('aiModelAPIKey').value;

            if (!name || !baseURL) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'warning');
                return;
            }

            // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœAPIå¯†é’¥ä¸ºç©ºï¼Œåˆ™ä¸æ›´æ–°å¯†é’¥
            const data = {
                name: name,
                base_url: baseURL
            };
            if (apiKey || !editingAIModelId) {
                data.api_key = apiKey;
            }

            try {
                let res;
                if (editingAIModelId) {
                    res = await fetch(`/admin/ai-models/${editingAIModelId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/admin/ai-models', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeAIModelModal();
                    loadAIModels();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (err) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        });

        function openDeleteAIModelModal(id) {
            deleteAIModelId = id;
            document.getElementById('deleteAIModelModal').classList.add('show');
        }

        function closeDeleteAIModelModal() {
            document.getElementById('deleteAIModelModal').classList.remove('show');
            deleteAIModelId = null;
        }

        async function confirmDeleteAIModel() {
            if (!deleteAIModelId) return;
            try {
                const res = await fetch(`/admin/ai-models/${deleteAIModelId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteAIModelModal();
                    loadAIModels();
                    loadAIModelsForAnalysis(); // åŒæ—¶æ›´æ–°åˆ†æé¡µé¢çš„ä¸‹æ‹‰åˆ—è¡¨
                } else {
                    showToast(data.message, 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ===== AIåˆ†æåŠŸèƒ½ =====
        async function loadAIModelsForAnalysis() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data;
                    const select = document.getElementById('analysisModelId');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>' + 
                        data.data.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    // é»˜è®¤åŠ è½½ä¸€æ¬¡å†å²
                    refreshAnalysisHistory();
                }
            } catch (e) {
                console.error('åŠ è½½AIæ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        function clearAnalysisResult() {
            const resultDiv = document.getElementById('aiAnalysisResult');
            resultDiv.innerHTML = '<div style="color: var(--text-secondary);">è¯·é€‰æ‹©AIæ¨¡å‹å’Œæ—¶é—´èŒƒå›´ï¼Œç„¶åç‚¹å‡»â€œå¼€å§‹åˆ†æâ€æŒ‰é’®</div>';
        }

        function onAnalysisModelChange() {
            analysisHistoryPage = 1;
            refreshAnalysisHistory();
        }

        async function refreshAnalysisHistory() {
            const modelId = document.getElementById('analysisModelId').value;
            const listEl = document.getElementById('analysisHistoryList');
            if (!modelId) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">è¯·é€‰æ‹©AIæ¨¡å‹æŸ¥çœ‹å†å²</div>';
                document.getElementById('analysisPaginationInfo').textContent = 'ç¬¬ 1 / 1 é¡µ';
                document.getElementById('analysisPaginationButtons').innerHTML = '';
                return;
            }
            try {
                const params = new URLSearchParams({ model_id: modelId, page: analysisHistoryPage, page_size: analysisHistoryPageSize });
                const res = await fetch(`/admin/ai-analysis/history?${params}`);
                const data = await res.json();
                if (!data.success) {
                    listEl.innerHTML = `<div style="padding:16px;color:var(--danger);text-align:center;">${data.message || 'åŠ è½½å¤±è´¥'}</div>`;
                    return;
                }
                const total = (data.data && typeof data.data.total === 'number') ? data.data.total : 0;
                analysisHistoryTotalPages = Math.max(1, Math.ceil(total / analysisHistoryPageSize));
                // é˜²æ­¢åˆ é™¤åé¡µç è¶Šç•Œ
                if (analysisHistoryPage > analysisHistoryTotalPages) {
                    analysisHistoryPage = analysisHistoryTotalPages;
                    return refreshAnalysisHistory();
                }
                renderAnalysisHistory(data.data.list || []);
                renderAnalysisPagination(total);
            } catch (e) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--danger);text-align:center;">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderAnalysisPagination(total) {
            const info = document.getElementById('analysisPaginationInfo');
            const btns = document.getElementById('analysisPaginationButtons');
            info.textContent = `å…± ${total} æ¡ï¼Œç¬¬ ${analysisHistoryPage} / ${analysisHistoryTotalPages} é¡µ`;
            btns.innerHTML = `
                <button class="page-btn" onclick="goToAnalysisPage(${analysisHistoryPage - 1})" ${analysisHistoryPage <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                <button class="page-btn" onclick="goToAnalysisPage(${analysisHistoryPage + 1})" ${analysisHistoryPage >= analysisHistoryTotalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
            `;
        }

        function goToAnalysisPage(page) {
            if (page < 1 || page > analysisHistoryTotalPages) return;
            analysisHistoryPage = page;
            refreshAnalysisHistory();
        }

        function renderAnalysisHistory(items) {
            const listEl = document.getElementById('analysisHistoryList');
            if (!items || items.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">æš‚æ— åˆ†æå†å²</div>';
                return;
            }
            listEl.innerHTML = items.map(it => {
                const t = it.created_at ? formatDateTime(it.created_at) : '-';
                const title = `${it.start_date} ~ ${it.end_date}`;
                return `<div class="chat-history-item" data-id="${it.id}">
                    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
                        <div style="flex:1;min-width:0;">
                            <div class="t">${t}</div>
                            <div class="q">${title}</div>
                        </div>
                        <div style="display:flex;gap:8px;flex-shrink:0;">
                            <button class="btn btn-primary btn-sm" onclick="showAnalysisRecord(${it.id})">æŸ¥çœ‹</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAnalysisRecord(${it.id})">åˆ é™¤</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            window.__analysisHistoryCache = items;
        }

        function showAnalysisRecord(id) {
            const items = window.__analysisHistoryCache || [];
            const it = items.find(x => x.id === id);
            if (!it) return;
            const resultDiv = document.getElementById('aiAnalysisResult');
            resultDiv.innerHTML = renderMarkdown(it.result || '');
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        async function deleteAnalysisRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åˆ†æå†å²å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/admin/ai-analysis/history/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    refreshAnalysisHistory();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        async function startAIAnalysis() {
            const modelId = document.getElementById('analysisModelId').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;

            if (!modelId || !startDate || !endDate) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'warning');
                return;
            }

            const btn = document.getElementById('analysisBtn');
            const resultDiv = document.getElementById('aiAnalysisResult');
            
            btn.disabled = true;
            btn.textContent = 'åˆ†æä¸­...';
            resultDiv.textContent = 'æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...\n\n';
            let raw = '';

            try {
                const response = await fetch('/admin/ai-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: parseInt(modelId),
                        start_time: startDate,
                        end_time: endDate
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'åˆ†æå¤±è´¥');
                }

                // å¤„ç†SSEæµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                resultDiv.textContent = '';
                let sawDone = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        if (line.startsWith('data: ')) {
                            const payload = line.slice(6);
                            // æ–°æ ¼å¼ï¼šJSON å¸§
                            try {
                                const frame = JSON.parse(payload);
                                if (frame.type === 'delta') {
                                    raw += frame.content || '';
                                    resultDiv.textContent += frame.content || '';
                                    resultDiv.scrollTop = resultDiv.scrollHeight;
                                } else if (frame.type === 'done') {
                                    sawDone = true;
                                } else if (frame.type === 'error') {
                                    throw new Error(frame.content || 'åˆ†æå¤±è´¥');
                                }
                            } catch (e) {
                                // å…¼å®¹æ—§æ ¼å¼ï¼ˆçº¯æ–‡æœ¬ï¼‰
                                if (payload.trim() === '[DONE]') { sawDone = true; continue; }
                                raw += payload;
                                resultDiv.textContent += payload;
                                resultDiv.scrollTop = resultDiv.scrollHeight;
                            }
                        } else if (line.startsWith('event: ')) {
                            // å¿½ç•¥äº‹ä»¶ç±»å‹
                            continue;
                        } else if (line.startsWith('id: ')) {
                            // å¿½ç•¥ID
                            continue;
                        } else if (line.trim()) {
                            // å…¶ä»–å†…å®¹ç›´æ¥æ˜¾ç¤º
                            raw += line;
                            resultDiv.textContent += line;
                            resultDiv.scrollTop = resultDiv.scrollHeight;
                        }
                    }
                }

                // å¤„ç†å‰©ä½™çš„buffer
                if (buffer.trim()) {
                    raw += buffer;
                    resultDiv.textContent += buffer;
                }

                if (resultDiv.textContent.trim() === '') {
                    resultDiv.textContent = 'åˆ†æå®Œæˆï¼Œä½†æœªæ”¶åˆ°å†…å®¹ã€‚';
                }

                // DONE åç«‹å³æ¸²æŸ“ Markdownï¼ˆmarkedï¼‰
                if (sawDone || raw.trim()) {
                    resultDiv.innerHTML = renderMarkdown(raw || resultDiv.textContent);
                }
                refreshAnalysisHistory();
            } catch (error) {
                resultDiv.textContent = `åˆ†æå¤±è´¥: ${error.message}`;
                showToast('åˆ†æå¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– å¼€å§‹åˆ†æ';
            }
        }

        // ===== AIèŠå¤©åŠŸèƒ½ =====
        async function loadAIModelsForChat() {
            try {
                const res = await fetch('/admin/ai-models');
                const data = await res.json();
                if (data.success) {
                    allAIModels = data.data || [];
                    const select = document.getElementById('chatModelId');
                    const prev = select.value;
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>' +
                        allAIModels.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                    if (prev) select.value = prev;
                }
            } catch (e) {
                console.error('åŠ è½½AIæ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        function onChatModelChange() {
            chatHistoryPage = 1;
            refreshChatHistory();
            clearChatWindow();
        }

        async function refreshChatHistory() {
            const modelId = document.getElementById('chatModelId').value;
            const listEl = document.getElementById('chatHistoryList');
            if (!modelId) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">è¯·é€‰æ‹©æ¨¡å‹æŸ¥çœ‹å†å²</div>';
                return;
            }
            try {
                const params = new URLSearchParams({ model_id: modelId, page: chatHistoryPage, page_size: 30 });
                const res = await fetch(`/admin/ai-chat/history?${params}`);
                const data = await res.json();
                if (!data.success) {
                    listEl.innerHTML = `<div style="padding:16px;color:var(--danger);text-align:center;">${data.message || 'åŠ è½½å¤±è´¥'}</div>`;
                    return;
                }
                renderChatHistory(data.data.list || []);
            } catch (e) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--danger);text-align:center;">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function deleteChatRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡èŠå¤©è®°å½•å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`/admin/ai-chat/history/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    refreshChatHistory();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function renderChatHistory(items) {
            const listEl = document.getElementById('chatHistoryList');
            if (!items || items.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);text-align:center;">æš‚æ— èŠå¤©è®°å½•</div>';
                return;
            }
            listEl.innerHTML = items.map(it => {
                const t = it.created_at ? formatDateTime(it.created_at) : '-';
                const q = (it.user_text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                return `<div class="chat-history-item" data-id="${it.id}">
                    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
                        <div style="flex:1;min-width:0;cursor:pointer;" onclick="showChatRecord(${it.id})">
                            <div class="t">${t}</div>
                            <div class="q">${q}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteChatRecord(${it.id})">åˆ é™¤</button>
                    </div>
                </div>`;
            }).join('');
            // ç¼“å­˜åˆ° window æ–¹ä¾¿ç‚¹å‡»å±•ç¤º
            window.__chatHistoryCache = items;
        }

        function showChatRecord(id) {
            const items = window.__chatHistoryCache || [];
            const it = items.find(x => x.id === id);
            if (!it) return;
            const msgEl = document.getElementById('chatMessages');
            msgEl.innerHTML = '';
            appendChatBubble('user', it.user_text || '');
            const aiEl = appendChatBubble('ai', '');
            setChatBubbleFormatted(aiEl, it.ai_text || '');
            msgEl.scrollTop = msgEl.scrollHeight;
        }

        function clearChatWindow() {
            const msgEl = document.getElementById('chatMessages');
            msgEl.innerHTML = '<div style="color:var(--text-secondary);">å¼€å§‹ä¸€æ®µæ–°çš„å¯¹è¯å§ã€‚</div>';
            chatCurrentAIEl = null;
        }

        function appendChatBubble(role, text) {
            const msgEl = document.getElementById('chatMessages');
            // æ¸…æ‰æç¤ºå ä½
            if (msgEl.children.length === 1 && msgEl.children[0].tagName === 'DIV' && msgEl.children[0].className === '') {
                // do nothing
            }
            if (msgEl.textContent.includes('è¯·é€‰æ‹©AIæ¨¡å‹') || msgEl.textContent.includes('å¼€å§‹ä¸€æ®µæ–°çš„å¯¹è¯å§ã€‚')) {
                msgEl.innerHTML = '';
            }
            const div = document.createElement('div');
            div.className = `chat-msg ${role}`;
            div.textContent = text || '';
            msgEl.appendChild(div);
            msgEl.scrollTop = msgEl.scrollHeight;
            return div;
        }

        function escapeHtml(s) {
            return (s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Markdown æ¸²æŸ“ï¼ˆmarked + DOMPurifyï¼‰ã€‚ä¾èµ–åŠ è½½å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºçº¯æ–‡æœ¬ã€‚
        function renderMarkdown(text) {
            const src = text || '';
            try {
                if (window.marked && window.DOMPurify) {
                    const html = window.marked.parse(src, { breaks: true, gfm: true });
                    return window.DOMPurify.sanitize(html);
                }
            } catch (e) {}
            // é™çº§ï¼šçº¯æ–‡æœ¬ + æ¢è¡Œ
            return escapeHtml(src).replace(/\n/g, '<br>');
        }

        function setChatBubbleFormatted(el, rawText) {
            if (!el) return;
            el.innerHTML = renderMarkdown(rawText || '');
        }

        async function sendChatMessage() {
            if (chatStreaming) return;
            const modelId = document.getElementById('chatModelId').value;
            const input = document.getElementById('chatInput');
            const text = (input.value || '').trim();
            if (!modelId) { showToast('è¯·å…ˆé€‰æ‹©AIæ¨¡å‹', 'warning'); return; }
            if (!text) { showToast('è¯·è¾“å…¥å†…å®¹', 'warning'); return; }

            const btn = document.getElementById('chatSendBtn');
            btn.disabled = true;
            chatStreaming = true;
            input.disabled = true;

            appendChatBubble('user', text);
            chatCurrentAIEl = appendChatBubble('ai', '');
            input.value = '';
            let aiRaw = '';
            let sawDone = false;

            try {
                const response = await fetch('/admin/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: parseInt(modelId), message: text })
                });

                if (!response.ok) {
                    const errJson = await response.json().catch(() => ({}));
                    throw new Error(errJson.message || `è¯·æ±‚å¤±è´¥(${response.status})`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const payload = line.slice(6);
                        try {
                            const frame = JSON.parse(payload);
                            if (frame.type === 'delta') {
                                const delta = frame.content || '';
                                aiRaw += delta;
                                if (chatCurrentAIEl) chatCurrentAIEl.textContent += delta;
                            } else if (frame.type === 'done') {
                                sawDone = true;
                            } else if (frame.type === 'error') {
                                throw new Error(frame.content || 'èŠå¤©å¤±è´¥');
                            }
                        } catch (e) {
                            // å…¼å®¹æ—§æ ¼å¼
                            if (payload.trim() === '[DONE]') { sawDone = true; continue; }
                            aiRaw += payload;
                            if (chatCurrentAIEl) chatCurrentAIEl.textContent += payload;
                        }
                        const msgEl = document.getElementById('chatMessages');
                        msgEl.scrollTop = msgEl.scrollHeight;
                    }
                }

                // æ”¶åˆ°ç»“æŸæ ‡è®°åç«‹åˆ»æ ¼å¼åŒ–æ•´æ®µå†…å®¹
                if (chatCurrentAIEl) {
                    setChatBubbleFormatted(chatCurrentAIEl, aiRaw || chatCurrentAIEl.textContent);
                }

                // ç»“æŸååˆ·æ–°å†å²
                refreshChatHistory();
            } catch (e) {
                if (chatCurrentAIEl) chatCurrentAIEl.textContent += `\n\nï¼ˆé”™è¯¯ï¼š${e.message}ï¼‰`;
                showToast('å‘é€å¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                chatStreaming = false;
                input.disabled = false;
                input.focus();
            }
        }
    </script>
</body>
</html>
